---
alwaysApply: true
---

# LED System - Product Requirements Document (PRD)

## 📌 버전 정보
- **현재 버전**: v1.2 (개발 중)
- **안정 버전**: v1.1 (2025-01-28 릴리즈)
- **저장소**: https://github.com/qqjfroddl/led-with-ai

## v1.2 개발 계획
- [x] 관리자 페이지 - 기한 만료 탭 추가 (2025-01-30)
- [x] 전월 루틴 자동 복사 기능 추가 (2025-01-30)

---

## 1. 한 줄 요약
사용자는 매일 **할일/루틴/성찰(4항목)**을 기록하고, **주간/월간/연간 리포트**와 **AI 주간/월간/연간 성찰**, **AI 월실천계획 제안**으로 개선합니다. 모든 데이터는 **Supabase(Postgres) 단일 진실원(SSoT)**로 저장되어 PC/모바일에서 동일하게 보입니다.

## 구현 상태 (Implementation Status)
- ✅ **완료**: 
  - 로그인 화면 - 로고 이미지(logo.png) 표시, 구글 로그인 버튼 이미지 하단 오버레이, 짙은 회색 배경/흰색 텍스트 스타일, 반응형 디자인
  - Open Graph 메타 태그 - 카카오톡 링크 미리보기 지원 (og:title, og:description, og:image, og:url, og:type, og:site_name), Twitter Card 메타 태그 포함
  - 날짜 선택 바 (Date Bar) - 이전/다음 날짜 이동, 달력 오버레이, 오늘로 이동 버튼 (오늘 날짜가 아닐 때만 표시), 타임존 정확성 개선 (로컬 날짜 사용)
  - 오늘 할일 (Todos) + Carry-over (미완료 이월) + Enter 키로 수정 저장 + 날짜 이동 기능 + 프로젝트 배지 표시
  - 오늘 루틴 (Routine) - 모닝/나이트 구분, 목표 탭 연동, 진행률 표시, Soft Delete 적용, 토글 기능, 날짜 기준 필터링 (어제 루틴 보존)
  - 오늘 할일 (Todos) - 카테고리 탭, Enter 키로 수정 저장, 토글 기능, 수동 순서 변경 (드래그 앤 드롭: PC 전용, 모바일: 위/아래 화살표 버튼), 프로젝트 배지 표시
  - 하루 성찰 (4항목) - 기본 접힘 상태, "성찰 작성하기" 버튼으로 펼치기, 저장 후 자동 접힘, 4항목 입력/저장 (감사한 일/잘한 일/아쉬운 일/내일의 다짐)
  - 월간 데일리 루틴 (Goals 탭) - 모닝/나이트 각 0~10개 입력, Enter 키 지원, 수정/저장, 토글 기능, 부제목 표시
  - 연간 목표 (Goals 탭) - 연도별 3영역(자기계발/관계/업무재정) 입력/저장/조회/수정, 토글 기능, 부제목 표시, 연도 선택 모달, "올해로" 버튼
  - AI 연간 목표 피드백 (Goals 탭) - Edge Function 연동, SMART 기준에 맞춰 개선 제안, 원본/개선 제안 비교 표시, 영역별 개별 적용 기능, 레이트리밋 월 2회
  - 월간 실천계획 (Goals 탭) - 3컬럼 레이아웃(연간목표 표시/월실천계획 입력/월말 결과 입력), plan_content/results_content JSONB 저장, 토글 기능, 부제목 표시, 월 선택 모달, "이번 달로" 버튼
  - AI 월실천계획 제안 (Goals 탭) - Edge Function 연동, 연간목표 및 최근 활동 분석, 구체적이고 실행 가능한 계획 제안, plan_content JSONB 저장
  - 네비게이션 레이아웃 - **Plan-Do-See 그룹 구조** (계획/실행/리뷰), 그룹별 색상 테마, 반응형 줄바꿈 지원
  - 디자인 시스템 (카테고리 색상, 그라데이션, Lucide 아이콘, 토글 기능, 헤더 레이아웃)
  - 토글 버튼 안정성 개선 (cloneNode 패턴으로 중복 등록 방지, Lucide 렌더링 타이밍 보장)
  - 주간 리포트 (통계 지표 + 주간 분석 + AI 주간 성찰) - 주차 선택, 실천율/완료율/성찰 작성률, 전주 대비 변화, 주간 패턴 분석 (가장 활발한 요일 정확한 완료 수 표시), AI 성찰 생성/조회 (Gemini API, maxOutputTokens: 8000, 마크다운 변환, 스크롤바 지원)
  - 월간 리포트 (통계 지표 + 월간 분석 + AI 월간 성찰) - 월 선택, 실천율/완료율/성찰 작성률, 전월 대비 변화, 월간 패턴 분석 (가장 활발한 요일 정확한 완료 수 표시), AI 성찰 생성/조회 (Gemini API, maxOutputTokens: 8000, 마크다운 변환, 스크롤바 지원, 레이트리밋 월 2회)
  - 연간 리포트 (통계 지표 + 연간 분석 + AI 연간 성찰) - 연도 선택, 실천율/완료율/성찰 작성률, 연간 통계 요약, 월별 통계 요약, AI 성찰 생성/조회 (Gemini API, maxOutputTokens: 8000, 마크다운 변환, 스크롤바 지원, 레이트리밋 연 2회)
  - 관리자 기능 - 사용자 승인/거절/차단, 사용 기한 설정 (개별/일괄), 만료된 사용자 접근 제어, 챌린지 참가자 관리 (추가/제외/통계 확인), 관리자 페이지 배포 설정 (Vite 다중 HTML 빌드, Vercel rewrites 설정), 관리자 통계 조회 RLS 정책 (todos/routines/routine_logs/daily_reflections 테이블에 admin_select_all 정책 추가), 챌린지 참가자 탭 통계 표시 버그 수정 (섹션별 querySelector로 DOM 요소 정확하게 찾기), **기한 만료 탭 추가 (2025-01-30)** - 기한 만료된 사용자 별도 관리, 일괄 기한 연장 기능
  - **프로젝트 관리 (완료)** - 프로젝트 CRUD, 프로젝트 할일 관리, 진행중/완료 탭 분류, 카드 그리드 + 아코디언 UI, 오늘 할일 연동, 양방향 동기화, 마감날짜 관리, 다시 진행하기 기능, 헤더 토글 버튼 제거 (항상 표시)
  - **반복업무 관리 (완료)** - 반복업무 CRUD, 반복 주기 설정(주중 매일/주간/월간), 시작일/종료일 설정, 오늘 할일 일괄 등록, 반복업무 배지 표시, 삭제 시 연결된 할일 동기화, 종료일 없을 때 3개월 후까지 자동 등록, 카드 그리드 UI 레이아웃 (프로젝트와 일관된 디자인), 헤더 토글 버튼 제거 (항상 표시)
  - **배포 및 저장소 관리 (완료)** - GitHub 저장소 이름 변경 (`led-with-ai`), Vercel 자동 배포 설정, Git → GitHub → Vercel 자동 배포 파이프라인 구축, 관리자 페이지(`admin.html`) 배포 문제 해결 (vite.config.js rollupOptions.input 설정, vercel.json rewrites에서 admin.html 제외)
  - **모바일 레이아웃 최적화 (완료)** - 로그인 화면: 로고 크기 조정 (100% 너비), 버튼 크기 축소 및 이미지와 분리, 한 줄 표시 유지 / 헤더: 모바일에서 사용자 이름 숨김, 로그아웃 버튼 크기 축소 / 오늘 할일: 제목 줄바꿈 방지 (`white-space: nowrap`), 카테고리 탭 가로 스크롤 지원 (한 줄 표시) / 순서 조정 버튼: PC는 가로 배치, 모바일은 세로 배치 (반응형) / 네비게이션 메뉴: 계획/실행/리뷰 그룹 균형 조정 (모바일에서 세로 배치, 각 항목이 균등하게 공간 차지), "오늘" 버튼 높이 50%로 조정 및 가운데 정렬 / 루틴 섹션: "나이트루틴" 텍스트 줄바꿈 방지 (`white-space: nowrap`, 폰트 크기 0.9rem) / 주간 리포트: 주간 선택 버튼 텍스트 줄바꿈 방지 (`white-space: nowrap`, 폰트 크기 0.9rem, 간격 조정)
  - **세션 관리 및 로그인 성능 최적화 (완료)** - Supabase 클라이언트 설정: `autoRefreshToken: true`, `persistSession: true`, `detectSessionInUrl: true` 명시적 설정으로 세션 자동 유지 보장 / 인증 함수 안정성 개선: `getSupabase()` 패턴으로 초기화 전 null 에러 방지 / 세션 조회 로직 간소화: 복잡한 localStorage 체크 제거, 단순 `getSession()` 호출로 변경 (초기 로딩 속도 2-3배 향상) / 타임아웃 최적화: `getCurrentProfile` 타임아웃 5초 → 3초, 재시도 대기 500ms → 300ms / 토큰 갱신 시 페이지 재렌더링 방지: `TOKEN_REFRESHED` 이벤트에서 `router.handleRoute()` 호출 제거하여 입력 중인 내용 보존 / **탭 전환 시 불필요한 새로고침 방지**: Router에 상태 기반 렌더링 스킵 로직 추가 (해시 + 프로필 ID + 프로필 상태가 동일하면 렌더링 스킵), 동시 실행 방지 플래그(`isHandlingRoute`) 및 중복 해시 변경 방지로 입력 중인 내용 보존 보장
  - **전월 루틴 자동 복사 (완료, 2025-01-30)** - 월간 데일리 루틴 보기 모드에 "전월 루틴 복사" 버튼 추가 / 전월 루틴 조회 함수 (`fetchPreviousMonthRoutines`) / 전월 루틴 복사 함수 (`copyPreviousMonthRoutines`) / 버튼 항상 표시 (개발 모드) / 전월 루틴 없으면 알림, 있으면 복사 확인 메시지 / 이번 달 루틴 있으면 덮어쓰기 확인 / 복사 시 오늘 날짜 기준 `active_from_date` 설정 / 과거 기록 보존 (Soft Delete) / 월별 루틴 히스토리 자동 관리 / btn-secondary 스타일 적용 (기존 디자인과 조화)
- 🚧 **부분**: 
  - (없음)

---

## 2. 목표 / 비목표
### 2.1 목표(Goals)
- G1. 오늘 관리(할일/루틴/성찰)를 빠르게 기록/완료
- G2. 주간/월간/연간 리포트로 실행 지표를 제공
- G3. AI로 “주간/월간/연간 성찰” 및 “월실천계획 초안”을 생성하고 **DB에 저장**하여 기기 간 동일 조회
- G4. 승인 기반(RLS 강제)으로 서비스 이용을 통제하고 사용자 데이터 완전 격리

### 2.2 비목표(Out of Scope) — v1.1 제외
- Electron 패키징
- Push 알림(Web Push)
- 협업/공유
- 완전 오프라인(캐시/큐잉은 v1.2+)

---

## 📜 변경 이력 (Changelog)

### v1.1 (2025-01-28) ✅
**안정 버전 릴리즈 - 핵심 기능 구현 완료**

#### 인증 및 세션 관리
- ✅ 로그인 화면 (로고 이미지, 구글 로그인 버튼, 반응형 디자인)
- ✅ 세션 관리 및 로그인 성능 최적화 (초기 로딩 속도 2-3배 향상)
- ✅ 토큰 갱신 시 페이지 재렌더링 방지
- ✅ 탭 전환 시 불필요한 새로고침 방지 (상태 기반 렌더링 스킵)

#### 오늘 관리 (Do)
- ✅ 날짜 선택 바 (이전/다음 날짜 이동, 달력 오버레이, 오늘로 이동 버튼)
- ✅ 오늘 할일 (카테고리 탭, Enter 키 수정 저장, 수동 순서 변경, 날짜 이동 기능)
- ✅ 오늘 루틴 (모닝/나이트 구분, 진행률 표시, 날짜 기준 필터링)
- ✅ 하루 성찰 (4항목, 기본 접힘 상태, 저장 후 자동 접힘)
- ✅ Carry-over 모달 (미완료 이월, 포기 처리)

#### 계획 관리 (Plan)
- ✅ 월간 데일리 루틴 (모닝/나이트 0~10개 입력)
- ✅ 연간 목표 (3영역, 연도 선택 모달, AI 피드백)
- ✅ 월간 실천계획 (3컬럼 레이아웃, AI 제안)
- ✅ 프로젝트 관리 (진행중/완료 탭, 양방향 동기화)
- ✅ 반복업무 관리 (반복 주기 설정, 오늘 할일 일괄 등록)

#### 리뷰 (See)
- ✅ 주간 리포트 (통계 지표, 주간 분석, AI 주간 성찰)
- ✅ 월간 리포트 (통계 지표, 월간 분석, AI 월간 성찰)
- ✅ 연간 리포트 (통계 지표, 연간 분석, AI 연간 성찰)

#### 관리자 기능
- ✅ 사용자 승인/거절/차단
- ✅ 사용 기한 설정 (개별/일괄)
- ✅ 챌린지 참가자 관리
- ✅ 관리자 통계 조회 RLS 정책

#### 디자인 시스템
- ✅ Plan-Do-See 네비게이션 구조
- ✅ 카테고리 색상 시스템
- ✅ 프리미엄 색상 팔레트 업데이트
- ✅ 레이어드 섀도우 시스템
- ✅ 토글 기능 (모든 섹션)
- ✅ 모바일 레이아웃 최적화

#### 배포
- ✅ GitHub 저장소 (`led-with-ai`)
- ✅ Vercel 자동 배포 파이프라인
- ✅ 관리자 페이지 배포 설정

---

### v1.2.1 (2025-02-01) 🎯
**프로젝트 할일 UX 개선**

#### UX 개선
- ✅ **프로젝트 이름 표시 (2025-02-01)**
  - 문제: 오늘 탭의 프로젝트 할일 배지에 프로젝트 이름이 표시되지 않아 어떤 프로젝트인지 알기 어려움
  - 해결: 배지에 프로젝트 이름 표시 ("프로젝트: 프로젝트명" 형식)
  - 구현:
    - todos 조회 시 `project_tasks`와 `projects`를 JOIN하여 프로젝트 이름 조회
    - 오늘 할일 목록: 배지에 프로젝트 이름 표시
    - 이월 모달: 배지에 프로젝트 이름 표시
    - 프로젝트 삭제 시: "프로젝트"만 표시 (안전한 폴백)
  - 효과:
    - 사용자가 할일이 어떤 프로젝트와 연결되어 있는지 즉시 확인 가능
    - 프로젝트-할일 동기화 기능에 영향 없이 UX만 개선 (안전한 수정)

---

### v1.2.2 (2025-02-02) 🎯
**프로젝트 할일 시작일/종료일 기능 추가**

#### 프로젝트 할일 일정 관리
- ✅ **시작일/종료일 설정 (2025-02-02)**
  - 문제: 프로젝트 할일에 기간을 설정하고 자동으로 오늘 할일에 등록하는 기능이 필요
  - 해결: 시작일/종료일 설정 및 일괄 등록 기능 구현
  - 구현:
    - **DB 스키마 수정**: `project_tasks` 테이블에 `start_date`, `end_date` 컬럼 추가
    - **날짜 범위 선택**: 캘린더 아이콘 버튼으로 flatpickr 모달 열기, 시작일/종료일 선택
    - **일괄 등록**: "오늘 할일 등록하기" 버튼으로 시작일~종료일 범위의 모든 날짜에 할일 자동 생성
    - **중복 방지**: 이미 등록된 날짜는 스킵 (bulk query로 성능 최적화)
    - **하위 호환성**: 기존 `due_date` 방식도 계속 지원 (구 버전 데이터 보존)
  - 효과:
    - 프로젝트 할일을 여러 날짜에 걸쳐 자동으로 등록 가능
    - 반복업무와 유사한 UX로 일관성 향상
    - N+1 쿼리 문제 해결로 성능 최적화

#### 양방향 동기화 강화
- ✅ **프로젝트 할일 ↔ 오늘 할일 동기화 (2025-02-02)**
  - 문제: 프로젝트 할일 완료 시 연결된 오늘 할일이 자동으로 완료되지 않음
  - 해결: 양방향 동기화 완전 구현
  - 구현:
    - **프로젝트 → 오늘**: 프로젝트 할일 완료 시 연결된 모든 활성 todos도 자동 완료
    - **오늘 → 프로젝트**: 모든 연결된 todos 완료 시 프로젝트 할일도 자동 완료
    - **무한 루프 방지**: `syncingTodo`, `syncingProjectTask` 플래그로 동시 실행 제어
    - **이월/포기 필터링**: `carried_over_at`, `skipped_at`이 기록된 원본 할일은 동기화 체크에서 제외
  - 효과:
    - 프로젝트 할일과 오늘 할일의 완료 상태가 자동으로 일치
    - 사용자가 수동으로 양쪽을 모두 체크할 필요 없음
    - 데이터 일관성 보장

#### 이월/날짜 이동 시 자동 날짜 연장
- ✅ **end_date 자동 연장 (2025-02-02)**
  - 문제: 할일 이월/날짜 이동 시 프로젝트 할일의 end_date가 업데이트되지 않음
  - 해결: 이월/날짜 이동 시 프로젝트 할일의 end_date를 자동으로 최신 날짜로 연장
  - 구현:
    - **이월 시**: `carryOverTodo`에서 오늘 날짜로 `end_date` (또는 `due_date`) 연장
    - **날짜 이동 시**: `moveTodoDate`에서 새 날짜로 `end_date` (또는 `due_date`) 동기화
    - **하위 호환성**: `start_date/end_date` 방식(신)과 `due_date` 방식(구) 모두 지원
  - 효과:
    - 프로젝트 할일의 일정이 실제 작업 진행 상황과 자동으로 일치
    - 사용자가 수동으로 프로젝트 일정을 수정할 필요 없음

#### 중복 방지 로직 강화
- ✅ **이월 시 중복 체크 개선 (2025-02-02)**
  - 문제: 프로젝트/반복업무 할일 이월 시 중복 체크가 불완전
  - 해결: `carried_over_at`, `skipped_at` 조건 추가하여 정확한 중복 체크
  - 구현:
    - `carryOverTodo`에서 `existingTodo` 조회 시 이월/포기된 원본 할일 제외
    - 조건: `is('deleted_at', null)`, `is('carried_over_at', null)`, `is('skipped_at', null)`
  - 효과:
    - 시작일~종료일로 미리 등록된 프로젝트 할일의 경우, 이월 시 중복 생성되지 않음
    - "이미 등록됨" 메시지 정확하게 표시
    - 반복업무와 동일한 중복 방지 로직 적용

#### 이월/포기 배지 표시 수정
- ✅ **과거 날짜 필터링 제거 (2025-02-02)**
  - 문제: 과거 날짜 조회 시 이월/포기한 할일이 표시되지 않아 히스토리 추적 불가
  - 원인: `fetchTodos` 함수의 628번째 줄에서 `carried_over_at`/`skipped_at`이 있는 할일을 완전히 제외
  - 해결: 과거 날짜 필터링 로직 제거하여 배지와 함께 표시
  - 구현:
    - `src/pages/today.js:623-630` 필터링 로직 제거
    - 렌더링 시 `isProcessed` 플래그로 시각적 구분 (이미 구현됨)
    - 중복 방지는 이월/프로젝트 등록 시 별도 체크 로직으로 처리 (영향 없음)
  - 효과:
    - **포기한 할일**: 어제 날짜에 "× 포기함" 빨간 배지 + 회색 배경 + 읽기 전용으로 표시
    - **이월한 할일**: 어제 날짜에 "→ 오늘로 이동됨" 녹색 배지 + 회색 배경 + 읽기 전용으로 표시
    - **히스토리 추적**: 과거 날짜에서 어떤 할일을 포기했는지/이월했는지 확인 가능
    - **중복 방지 유지**: 프로젝트/반복업무 이월 시 오늘 날짜에 중복 생성 방지 (날짜 분리로 충돌 없음)
  - 검증:
    - 이월 모달: `.is('carried_over_at', null)` 조건으로 아직 처리 안 된 할일만 표시 ✅
    - 중복 체크: `.eq('date', today)` 조건으로 오늘 날짜만 체크하므로 과거 날짜와 충돌 없음 ✅
    - 날짜 분리: `date` 컬럼이 다르므로 어제/오늘 할일이 자연스럽게 분리됨 ✅

---

### v1.2.3 (2025-02-02) 🎯
**모바일 UX 개선**

#### 월간 실천계획 모바일 레이아웃 최적화
- ✅ **3컬럼 → 세로 배치 (2025-02-02)**
  - 문제: 모바일에서 월간 실천계획의 3컬럼 레이아웃(연간목표/월실천계획/월말 결과)이 좁은 화면에 억지로 들어가면서 가독성 저하
  - 해결: 모바일에서 세로 배치로 변경하여 가독성 대폭 향상
  - 구현:
    - **CSS 미디어 쿼리 추가** (`src/styles/main.css`):
      - `@media (max-width: 768px)` 조건으로 모바일 전용 스타일 적용
      - `grid-template-columns: 1fr` (3컬럼 → 1컬럼)
      - 구분선 변경: 우측 구분선(`border-right`) → 하단 구분선(`border-bottom`)
      - 마지막 섹션 하단 보더 제거 (`:last-child`)
      - 제목 크기 조정 (1.1rem → 1rem)
      - 텍스트 영역 최소 높이 조정 (100px)
    - **보기 모드와 편집 모드 모두 적용**
    - **패딩 조정**: `padding-right` → `padding-bottom`
  - 효과:
    - 각 섹션이 전체 너비를 사용하여 텍스트 가독성 대폭 향상
    - 긴 문장이 자연스럽게 표시됨
    - 위에서 아래로 순서대로 읽으면 되어 직관적
    - PC 레이아웃은 그대로 유지 (3컬럼 비교 가능)

- ✅ **월간 실천계획 헤더 2줄 레이아웃 (2025-02-02)**
  - 문제: 모바일에서 월 선택 컨트롤(이전/다음 버튼, 월 레이블, "이번 달로" 버튼)이 한 줄에 배치되어 다음 달 화살표가 화면 밖으로 벗어남
  - 해결: 모바일에서 2줄 레이아웃으로 변경하여 모든 요소가 화면 안에 들어오도록 개선
  - 구현:
    - **헤더 구조 변경** (`src/styles/main.css`):
      - 1줄: 제목 + 토글 버튼
      - 2줄: 이전/다음 버튼 + 월 레이블 + "이번 달로" 버튼 (가운데 정렬)
      - `flex-direction: column` 적용
      - 월 선택 컨트롤을 별도 줄로 배치하고 가운데 정렬
    - **크기 조정**:
      - 월 레이블: `font-size: 0.95rem`, `min-width: 90px`
      - "이번 달로" 버튼: `font-size: 0.85rem`, `padding: 0.35rem 0.75rem`
  - 효과:
    - 모든 버튼이 화면 안에 완전히 들어옴
    - 가운데 정렬로 균형잡힌 레이아웃
    - 버튼 크기 유지로 터치하기 편함
    - PC는 기존 1줄 레이아웃 유지

---

### v1.2 (개발 중)
**관리자 기능 개선 및 사용자 편의성 향상**

#### 관리자 페이지 개선
- ✅ **기한 만료 탭 추가 (2025-01-30)**
  - 문제: 기한 만료된 사용자를 별도로 관리하기 어려움
  - 해결: "기한 만료" 탭 추가하여 `expires_at < current_date` 사용자 자동 필터링
  - 구현:
    - 네 번째 탭으로 "기한 만료 (N명)" 추가 (빨간색 테마)
    - 통계 카드: 기한 만료 사용자 수 표시
    - 개별 기한 연장: 각 행의 "기한 연장" 버튼
    - 일괄 기한 연장: 여러 사용자 선택 후 일괄 처리 (무제한 또는 특정 날짜)
    - 전체 선택/해제 체크박스 지원
  - 효과: 기한 만료 사용자를 쉽게 찾아 기한 연장 가능

#### 월간 데일리 루틴 개선
- ✅ **전월 루틴 자동 복사 기능 (2025-01-30)**
  - 문제: 매월 초에 루틴을 수동으로 재입력해야 하는 불편함
  - 해결: "전월 루틴 복사" 버튼으로 전월 루틴을 현재 월에 자동 복사
  - 구현:
    - 월간 데일리 루틴 보기 모드에 "전월 루틴 복사" 버튼 추가 (수정하기 버튼 왼쪽)
    - `fetchPreviousMonthRoutines()`: 전월 루틴 조회 함수
    - `copyPreviousMonthRoutines()`: 전월 루틴 복사 함수
      - 전월 루틴 없으면 알림 표시
      - 전월 루틴 있으면 복사 확인 메시지 (전월/현재월 이름, 루틴 개수 표시)
      - 이번 달 루틴 있으면 덮어쓰기 확인 메시지
      - 복사 시 `monthly_plans` 테이블에 저장 (기존 `content_md`, `linked_year` 유지)
      - `syncMonthlyRoutines()` 호출하여 `routines` 테이블 동기화
      - 오늘 날짜 기준 `active_from_date` 설정 (오늘부터 적용)
      - 과거 루틴은 Soft Delete로 보존 (히스토리 관리)
    - `updateCopyButtonVisibility()`: 버튼 표시/숨김 제어 (개발 모드: 항상 표시)
    - 버튼 스타일: btn-secondary (기존 디자인과 조화)
    - 아이콘: `copy` (Lucide)
  - 효과: 
    - 매월 루틴 재입력 불필요, 전월 루틴 자동 복사로 편의성 향상
    - 월별 루틴 히스토리 자동 관리 (어느 달에 어떤 루틴이 있었는지 추적 가능)
    - 과거 루틴 체크 기록 보존 (Soft Delete)
  - 주의사항:
    - `isRoutineDue()` 함수가 `schedule.month`로 월별 루틴을 엄격히 구분하므로 충돌 없음
    - `active_from_date`와 `deleted_at`로 월 중 루틴 변경 이력 정확히 추적
    - 복사된 루틴은 오늘부터 적용되며, 과거 날짜의 루틴은 변경되지 않음

#### AI 월실천계획 제안 개선
- ✅ **가독성 개선 (2025-12-31)**
  - 문제: 연간목표와 월실천계획에서 목표들이 붙어있어 가독성이 떨어짐
  - 해결: 목표 사이에 빈 줄 추가하여 가독성 향상
  - 구현:
    - **월실천계획 AI 프롬프트 v8** (Edge Function):
      - 출력 형식 개선: 각 목표 사이에 `\n\n` 추가
      - 화살표(→) 앞에 줄바꿈 추가하여 목표와 행동 시각적 분리
      - 형식: `1. [목표]\n→ [행동]\n\n2. [목표]\n→ [행동]`
      - 프롬프트 버전: `monthly_plan_v8`
    - **연간목표 표시 개선** (프론트엔드):
      - `formatYearlyGoalText()` 함수 추가: `\n(\d+\.)` → `\n\n$1` 변환
      - 월간 실천계획 섹션의 연간목표 컬럼에 적용 (보기 모드 + 편집 모드)
      - 파일: `src/pages/goals.js`
  - 효과:
    - 목표들이 시각적으로 명확히 구분되어 가독성 대폭 향상
    - 긴 목표 텍스트도 읽기 편해짐
    - 사용자 경험 개선

#### 버그 수정
- ✅ **날짜 선택 시 페이지 재렌더링 버그 수정**
  - 문제: 날짜 변경 시 오늘 날짜 데이터만 계속 표시되는 현상
  - 원인: 라우터 상태 체크에서 selectedDate 미포함, currentHash 비교 오류
  - 해결: `currentState`에 selectedDate 추가, `rerender()` 시 `lastRenderedState = null`, `hashPath` 변수로 정확한 경로 비교
  - 구현: `src/router.js`의 `handleRoute` 함수에서 라우터 상태 관리 개선

#### 리포트 개선
- ✅ **주간/월간/연간 실행률 기준 개선**
  - **현재 주**: 월요일 ~ 오늘까지를 기준으로 실행률 계산 (과거 주는 전체 주 기준)
  - **현재 달**: 1일 ~ 오늘까지를 기준으로 실행률 계산 (과거 달은 전체 달 기준)
  - **현재 연도**: 1월 1일 ~ 오늘까지를 기준으로 실행률 계산 (과거 연도는 전체 연도 기준)
  - 효과: 초반 기간(주/달/연도 시작 직후)에 실행률이 비정상적으로 낮게 표시되는 문제 해결
  - 구현:
    - 주간: `src/utils/weeklyStats.js`의 `getWeeklyStats` 함수에서 `effectiveEndDate` 계산
    - 월간: `src/utils/monthlyStats.js`의 `getMonthlyStats` 함수에서 `effectiveEndDate` 계산
    - 연간: `src/utils/yearlyStats.js`의 `getYearlyStats` 함수에서 `effectiveEndDate` 계산

#### AI 기능 개선
- ✅ **AI 레이트리밋 제한 제거 (2025-01-30)**
  - 문제: AI 기능 사용 시 주/월/연 2회 제한으로 인한 불편함
  - 해결: 모든 AI 기능의 레이트리밋 제한 제거 (언제든지 사용 가능)
  - 구현:
    - Edge Function에서 레이트리밋 체크 로직 제거 (429 에러 반환 제거)
    - 사용량 카운터는 계속 증가하여 통계 추적 유지 (`ai_usage_counters` 테이블)
    - 프론트엔드에서 레이트리밋 관련 팝업 메시지 제거
    - 적용 기능: 주간/월간/연간 AI 성찰, AI 연간 목표 피드백, AI 월실천계획 제안
  - 효과: 사용자가 언제든지 AI 피드백을 받을 수 있어 사용성 향상
  - 주의: 사용량은 계속 추적되므로 관리자가 통계 확인 가능

---

## 3. 제품 원칙(Product Principles)
1) **SSoT**: 영속 데이터는 Supabase만. localStorage는 “UI 상태/일회성 노출 플래그”만.  
2) **승인 전 보안(RLS 강제)**: pending/rejected/blocked는 CRUD/리포트/AI 접근 불가.  
3) **Online-first**: v1은 온라인 우선(오프라인 불가/제한).  
4) **타임존 일관성**: 기준 타임존은 `profiles.timezone` (기본 Asia/Seoul).  
5) **AI 비밀키 클라이언트 금지**: AI 호출은 Edge Function만.

---

## 4. 고정 정의(날짜/기간/타임존)
- 타임존: `profiles.timezone` (기본 `Asia/Seoul`)
- 오늘(today): 사용자 타임존 기준 `YYYY-MM-DD`
- 이번 주(week): **월요일 00:00 ~ 일요일 23:59** (고정)
  - `week_start`: 해당 주 월요일 날짜(date)
  - `week_end`: `week_start + 6일`
- 이번 달(month): 해당 월 1일 ~ 말일
  - `month_start`: `YYYY-MM-01`(date)

> 구현 규칙(필수):  
> - “화면 기준 날짜 키”는 **date 컬럼**으로 저장(로컬 타임존 변환 혼선 방지)  
> - 생성/수정 시각은 `timestamptz`(created_at/updated_at)로 저장

---

## 5. 사용자/권한
### 5.1 역할(Role)
- User: 기록/조회/리포트/AI 결과 확인
- Admin: 사용자 승인/거절/차단, 관리자 페이지만 접근

### 5.2 사용자 상태(State)
- `pending` / `approved` / `rejected` / `blocked`

### 5.3 접근 제어(필수)
- pending/rejected/blocked:  
  - 로그인 가능  
  - 단, **todos/routines/logs/reflections/goals/plans/reports/ai 결과** 접근 불가(RLS)  
  - profiles는 “본인 1행 SELECT”만 허용(상태 확인)

---

## 6. 정보구조(IA) / 라우팅
### 6.1 화면(공통: PC/모바일 반응형)
- **계획 (Plan)**
  - `/index.html#/goals` 목표(연간목표/월계획 + AI 월계획 + AI 연간 목표 피드백)
  - `/index.html#/projects` 프로젝트(프로젝트 관리/할일 등록/오늘 할일 연동) ✅ 구현 완료
  - `/index.html#/recurring` 반복업무(반복되는 할일 설정 및 오늘 할일 등록) ✅ 구현 완료
- **실행 (Do)**
  - `/index.html#/today` 오늘(할일/루틴/성찰)
- **리뷰 (See)**
  - `/index.html#/weekly` 주간 리포트(통계 + AI 성찰)
  - `/index.html#/monthly` 월간 리포트(통계 + AI 성찰) ✅ 구현 완료
  - `/index.html#/yearly` 연간 리포트(통계 + AI 성찰) ✅ 구현 완료
- **관리**
  - `/admin.html` 관리자(승인/상태변경) — Admin만
- **참고**: `/reports`는 `/weekly`로 자동 리다이렉트 (하위 호환성)

### 6.2 승인 상태별 UX
- `pending`: "승인 대기" 고정 화면 + 로그아웃 버튼
- `rejected/blocked`: "이용 불가" 화면 + 문의 안내 + 로그아웃
- `approved` + 만료됨: "사용 기한 만료" 화면 + 만료일 표시 + 로그아웃 버튼

---

## 7. 핵심 유저 플로우
### 7.1 가입/승인
1) Google 로그인(Supabase Auth) - 로고 이미지와 구글 로그인 버튼이 오버레이된 디자인 ✅ 구현 완료
2) DB 트리거로 `profiles` 자동 생성(`status=pending`)  
3) pending 화면 고정  
4) Admin이 승인(`approved`)  
5) 사용자는 재접속/새로고침 시 즉시 정상 이용

### 7.2 오늘 관리
- **날짜 선택 바** (구현됨): 오늘 탭에서만 표시, 이전/다음 날짜 이동, 날짜 표시 버튼 클릭 시 달력 오버레이, **오늘로 이동 버튼** (오늘 날짜가 아닐 때만 표시)
- **오늘 루틴** (최상단): 모닝/나이트 구분, 체크(일자 로그), 진행률 표시, 접기/펼치기 토글
- **오늘 할일** (하단): 추가/완료 토글/삭제 + 카테고리 탭(헤더 오른쪽), Enter 키로 수정 저장, 접기/펼치기 토글
- 성찰: 4항목 작성/저장(토글 UI) - 미구현

### 7.3 리포트/AI
- **주간 리포트** (구현됨): 주간 지표(루틴 실천율, 할일 완료율, 성찰 작성률), 주간 분석(실천율 요약, 전주 대비 변화, 주간 패턴 분석), AI 주간 성찰 생성/조회
- **AI 주간 성찰** (구현됨): Gemini API 연동, Edge Function 배포, 마크다운 변환, 스크롤바 지원, 재생성 기능
- **월간 리포트** (구현됨): 월간 지표(루틴 실천율, 할일 완료율, 성찰 작성률), 월간 분석(실천율 요약, 전월 대비 변화, 월간 패턴 분석), AI 월간 성찰 생성/조회
- **AI 월간 성찰** (구현됨): Gemini API 연동, Edge Function 배포, 마크다운 변환, 스크롤바 지원, 재생성 기능, 레이트리밋 월 2회
- **연간 리포트** (구현됨): 연간 지표(루틴 실천율, 할일 완료율, 성찰 작성률), 연간 통계 요약, 월별 통계 요약, AI 연간 성찰 생성/조회
- **AI 연간 성찰** (구현됨): Gemini API 연동, Edge Function 배포, 마크다운 변환, 스크롤바 지원, 재생성 기능, 레이트리밋 연 2회

### 7.4 목표/월계획/AI 제안
- **월간 데일리 루틴** (구현됨): 모닝/나이트 각 0~10개 입력, 저장 시 오늘 루틴에 자동 반영
- **연간목표 저장** (구현됨): 연도별 1건, 3영역(자기계발/관계/업무재정) 입력/저장/조회/수정
- **월실천계획 저장** (구현됨): 월별 3컬럼 레이아웃(연간목표 표시/월실천계획 입력/월말 결과 입력), plan_content/results_content JSONB 저장
- AI 월실천계획 제안 생성 → 편집 → 채택(accepted) - 미구현

---

# 8. 기능 요구사항(FR) + 수용 기준(AC)

## A. 인증/세션/승인
### FR-A
- FR-A1. Google OAuth는 Supabase Auth만 사용
- FR-A2. 세션 유지(새로고침/재접속 자동 복구) ✅ 구현 완료
  - Supabase 클라이언트 설정: `autoRefreshToken: true`, `persistSession: true`, `detectSessionInUrl: true`
  - 자동 토큰 갱신: 1시간마다 백그라운드에서 자동 갱신, 페이지 재렌더링 없음
  - 세션 조회 최적화: 복잡한 localStorage 체크 제거, 단순 `getSession()` 호출
  - 로그인 속도 개선: 초기 로딩 시간 2-3초 → 0.5-1초 (3배 향상)
- FR-A3. 로그아웃
- FR-A4. 승인 상태 기반 라우팅 가드(클라이언트) + RLS(서버) 동시 적용

### AC-A
- AC-A1. PC 로그인 후 모바일 로그인 시 **동일 데이터** 조회 ✅
- AC-A2. pending/rejected/blocked는 개발자도구/API 호출로도 CRUD/리포트/AI 접근 불가(RLS) ✅
- AC-A3. Admin 승인 후 새로고침 시 즉시 사용 가능 ✅
- AC-A4. **세션 자동 유지**: 새로고침/재접속 시 로그인 상태 유지 ✅
- AC-A5. **토큰 갱신 시 입력 내용 보존**: `TOKEN_REFRESHED` 이벤트에서 페이지 재렌더링 방지 ✅
- AC-A6. **로그인 속도**: 초기 로딩 시간 0.5-1초 이내 ✅
- AC-A7. **탭 전환 시 입력 내용 보존**: 브라우저 탭 전환 후 돌아와도 동일한 상태(해시 + 프로필 + 선택된 날짜)면 렌더링 스킵하여 입력 중인 내용 유지 ✅

---

## B-0. 날짜 선택 바 (Date Bar) ✅ 구현 완료
### 구조 (구현됨)
- **위치**: 오늘 탭에서만 표시 (네비게이션 바 아래)
- **레이아웃**: 이전 날짜 버튼 | 날짜 표시 버튼 | 다음 날짜 버튼
- **날짜 표시**: "YYYY년 M월 D일 (요일)" 형식
- **오늘로 이동 버튼**: 날짜 바 아래에 별도 버튼으로 표시

### FR-B0 (구현됨)
- FR-B0-1. 이전/다음 날짜 이동 버튼 (chevron-left/chevron-right 아이콘)
- FR-B0-2. 날짜 표시 버튼 클릭 시 달력 오버레이 표시 (flatpickr 사용)
- FR-B0-3. **오늘로 이동 버튼**: 오늘 날짜가 아닐 때만 표시 (`display: none` → `display: inline-flex`)
  - 위치: 날짜 바 아래 (date-bar-footer)
  - 아이콘: `sun` (Lucide)
  - 텍스트: "오늘로 이동"
  - 클릭 시: `resetSelectedDate(timezone)` 호출하여 오늘 날짜로 선택 날짜 리셋
- FR-B0-4. 선택 날짜는 localStorage에 저장 (`app_selected_date` 키)
- FR-B0-5. 날짜 변경 시 페이지 자동 리렌더링 (루틴/할일/성찰 재조회)
  - **라우터 상태 관리**: selectedDate를 라우터 상태에 포함하여 날짜 변경 감지 (`currentState = ${hash}:${profileId}:${status}:${selectedDate}`)
  - **강제 재렌더링**: 날짜 변경 시 `lastRenderedState = null` 초기화로 스킵 방지
  - **currentFilter 초기화**: 페이지 진입 시 'today'로 리셋 (다른 탭에서 돌아올 때 필터 상태 보존 문제 방지)
  - **해시 경로 정확성**: `currentHash.slice(1)` 또는 '/today'로 해시 비교 (# 제거)
- FR-B0-6. **타임존 정확성**: flatpickr 날짜 선택 시 로컬 날짜 사용 (UTC 변환 방지)
  - `toISOString()` 대신 `getFullYear()/getMonth()/getDate()` 사용
  - 한국(UTC+9)에서 자정 이전 날짜 선택 시 하루 전으로 이동하는 버그 수정

### AC-B0 (검증됨)
- AC-B0-1. 오늘 날짜일 때 "오늘로 이동" 버튼 숨김 ✅
- AC-B0-2. 다른 날짜 선택 시 "오늘로 이동" 버튼 표시 ✅
- AC-B0-3. "오늘로 이동" 버튼 클릭 시 오늘 날짜로 즉시 이동 ✅
- AC-B0-4. 날짜 변경 시 해당 날짜의 루틴/할일/성찰 정상 조회 ✅
- AC-B0-5. 선택 날짜가 localStorage에 저장되어 새로고침 후에도 유지 ✅
- AC-B0-6. **타임존 정확성**: 날짜 선택 시 정확한 날짜로 이동 (UTC 변환 버그 수정) ✅
- AC-B0-7. **날짜 변경 시 즉시 반영**: 이전/다음 버튼, 달력 선택, 오늘로 이동 버튼 모두 즉시 해당 날짜 데이터 표시 ✅
- AC-B0-8. **다른 탭 이동 후 복귀**: 다른 탭(목표/프로젝트)에서 오늘 탭으로 돌아올 때 선택된 날짜 유지 및 정상 표시 ✅
- AC-B0-9. **라우터 상태 동기화**: 브라우저 탭 전환, 포커스 변경 등의 이벤트 후에도 선택된 날짜 정확히 반영 ✅

---

## B. 오늘 — 할일(Todo) ✅ 구현 완료
### B-0 카테고리(고정)
- UI 라벨: `Work / Job / Growth / Personal`
- DB 값(enum-like text): `work | job | self_dev | personal`
- **변경**: "자기계발" → "Growth" (2025-12-07)
- **위치**: 헤더 오른쪽에 배치 (진행률 배지와 유사한 위치)
- **크기**: `padding: 0.5rem 1rem`, `font-size: 0.95rem` (진행률 배지와 동일)

### FR-B
- FR-B1. 할일 생성 필드
  - 필수: `title`, `date(기본 오늘)`, `category(기본 work)`
  - 선택: `memo`, `due_date`, `priority(1~3)`, `pinned(boolean, 기본 false)`
- FR-B2. 완료/미완료 토글(`is_done`, `done_at`)
- FR-B3. 삭제는 soft delete(`deleted_at`)
- FR-B4. 필터: 오늘/미래/지난(기준: `date`)
- FR-B5. 정렬 규칙(필수, 조회 ORDER까지 고정)
  - 1차: `category` (UI 탭/섹션 기준)
  - 2차: `is_done ASC` (미완료 먼저)
  - 3차: `display_order ASC NULLS LAST` (수동 순서, 같은 완료 상태 내에서만 적용)
  - 4차: `pinned DESC` (핀 우선)
  - 5차: `due_date ASC NULLS LAST`
  - 6차: `priority DESC NULLS LAST`
  - 7차: `created_at ASC` (결정적 안정성)
- FR-B6. 카테고리 탭은 “단일 선택”
- FR-B7. 탭 선택 시 placeholder 즉시 변경
  - work: “복잡하고 어려운 일을 입력하세요...”
  - job: “간단한 할일을 입력하세요...”
  - self_dev: “성장과 관련된 내용을 입력하세요...”
  - personal: “개인적인 삶을 입력하세요...”
- FR-B8. “+추가”/Enter로 저장
  - 입력 trim 후 공백만이면 저장 금지 + 안내(토스트/문구)
  - 성공 시 입력 초기화(포커스 유지 권장)
- FR-B9. 동일 화면에서 추가/완료/삭제 즉시 반영(optimistic UI 가능하나 실패 시 롤백)
- FR-B10. **수정 시 Enter 키로 저장**: 수정 모드에서 Enter 키 누르면 즉시 저장, Escape 키로 취소
- FR-B11. **카테고리 탭 위치**: 헤더 오른쪽에 배치 (진행률 배지처럼)
  - **모바일 최적화**: 가로 스크롤 지원 (`overflow-x: auto`, `flex-wrap: nowrap`), 모든 탭이 한 줄에 표시되도록 최적화
- FR-B12. **토글 기능**: 헤더 제목 옆 토글 버튼으로 내용 접기/펼치기 (기본값: 펼침, 상태 localStorage 저장)
  - **모바일 최적화**: 제목 줄바꿈 방지 (`white-space: nowrap`), 모바일에서 폰트 크기 조정 (1.25rem)
- FR-B13. **수동 순서 변경**: 미완료 항목에만 위/아래 화살표 버튼 표시, 같은 카테고리 내 미완료 항목끼리만 순서 변경 가능
  - 완료된 항목은 순서 변경 불가 (항상 아래에 표시)
  - `display_order` 컬럼으로 순서 저장 (NULL 허용)
  - RLS 정책 준수를 위해 개별 `update` 사용 (upsert 사용 안 함)
  - **카테고리 필터링**: `todo.category`를 사용하여 해당 할일의 실제 카테고리 내에서만 순서 변경 (activeTab에 의존하지 않음)
  - **날짜 필터링**: 같은 날짜(`date`)의 할일만 대상으로 순서 변경
  - **인덱스 기반 재할당**: 값 교환 대신 인덱스 기반으로 `display_order` 재할당 `(인덱스 + 1) * 10` 방식으로 안정적 유지
    - 여러 번 이동해도 값이 계속 증가하지 않아 정렬이 안정적
    - 10 단위 간격으로 중간 삽입 가능
  - **반응형 레이아웃**: PC는 가로 배치 (`flex-direction: row, gap: 0`), 모바일은 세로 배치 (`flex-direction: column, gap: 0.1rem`)로 최적화
  - **드래그 앤 드롭 (PC 전용)**: PC에서만 드래그 앤 드롭으로 순서 변경 가능 (화면 너비 768px 초과 또는 터치 미지원 환경)
    - 모바일에서는 드래그 핸들이 숨겨지고 드래그 앤 드롭 이벤트가 등록되지 않음
    - 모바일에서는 위/아래 화살표 버튼으로만 순서 변경 가능
    - **개선 사항 (2025-01-21)**: 드래그 앤 드롭 안정성 대폭 개선
      - 드래그된 항목만 업데이트하던 방식에서 **전체 항목의 display_order 재할당** 방식으로 변경하여 순서 충돌 문제 해결
      - 첫 번째 항목 위 빈 공간 감지 로직 추가로 제일 위로 이동 시 정확한 감지
      - `elementFromPoint` 문제 해결: 드래그된 요소를 일시적으로 숨겨 정확한 타겟 요소 감지
      - 전역 상태에 `lastTargetTodoId`, `lastInsertBefore` 저장하여 `mouseup`에서도 정확한 위치 계산
      - 인덱스 계산 로직 개선: 드래그된 항목을 제거한 후의 배열 기준으로 새 위치 계산
      - 여러 번 드래그해도 순서가 일관되게 유지됨
- FR-B14. **지난 날짜 할일 수정/삭제 제한**: 지난 날짜(오늘 이전) 화면에서 기존 할일만 수정/삭제 불가
  - 지난 날짜에서도 새로운 할일 추가는 가능 (테스트 및 이월 기능을 위해)
  - 기존 할일: `todo.date < actualToday`인 할일 (실제로 그 날짜에 생성된 할일)
  - 기존 할일은 수정/삭제/순서 변경 버튼 숨김, 체크박스 비활성화
  - 새로 추가한 할일(`todo.date === today`)은 수정/삭제/순서 변경 가능
  - "지난 날짜" 배지 표시로 기존 할일 구분
- FR-B15. **할일 날짜 이동**: 할일을 다른 날짜로 이동하는 기능
  - 할일 항목에 "날짜 이동" 버튼 표시 (수정/삭제 버튼과 함께)
  - 버튼 클릭 시 달력 모달 오버레이 표시 (flatpickr 사용)
  - 다른 날짜 선택 시 즉시 해당 날짜로 이동 (`todos.date` 업데이트)
  - 같은 날짜 선택 시 모달만 닫기
  - 날짜 이동 후 현재 선택된 날짜의 할일 목록 자동 새로고침
  - 구현 방식: `onChange` 콜백에서 `dateStr`을 우선 사용하여 정확한 날짜 감지 (flatpickr의 `instance.selectedDates`는 비동기 업데이트로 인해 타이밍 이슈가 있음)
  - DOM 클릭 이벤트 직접 리스닝을 백업으로 사용
- FR-B16. **할일 복제**: 할일을 다른 날짜에 복제하는 기능
  - 할일 항목에 "복제" 버튼 표시 (날짜 이동 버튼 옆)
  - 버튼 클릭 시 달력 모달 오버레이 표시 (flatpickr 사용)
  - 날짜 선택 시 해당 날짜에 새 할일 생성 (원본 할일은 그대로 유지)
  - 복제된 할일은 원본의 모든 정보를 복사 (제목, 메모, 우선순위, 카테고리, 핀 상태 등)
  - 복제된 할일은 미완료 상태로 시작 (`is_done = false`)
  - 복제 후 현재 선택된 날짜의 할일 목록 자동 새로고침
  - 구현 방식: 날짜 이동과 동일한 달력 모달 사용, `duplicateTodo` 함수로 새 할일 생성
- FR-B17. **프로젝트 배지 표시**: 프로젝트를 통해 등록된 할일(`project_task_id`가 있는 할일)에 프로젝트 배지 표시 ✅ 2025-02-01 개선
  - 배지 위치: 핀 아이콘과 우선순위 배지 다음, 제목 앞
  - 배지 스타일: 인디고 계열 배경(`#e0e7ff`)과 텍스트(`#4f46e5`), `folder-kanban` 아이콘 포함
  - **배지 형식**: "프로젝트: 프로젝트명" (프로젝트 이름 포함)
  - 프로젝트 이름이 없으면 (삭제된 경우) "프로젝트"만 표시
  - **데이터 조회**: todos 조회 시 `project_tasks`와 `projects`를 JOIN하여 프로젝트 이름 가져옴
  - **적용 범위**: 오늘 할일 목록, 이월 모달 모두 적용
  - 일반 할일은 배지 표시되지 않음

### AC-B
- AC-B1. PC에서 완료 토글 → 모바일 새로고침 시 동일 상태
- AC-B2. 동일 날짜 목록이 PC/모바일에서 **동일 정렬**로 표시
- AC-B3. deleted_at 있는 항목은 기본 목록 미노출
- AC-B4. 공백 입력 저장 시도 시 DB row 생성되지 않음 + 안내 노출
- AC-B5. 수정 모드에서 Enter 키로 저장, Escape 키로 취소 작동 ✅
- AC-B6. 카테고리 탭이 헤더 오른쪽에 표시됨 ✅
- AC-B7. 토글 상태가 localStorage에 저장되어 새로고침 후에도 유지 ✅
- AC-B8. 미완료 항목만 순서 변경 가능, 완료된 항목은 항상 아래에 표시 ✅
- AC-B9. 순서 변경 시 RLS 정책 위반 없이 정상 작동 ✅
- AC-B13. **순서 변경 안정성**: 여러 번 순서 변경해도 정상 작동 (인덱스 기반 재할당 방식) ✅
- AC-B14. **카테고리 독립성**: 어떤 카테고리 탭이 선택되어 있어도 각 할일의 실제 카테고리 내에서만 순서 변경 ✅
- AC-B15. **날짜 일관성**: 같은 날짜의 할일만 대상으로 순서 변경하여 다른 날짜 할일과 섞이지 않음 ✅
- AC-B21. **드래그 앤 드롭 안정성 (2025-01-21)**: 드래그 앤 드롭으로 위/아래 이동 시 정확하게 작동, 특히 첫 번째 항목 위로 이동 시 정확한 감지 ✅
- AC-B22. **전체 항목 순서 재할당**: 드래그 앤 드롭 시 전체 항목의 display_order를 재할당하여 순서 충돌 없이 일관되게 유지 ✅
- AC-B23. **여러 번 드래그 안정성**: 여러 번 드래그해도 순서가 일관되게 유지되고 불규칙적으로 이동하지 않음 ✅
- AC-B10. 지난 날짜에서도 새 할일 추가 가능 ✅
- AC-B11. 지난 날짜의 기존 할일만 수정/삭제/순서 변경 불가, 새로 추가한 할일은 수정/삭제 가능 ✅
- AC-B12. 기존 할일은 체크박스 비활성화, 새 할일은 체크 가능 ✅
- AC-B16. **할일 날짜 이동**: 다른 날짜를 선택하면 즉시 해당 날짜로 이동됨 ✅
- AC-B17. **날짜 이동 안정성**: `dateStr`을 우선 사용하여 타이밍 이슈 없이 정확한 날짜 감지 ✅
- AC-B18. **할일 복제**: 날짜를 선택하면 해당 날짜에 새 할일이 생성되고 원본은 그대로 유지됨 ✅
- AC-B19. **복제 정보 보존**: 복제된 할일이 원본의 모든 정보(제목, 메모, 우선순위, 카테고리, 핀 상태)를 정확히 복사함 ✅
- AC-B20. **프로젝트 배지 표시**: 프로젝트를 통해 등록된 할일만 "프로젝트: 프로젝트명" 형식으로 배지가 표시되고, 일반 할일은 배지가 표시되지 않음 ✅
- AC-B21. **프로젝트 이름 표시**: 프로젝트 이름이 배지에 정확히 표시되며, 프로젝트 삭제 시 "프로젝트"만 표시됨 ✅

---

## C. 오늘 — 루틴(Routine) ✅ 구현 완료
### C-0 구조 (구현됨)
- **위치**: 오늘 페이지 최상단 (할일 위)
- **제목**: "오늘 루틴" (그라데이션 배경: 녹색/틸)
- **헤더 레이아웃**: 왼쪽(아이콘 + 제목 + 토글 버튼) | 오른쪽(진행률 배지)
- **구분**: 모닝루틴 / 나이트루틴 (좌우 분리, 구분선)
- **아이콘**: `target` (제목), `sunrise` (모닝), `moon` (나이트)
- **진행률**: 헤더 오른쪽 배지 (전체/모닝/나이트 각각 표시)
- **토글 기능**: 제목 옆 토글 버튼으로 접기/펼치기 (기본값: 펼침, localStorage 저장)

### FR-C (구현됨)
- FR-C1. 루틴 정의: `title`, `schedule`, `is_active`
- FR-C2. schedule JSON 스키마(고정)
  - **monthly**: `{ "type":"monthly", "month":"YYYY-MM-01", "active_from_date":"YYYY-MM-DD" }` (월간 데일리 루틴)
    - `active_from_date`: 루틴 적용 시작일 (YYYY-MM-DD). Goals 탭에서 새로 생성된 루틴에만 존재. 기존 루틴은 `created_at` 기준으로 판단
  - daily/weekly: 스키마는 정의되어 있으나 현재 미사용 (월간 루틴만 사용)
- FR-C3. 루틴 체크는 `routine_logs`에 upsert(유니크키로 중복 방지)
- FR-C4. 오늘 진행률: (오늘 체크 true 개수) / (오늘 대상 루틴 개수)
  - 전체 진행률: "✓ 0 / 13" + 진행바 + "0%"
  - 모닝/나이트 개별 진행률: "☀ 0 / 8", "🌙 0 / 5"
- FR-C5. **날짜 기준 필터링**: 선택한 날짜에 해당 루틴이 활성 상태였는지 날짜 기준으로 판단
  - `fetchRoutines`에서는 `is_active` 조건 없이 모든 루틴 조회 (비활성화된 루틴 포함)
  - `isRoutineDue`에서 날짜 기준 필터링:
    - 적용 시작일 <= 선택 날짜 < 비활성화일
    - 적용 시작일: `schedule.active_from_date` 또는 `created_at` (날짜 부분)
    - 비활성화일: `deleted_at` (날짜 부분, 없으면 현재 활성 상태)
- FR-C6. **Soft Delete 정책**: 루틴 변경 시 완전 삭제 대신 `is_active = false`, `deleted_at = NOW()` (과거 체크 기록 보존)
  - 비활성화된 루틴도 조회되며, 날짜 기준으로 필터링되어 선택 날짜에 해당하는 루틴만 표시
  - 어제 날짜 선택 시: 어제 활성 상태였던 루틴 표시 (오늘 비활성화되었어도 어제는 표시됨)
  - 오늘 날짜 선택 시: 오늘 활성 상태인 루틴만 표시
- FR-C7. **월간 루틴 연동**: Goals 탭에서 저장한 월간 데일리 루틴이 자동으로 `routines` 테이블에 동기화
- FR-C8. **모닝/나이트 구분**: 각각 독립적으로 표시 및 체크 가능
- FR-C9. **루틴 없음 처리**: 루틴이 없을 때 "오늘 수행할 루틴이 없습니다" 메시지 + Goals 링크
- FR-C10. **토글 기능**: 헤더 제목 옆 토글 버튼으로 내용 접기/펼치기 (기본값: 펼침, 상태 localStorage 저장)

### AC-C (검증됨)
- AC-C1. PC에서 체크한 루틴이 모바일에서도 동일 체크/진행률 ✅
- AC-C2. 동일 routine/date 중복 기록 불가(UNIQUE + upsert) ✅
- AC-C3. 루틴 변경 시 과거 체크 기록 보존 (Soft Delete) ✅
- AC-C4. Goals 탭 저장 → 오늘 탭 즉시 반영 (동기화) ✅
- AC-C5. 모닝/나이트 각각 0개일 때 해당 섹션 숨김 처리 ✅
- AC-C6. 토글 상태가 localStorage에 저장되어 새로고침 후에도 유지 ✅
- AC-C7. **날짜 기준 필터링**: 어제 날짜 선택 시 어제 활성 상태였던 루틴 표시 ✅
- AC-C8. **날짜 기준 필터링**: 오늘 날짜 선택 시 오늘 활성 상태인 루틴만 표시 ✅
- AC-C9. **월중 수정 반영**: 같은 날 루틴 수정 시 오늘 날짜에는 새 루틴만, 어제 날짜에는 기존 루틴만 표시 ✅
- AC-C10. **PC/모바일 동기화**: 날짜 기준 필터링 로직이 동일하여 양쪽 기기에서 동일한 루틴 표시 ✅
- AC-C11. **토글 버튼 안정성**: cloneNode 패턴으로 이벤트 리스너 중복 등록 방지, Lucide 렌더링 완료 후 등록으로 첫 로드 시에도 정상 작동 ✅
- AC-C12. **주간 통계 정확성**: 주 중 루틴 변경 시 주간 실천율이 정확하게 계산됨 (날짜별 필터링 적용) ✅

---

## D. 오늘 — 하루 성찰(4항목) ✅ 구현 완료
### D-0 구조 (구현됨)
- **위치**: 오늘 페이지 하단 (할일 아래)
- **제목**: "하루 성찰" (그라데이션 배경: 보라색/핑크)
- **헤더 레이아웃**: 왼쪽(아이콘 + 제목 + 토글 버튼) | 오른쪽("성찰 작성하기" 버튼)
- **아이콘**: `pen-square` (제목 및 버튼)
- **토글 기능**: 제목 옆 토글 버튼으로 접기/펼치기 (기본값: 접힘, "성찰 작성하기" 버튼으로 펼치기)

### FR-D (구현됨)
- FR-D1. **기본 접힘 상태**: 섹션이 기본적으로 접혀있음 (`display: none`)
- FR-D2. **"성찰 작성하기" 버튼**: 헤더 오른쪽에 배치, 클릭 시 섹션 펼치기 및 폼 표시
- FR-D3. **4항목 고정**
  1) grateful(감사한 일)
  2) well_done(잘한 일)
  3) regret(아쉬운 일)
  4) tomorrow_promise(내일의 다짐)
- FR-D4. **1일 1건(UNIQUE(user_id,date))**: upsert로 저장
- FR-D5. **저장 정책(고정)**
  - 각 필드는 비어도 됨
  - 단, 4개 모두 공란이면 저장 불가 + 안내
- FR-D6. **저장 후 자동 접힘**: 저장 성공 시 섹션 자동 접힘 및 폼 숨김

### AC-D (검증됨)
- AC-D1. PC 저장 → 모바일 동일 날짜 동일 내용 ✅
- AC-D2. 전체 공란 저장 불가가 일관되게 적용 ✅
- AC-D3. 기본 접힘 상태 유지, "성찰 작성하기" 버튼으로만 펼치기 ✅
- AC-D4. 저장 후 자동 접힘 작동 ✅

---

## E. "미완료 할일 이월" 모달(Carry-over) ✅ 구현 완료
### 정책(구현됨)
- 대상: `date < 오늘` AND `is_done = false` AND `deleted_at IS NULL` AND `carried_over_at IS NULL` AND `skipped_at IS NULL`
  - **변경**: "어제"만 → "오늘 이전 모든 날짜" (어제, 그제, 100일 전 등)
- 노출: **기기(브라우저) 기준 1일 1회**(localStorage 키로 제어)
  - key: `carryover_shown_{today}`
- 이어가기 방식: **복제(새 ID)** + 원본은 유지 + 원본에 `carried_over_at = now()` 기록(재노출 방지)
- **포기 방식**: 원본에 `skipped_at = now()` 기록 (NEW!)

### FR-E (구현됨)
- FR-E1. 앱 진입 시 대상 있으면 모달 노출
- FR-E2. 액션
  - **이어가기**: 오늘로 복제 + 원본 `carried_over_at` 기록
  - **포기**: 원본 `skipped_at` 기록 (삭제 대신 "포기" 상태)
  - **나중에**: 모달 닫기, 내일 다시 표시
  - ~~모두 삭제~~: 제거됨 (개별 포기만 허용)
- FR-E3. 개별 항목 이어가기/포기 지원
- FR-E4. **시각적 구분** (과거 날짜 화면):
  - 이어간 할일: 회색 배경 + "→ 오늘로 이동됨" (녹색 배지)
  - 포기한 할일: 회색 배경 + "× 포기함" (빨간 배지)
  - 처리된 할일은 편집/삭제 버튼 숨김

### AC-E (검증됨)
- AC-E1. 대상 있을 때만 뜨며, 동일 기기에서 당일 재노출 없음 ✅
- AC-E2. "이어가기" 후 오늘(date=today) 목록에 생성되고 동기화됨 ✅
- AC-E3. 처리된 원본은 `carried_over_at` 또는 `skipped_at`로 인해 다음 실행 시 재노출되지 않음 ✅
- AC-E4. PC/모바일 간 동기화 정상 작동 ✅
- AC-E5. 히스토리 추적 가능: "이번 달에 몇 개를 이어갔는지/포기했는지" 통계 가능 ✅
- AC-E6. **과거 날짜 배지 표시**: 이월/포기한 할일이 과거 날짜에서 배지와 함께 표시됨 ✅ (2025-02-02)
  - 이월한 할일: "→ 오늘로 이동됨" 녹색 배지 + 회색 배경 + 읽기 전용
  - 포기한 할일: "× 포기함" 빨간 배지 + 회색 배경 + 읽기 전용
- AC-E7. **프로젝트/반복업무 중복 방지**: 이월 시 오늘 날짜에 이미 등록된 할일이 있으면 중복 생성되지 않음 ✅ (2025-02-02)
  - 중복 체크: `project_task_id`/`recurring_task_id` + `date = today` + `carried_over_at IS NULL` + `skipped_at IS NULL`
  - 이미 등록됨 표시 후 원본만 `carried_over_at` 기록

### E-0 구현 세부사항 (2025-02-02 추가)

#### **과거 날짜 조회 정책**
- **원칙**: 과거 날짜 조회 시에도 이월/포기한 할일을 **배지와 함께 표시**
- **구현**: `fetchTodos` 함수에서 과거 날짜 필터링 제거 (src/pages/today.js:623-630)
  - 제거 전: `if (date < today) { filteredData = filteredData.filter(todo => !todo.carried_over_at && !todo.skipped_at); }`
  - 제거 후: 모든 날짜에서 이월/포기한 할일도 조회하여 렌더링 시 배지로 시각적 구분
- **효과**:
  - 히스토리 추적 가능: 어제 날짜에서 어떤 할일을 포기했는지/이월했는지 확인 가능
  - 사용자 경험 개선: 과거 날짜에서도 완전한 기록 제공

#### **중복 방지 메커니즘**
- **목적**: 프로젝트/반복업무 할일 이월 시 오늘 날짜에 중복 생성 방지
- **구현 위치**:
  1. 프로젝트 할일 이월: `carryOverTodo` 함수 (src/pages/today.js:2104-2156)
  2. 반복업무 할일 이월: `carryOverTodo` 함수 (src/pages/today.js:2158-2207)
  3. 프로젝트 일괄 등록: `registerProjectTasksToTodos` 함수 (src/pages/projects.js:1361-1368)
- **중복 체크 조건**:
  ```javascript
  .eq('project_task_id', taskId)  // 또는 recurring_task_id
  .eq('date', today)              // ⭐ 오늘 날짜만 체크
  .is('deleted_at', null)
  .is('carried_over_at', null)    // ⭐ 이월된 원본 제외
  .is('skipped_at', null)         // ⭐ 포기된 원본 제외
  ```
- **핵심**: `.eq('date', today)` 조건으로 **오늘 날짜만** 체크하므로 과거 날짜 조회와 충돌 없음
- **동작**:
  - 오늘 날짜에 활성 할일(`carried_over_at = null` && `skipped_at = null`)이 있으면 "이미 등록됨" 표시
  - 새로 복제하지 않고 원본만 `carried_over_at` 기록
  - 과거 날짜의 원본(`carried_over_at != null`)은 자동으로 제외되어 중복 체크에 영향 없음

#### **날짜 분리 원리**
- **날짜 컬럼(`date`)으로 자연스럽게 분리**:
  - 어제 할일: `date = 2025-02-01`
  - 오늘 할일: `date = 2025-02-02`
  - 서로 다른 날짜이므로 동시에 표시되지 않음
- **시나리오 예시**:
  ```
  프로젝트 할일 (1/1~1/10 등록)
  1/1: 할일 A (project_task_id=123, date=2025-01-01, 미완료)
  1/2: 할일 B (project_task_id=123, date=2025-01-02, 미완료)
  
  [1/2 이월 모달에서 "이어가기" 클릭]
  중복 체크: date=2025-01-02 && project_task_id=123 && carried_over_at=null
  → 할일 B 찾음 → "이미 등록됨" 표시
  → 할일 A에만 carried_over_at 기록
  
  [1/1 날짜 선택]
  → 할일 A 표시 + "→ 오늘로 이동됨" 녹색 배지
  
  [1/2 날짜 선택]
  → 할일 B만 표시 (중복 없음!)
  ```

---

## F. 리포트(주간/월간/연간) + AI 주간/월간/연간 성찰
### F-1 통계 리포트 FR-FS ✅ 구현 완료
- FR-FS1. 주간 지표
  - todo 완료율 = 완료 todo / 전체 todo (해당 주 date 기준)
  - **루틴 실천율 = 체크 true / (각 날짜별 활성 루틴 수 합계)** ✅ 날짜별 필터링 적용
    - **날짜별 계산**: 주의 각 날짜마다 `isRoutineDue` 함수로 활성 루틴 수 계산
    - **루틴 변경 반영**: 주 중에 루틴이 추가/삭제되어도 정확한 실천율 계산
    - **예시**: 월~수 10개, 목~일 12개 → 가능한 체크 수 = (10×3) + (12×4) = 78개
    - **모닝/나이트**: 각각 날짜별로 계산하여 정확한 실천율 제공
    - **루틴별 실천율**: 각 루틴의 활성 일수 기준으로 계산 (7일 고정 아님)
    - **현재 주 실행률 기준 변경 (2025-01-28)**: ✅ 구현 완료
      - **현재 주인 경우**: 월요일 ~ 오늘까지를 기준으로 실행률 계산 (예: 화요일이면 월~화 기준, 목요일이면 월~목 기준)
      - **과거 주인 경우**: 전체 주(월~일)를 기준으로 계산
      - 구현 위치: `src/utils/weeklyStats.js`의 `getWeeklyStats` 함수에서 `effectiveEndDate` 계산
      - 관리자 페이지도 동일한 로직 적용: `src/admin.js`의 `getUserWeeklyStats` 함수
  - 성찰 작성일 수 = daily_reflections 존재한 date 수
- FR-FS2. 월간 지표(합/평균) ✅ 구현 완료
  - todo 완료율 = 완료 todo / 전체 todo (해당 월 date 기준)
  - **루틴 실천율 = 체크 true / (각 날짜별 활성 루틴 수 합계)** ✅ 날짜별 필터링 적용
    - **날짜별 계산**: 월의 각 날짜마다 `isRoutineDue` 함수로 활성 루틴 수 계산
    - **루틴 변경 반영**: 월 중에 루틴이 추가/삭제되어도 정확한 실천율 계산
    - **월의 일수**: 28~31일 동적 계산 (하드코딩된 "7일" 제거)
    - **모닝/나이트**: 각각 날짜별로 계산하여 정확한 실천율 제공
    - **루틴별 실천율**: 각 루틴의 활성 일수 기준으로 계산
    - **현재 달 실행률 기준 변경 (2025-01-28)**: ✅ 구현 완료
      - **현재 달인 경우**: 1일 ~ 오늘까지를 기준으로 실행률 계산 (예: 15일이면 1~15일 기준, 25일이면 1~25일 기준)
      - **과거 달인 경우**: 전체 달(1일~말일)를 기준으로 계산
      - 구현 위치: `src/utils/monthlyStats.js`의 `getMonthlyStats` 함수에서 `effectiveEndDate` 계산
  - 성찰 작성일 수 = daily_reflections 존재한 date 수
  - **월간 통계 계산 로직** ✅ 구현 완료
    - **루틴 통계**: `src/utils/monthlyStats.js`의 `getRoutinesStats` 함수
      - 모든 루틴 조회 (`is_active` 조건 제거, PRD FR-C5 준수)
      - 각 날짜별로 `isRoutineDue` 함수로 활성 루틴 필터링
      - 가능한 체크 수 = 각 날짜의 활성 루틴 수 합계
      - 모닝/나이트도 날짜별로 계산
      - 루틴별 실천율은 활성 일수 기준으로 계산
    - **Edge Function**: `supabase/functions/ai-monthly-reflection/index.ts`의 `collectMonthlyStats` 함수
      - 동일한 날짜별 필터링 로직 적용
      - AI 성찰 생성 시 정확한 통계 사용
      - **참고**: Edge Function은 과거 달 데이터 처리이므로 전체 달 기준 유지
- FR-FS3. 규칙 기반 인사이트 문장(v1) ✅ 구현 완료
  - 예: "이번 주 할일 완료율이 70%로 양호합니다. 다음 주는 루틴 실천율을 5%p 올려보세요."
  - 주간 분석: 실천율 요약, 전주 대비 변화, 주간 패턴 분석
    - **가장 활발한 요일**: 요일별 할일/루틴 완료 수를 집계하여 가장 높은 요일 표시, 해당 요일의 실제 완료 수만 표시 (전체 주간 합계가 아닌 해당 요일만)
- FR-FS4. **주간 통계 계산 로직** ✅ 구현 완료
  - **루틴 통계**: `src/utils/weeklyStats.js`의 `getRoutinesStats` 함수
    - 모든 루틴 조회 (`is_active` 조건 제거, PRD FR-C5 준수)
    - 각 날짜별로 `isRoutineDue` 함수로 활성 루틴 필터링
    - 가능한 체크 수 = 각 날짜의 활성 루틴 수 합계
    - 모닝/나이트도 날짜별로 계산
    - 루틴별 실천율은 활성 일수 기준으로 계산
    - **현재 주 실행률 기준**: 현재 주인 경우 월요일 ~ 오늘까지, 과거 주인 경우 전체 주(월~일) 기준
  - **Edge Function**: `supabase/functions/ai-weekly-reflection/index.ts`의 `collectWeeklyStats` 함수
    - 동일한 날짜별 필터링 로직 적용
    - AI 성찰 생성 시 정확한 통계 사용
    - **참고**: Edge Function은 과거 주 데이터 처리이므로 전체 주 기준 유지
- FR-FS5. 집계는 DB View 또는 SQL 함수 기반 제공 권장(클라이언트 부하 최소화) ✅ 구현 완료
- FR-FS6. 연간 지표(합/평균) ✅ 구현 완료
  - todo 완료율 = 완료 todo / 전체 todo (해당 연도 date 기준)
  - **루틴 실천율 = 체크 true / (각 날짜별 활성 루틴 수 합계)** ✅ 날짜별 필터링 적용
    - **날짜별 계산**: 연도의 각 날짜마다 `isRoutineDue` 함수로 활성 루틴 수 계산
    - **루틴 변경 반영**: 연도 중에 루틴이 추가/삭제되어도 정확한 실천율 계산
    - **연도의 일수**: 365일 (윤년 고려하지 않음, 간단화)
    - **모닝/나이트**: 각각 날짜별로 계산하여 정확한 실천율 제공
    - **루틴별 실천율**: 각 루틴의 활성 일수 기준으로 계산
    - **현재 연도 실행률 기준 변경 (2025-01-28)**: ✅ 구현 완료
      - **현재 연도인 경우**: 1월 1일 ~ 오늘까지를 기준으로 실행률 계산 (예: 3월이면 1월 1일~3월 말일 기준)
      - **과거 연도인 경우**: 전체 연도(1월 1일~12월 31일)를 기준으로 계산
      - 구현 위치: `src/utils/yearlyStats.js`의 `getYearlyStats` 함수에서 `effectiveEndDate` 계산
  - 성찰 작성일 수 = daily_reflections 존재한 date 수
  - **연간 통계 계산 로직** ✅ 구현 완료
    - **루틴 통계**: `supabase/functions/ai-yearly-reflection/index.ts`의 `collectYearlyStats` 함수
      - 모든 루틴 조회 (`is_active` 조건 제거, PRD FR-C5 준수)
      - 각 날짜별로 `isRoutineDue` 함수로 활성 루틴 필터링
      - 가능한 체크 수 = 각 날짜의 활성 루틴 수 합계
      - 모닝/나이트도 날짜별로 계산
      - 루틴별 실천율은 활성 일수 기준으로 계산
      - **참고**: Edge Function은 과거 연도 데이터 처리이므로 전체 연도 기준 유지
    - **월별 통계 요약**: 1월~12월 각 월별 할일 완료율 요약 제공

### F-1 AC (검증됨)
- AC-FS1. “이번 주”는 월~일 고정(기기/브라우저 무관) ✅
- AC-FS2. 날짜 경계(23:59~00:01)에서도 기준이 흔들리지 않음(타임존 준수) ✅
- AC-FS3. **루틴 변경 반영**: 주 중에 루틴이 추가/삭제되어도 주간 실천율이 정확하게 계산됨 ✅
- AC-FS9. **현재 주 실행률 기준**: 현재 주인 경우 월요일 ~ 오늘까지를 기준으로 실행률 계산되어 초반 주에 실행률이 낮게 나오는 문제 해결 ✅
- AC-FS10. **과거 주 실행률 기준**: 과거 주는 전체 주(월~일)를 기준으로 계산하여 정확한 주간 통계 제공 ✅
- AC-FS4. **월간 통계**: 월의 일수(28~31일) 동적 계산, 하드코딩된 "7일" 값 제거 ✅
- AC-FS5. **루틴 변경 반영**: 월 중에 루틴이 추가/삭제되어도 월간 실천율이 정확하게 계산됨 ✅
- AC-FS11. **현재 달 실행률 기준**: 현재 달인 경우 1일 ~ 오늘까지를 기준으로 실행률 계산되어 초반 달에 실행률이 낮게 나오는 문제 해결 ✅
- AC-FS12. **과거 달 실행률 기준**: 과거 달은 전체 달(1일~말일)를 기준으로 계산하여 정확한 월간 통계 제공 ✅
- AC-FS6. **전월 비교**: 연도 경계를 넘어가는 전월 계산 정확 (Luxon 사용) ✅
- AC-FS7. **연간 통계**: 연도의 일수(365일) 동적 계산, 루틴 변경 반영 정확 ✅
- AC-FS8. **루틴 변경 반영**: 연도 중에 루틴이 추가/삭제되어도 연간 실천율이 정확하게 계산됨 ✅
- AC-FS13. **현재 연도 실행률 기준**: 현재 연도인 경우 1월 1일 ~ 오늘까지를 기준으로 실행률 계산되어 초반 연도에 실행률이 낮게 나오는 문제 해결 ✅
- AC-FS14. **과거 연도 실행률 기준**: 과거 연도는 전체 연도(1월 1일~12월 31일)를 기준으로 계산하여 정확한 연간 통계 제공 ✅

### F-2 AI 성찰 FR-FAI (필수: Edge Function) ✅ 주간/월간/연간 성찰 구현 완료
- FR-FAI1. 주간 AI 성찰 생성 버튼 ✅ 구현 완료
- FR-FAI2. 월간 AI 성찰 생성 버튼 ✅ 구현 완료
- FR-FAI3. 연간 AI 성찰 생성 버튼 ✅ 구현 완료
- FR-FAI4. 입력은 해당 기간 요약(통계 + 핵심 텍스트 일부(길이 제한)) 포함 ✅ 구현 완료
  - 연간 성찰: 연간 통계, 연간 목표, 월별 실천계획 및 결과 요약 포함
- FR-FAI5. 결과는 `content_md`로 저장(마크다운) ✅ 구현 완료
- FR-FAI6. 동일 기간 재생성은 upsert(덮어쓰기)로 고정 ✅ 구현 완료
- FR-FAI7. 저장 메타: `model`, `prompt_version`, `generated_at`(=created_at) ✅ 구현 완료
- **추가 구현 사항**:
  - Edge Function: Gemini API 사용 (gemini-2.5-flash), maxOutputTokens: 8000
  - 마크다운 변환: 안정적인 HTML 변환 로직 (헤더, 리스트, 볼드, 이탤릭, 구분선 지원)
  - 스크롤바: max-height: 600px, overflow-y: scroll
  - 디버깅 로그: DB 원본 데이터 및 변환 과정 추적
  - 예외 처리: 각 줄 처리 시 예외 발생해도 모든 내용 표시 보장
  - **에러 메시지 한글화**: Gemini API 에러 메시지를 한글로 번역하여 사용자에게 표시 ✅
    - 할당량 초과: "일일 사용 한도를 초과했습니다. 내일 다시 시도해주세요."
    - 모델 과부하: "AI 모델이 일시적으로 과부하 상태입니다. 잠시 후 다시 시도해주세요."
    - API 키 오류: "API 키가 유효하지 않습니다. 관리자에게 문의해주세요."
    - 네트워크 오류: "네트워크 연결 오류가 발생했습니다. 인터넷 연결을 확인하고 다시 시도해주세요."
    - 서버 오류: "서버 오류가 발생했습니다. 잠시 후 다시 시도해주세요."
  - **에러 팝업 중복 방지**: 에러 발생 시 팝업이 한 번만 표시되도록 개선 ✅
  - **레이트리밋 로직 강화**: 연간 AI 성찰 레이트리밋 체크 로직 개선 ✅
    - 카운터 조회 실패 시 에러 반환 (레이트리밋 체크 우회 방지)
    - upsert 반환값 확인 강화 (.select().single() 추가)
    - 카운터 업데이트 실패 시 에러 반환
    - 로깅 및 검증 강화 (예상 카운트와 실제 카운트 불일치 시 경고)
  - **DB 제약조건 수정**: ai_usage_counters 테이블의 scope CHECK 제약조건에 yearly_reflection 추가 ✅

### F-2 AC (검증됨)
- AC-FAI1. 생성 후 DB 저장 → PC/모바일 동일 결과 조회 ✅
- AC-FAI2. pending/rejected/blocked는 생성/조회 불가(RLS + Edge 인증) ✅
- AC-FAI3. AI 호출 실패 시 DB에 부분 저장 없음(서버에서 원자적 처리) ✅
- AC-FAI4. 월간 AI 성찰 생성/조회 정상 작동 ✅
- AC-FAI5. 월간 사용량 추적 정상 작동 (레이트리밋 제한 없음) ✅
- AC-FAI6. 연간 AI 성찰 생성/조회 정상 작동 ✅
- AC-FAI7. 연간 사용량 추적 정상 작동 (레이트리밋 제한 없음) ✅
- AC-FAI8. **에러 메시지 한글화**: Gemini API 에러 메시지가 한글로 표시됨 ✅
- AC-FAI9. **에러 팝업 중복 방지**: 에러 발생 시 팝업이 한 번만 표시됨 ✅
- AC-FAI10. **사용량 카운터 안정성**: 카운터 조회/업데이트 실패 시 에러 반환하여 정확한 통계 추적 보장 ✅
- AC-FAI11. **DB 제약조건 수정**: ai_usage_counters 테이블의 scope CHECK 제약조건에 yearly_reflection 포함 확인 ✅

---

## G. 목표(연간) + 월실천계획(직접/AI)
### G-0 월간 데일리 루틴 ✅ 구현 완료
#### 구조 (구현됨)
- **위치**: Goals 탭 최상단
- **제목**: "월간 데일리 루틴" (그라데이션 배경: 보라색/핑크)
- **아이콘**: `repeat` (제목), `sunrise` (모닝), `moon` (나이트)
- **모드**: 보기 모드 / 편집 모드 (토글)
- **토글 기능**: 헤더 제목 옆 토글 버튼으로 내용 접기/펼치기 (기본값: 펼침, 상태 localStorage 저장)
- **부제목**: "12월 매일 실천할 루틴" (동적, 제목 아래 표시, 글씨 크기 1rem)
- **구분선**: 부제목 아래 헤더 border-bottom으로 구분선 표시

#### FR-G0 (구현됨)
- FR-G0-1. 모닝/나이트 루틴 각각 0~10개 입력 가능
- FR-G0-2. 각 루틴 입력 필드에 번호 표시 (1, 2, 3...)
- FR-G0-3. Enter 키로 다음 입력 필드 자동 추가 (최대 10개까지)
- FR-G0-4. 개별 삭제 버튼 (X 아이콘)
- FR-G0-5. "모닝루틴 추가" / "나이트루틴 추가" 버튼
- FR-G0-6. 카운터 표시: "0/10" (현재 개수/최대 개수)
- FR-G0-7. 저장 시 `monthly_plans.daily_routines` JSONB에 저장
  - 형식: `{ "morning": ["루틴1", "루틴2"], "night": ["루틴3"] }`
- FR-G0-8. 저장 시 `routines` 테이블에 동기화
  - 기존 활성 월간 루틴: `is_active = false`, `deleted_at = NOW()` (Soft Delete)
  - 새 루틴 생성: `schedule = { "type": "monthly", "month": "YYYY-MM-01", "active_from_date": "YYYY-MM-DD" }` 생성
    - `active_from_date`: 오늘 날짜 (YYYY-MM-DD) 저장하여 오늘부터 적용
  - 기존 비활성 루틴 재활성화: `is_active = true`, `deleted_at = NULL`, **`active_from_date`는 기존 값 유지** (과거 기록 보존)
- FR-G0-9. 보기 모드: 저장된 루틴 목록 표시 + "수정하기" 버튼
- FR-G0-10. 편집 모드: 입력 필드 + "저장하기" / "취소" 버튼
- FR-G0-11. 루틴 없을 때: "등록된 모닝루틴이 없습니다" / "등록된 나이트루틴이 없습니다" 메시지
- FR-G0-12. **토글 기능**: 헤더 제목 옆 토글 버튼으로 내용 접기/펼치기 (기본값: 펼침, 상태 localStorage 저장) ✅
- FR-G0-13. **부제목 표시**: 제목 아래 부제목 "12월 매일 실천할 루틴" 표시 (동적, 글씨 크기 1rem) ✅

#### AC-G0 (검증됨)
- AC-G0-1. Goals 탭 저장 → 오늘 탭 즉시 반영 ✅
- AC-G0-2. 루틴 변경 시 과거 체크 기록 보존 (Soft Delete) ✅
- AC-G0-3. Enter 키로 자동 추가 작동 ✅
- AC-G0-4. PC/모바일 동기화 정상 ✅
- AC-G0-5. 중복 생성 방지 (기존 루틴 비활성화 후 새로 생성) ✅
- AC-G0-6. 토글 기능 정상 작동, 상태가 localStorage에 저장되어 새로고침 후에도 유지 ✅
- AC-G0-7. 부제목이 동적으로 업데이트되며 올바른 위치에 표시됨 ✅
- AC-G0-8. **재활성화 루틴의 active_from_date 보존**: 기존 루틴 삭제 후 재추가 시 `active_from_date`가 원래 값으로 유지되어 과거 날짜에서도 해당 루틴이 정상 표시됨 ✅
- AC-G0-9. **전월 루틴 복사 기능**: "전월 루틴 복사" 버튼 클릭 시 전월 루틴이 현재 월에 복사되고 오늘부터 적용됨 ✅
- AC-G0-10. **전월 루틴 없음 처리**: 전월 루틴이 없으면 알림 표시 ✅
- AC-G0-11. **덮어쓰기 확인**: 이번 달 루틴이 있으면 덮어쓰기 확인 메시지 표시 ✅
- AC-G0-12. **월별 히스토리 관리**: 복사된 루틴은 `schedule.month`로 월별 구분되어 히스토리 자동 관리 ✅
- AC-G0-13. **과거 기록 보존**: 복사 시 과거 루틴은 Soft Delete로 보존되어 과거 날짜 조회 시 정상 표시 ✅

### G-1 연간목표 FR-GY ✅ 구현 완료
#### 구조 (구현됨)
- **위치**: Goals 탭 (월간 데일리 루틴 아래)
- **제목**: "연간 목표" (그라데이션 배경: 인디고/보라)
- **아이콘**: `target` (제목), `book-open` (자기계발), `heart` (관계), `briefcase` (업무/재정)
- **모드**: 보기 모드 / 편집 모드 (토글)
- **토글 기능**: 헤더 제목 옆 토글 버튼으로 내용 접기/펼치기 (기본값: 펼침, 상태 localStorage 저장)
- **부제목**: "2025년 연간 목표" (동적, 제목 아래 표시, 글씨 크기 1rem)
- **구분선**: 부제목 아래 헤더 border-bottom으로 구분선 표시
- **연도 선택**: 이전/다음 연도 이동 버튼, 연도 레이블 클릭 시 연도 선택 모달
- **"올해로" 버튼**: 올해가 아닌 연도 선택 시 표시되는 버튼

#### FR-GY (구현됨)
- FR-GY1. 연도 선택(현재/이전/다음) ✅
- FR-GY2. 연도별 1건 저장(3영역) ✅
  - self_dev (자기계발)
  - relationship (관계)
  - work_finance (업무/재정)
- FR-GY3. 조회/수정 ✅
- FR-GY4. **토글 기능**: 헤더 제목 옆 토글 버튼으로 내용 접기/펼치기 (기본값: 펼침, 상태 localStorage 저장) ✅
- FR-GY5. **부제목 표시**: 제목 아래 부제목 "2025년 연간 목표" 표시 (동적, 글씨 크기 1rem) ✅
- FR-GY6. **연도 선택 모달**: 연도 레이블 클릭 시 모달에서 연도 선택 가능 ✅
  - 현재 연도 기준 앞뒤 5년 + DB에 저장된 연도들 표시
  - 현재 연도는 "올해 (2025년)" 형식으로 표시
  - 선택된 연도는 그라데이션 배경과 체크 아이콘으로 표시
- FR-GY7. **"올해로" 버튼**: 올해가 아닌 연도 선택 시 표시, 클릭 시 현재 연도로 이동 ✅

### G-1 AC (검증됨)
- AC-GY1. 연도별 데이터 분리, PC/모바일 동일 ✅
- AC-GY2. 토글 기능 정상 작동, 상태가 localStorage에 저장되어 새로고침 후에도 유지 ✅
- AC-GY3. 부제목이 선택된 연도에 맞춰 동적으로 업데이트됨 ✅
- AC-GY4. 연도 선택 모달에서 원하는 연도를 쉽게 선택 가능 ✅
- AC-GY5. "올해로" 버튼이 올해가 아닐 때만 표시되고 정상 작동 ✅

### G-1.5 AI 연간 목표 피드백 FR-GYAI ✅ 구현 완료 (필수: Edge Function)
#### 구조 (구현됨)
- **버튼**: "AI로 피드백받기" (연간 목표 편집 모드에서 표시)
- **입력**: 
  - 연도(year)
  - 연간 목표 3영역(self_dev, relationship, work_finance)
  - 최소 1개 영역에 내용이 있어야 함
- **출력 포맷**: JSON 형식 (각 영역별 개선 제안)
  - SMART 기준에 맞춰 개선 제안
  - 번호 리스트 형식 (1., 2., 3. 등)
  - 측정 가능한 수치 포함
  - 반복되는 날짜 표현 제거
- **표시**: 원본과 개선 제안을 나란히 표시
  - 원본: 흰색 배경 박스
  - 개선 제안: 녹색 배경 박스 (#f0fdf4)
  - 각 영역별로 "적용하기" 버튼 제공
  - 빈 항목 처리: 개선 제안이 없는 영역은 적용 버튼 숨김
- **저장**: DB 저장 없이 클라이언트에서만 표시 및 적용 (사용자가 직접 저장 버튼으로 저장)
- **이벤트 처리**: 이벤트 위임 패턴으로 동적 생성된 "적용하기" 버튼 처리, 중복 등록 방지 메커니즘 적용

#### FR-GYAI (구현됨)
- FR-GYAI1. "AI로 피드백받기" 버튼 클릭 시 Edge Function 호출 ✅
- FR-GYAI2. 입력 검증: 최소 1개 영역에 내용이 있어야 함 ✅
- FR-GYAI3. AI 프롬프트: SMART 기준에 맞춰 개선 제안 (Specific, Measurable, Achievable, Relevant, Time-bound) ✅
- FR-GYAI4. 출력 포맷: JSON 형식 (각 영역별 개선 제안, 번호 리스트 형식) ✅
- FR-GYAI5. 피드백 표시: 원본과 개선 제안을 나란히 표시, 각 영역별로 구분 ✅
- FR-GYAI6. 개별 적용 기능: 각 영역별로 "적용하기" 버튼으로 개별 적용 가능 ✅
- FR-GYAI7. 빈 항목 처리: 개선 제안이 없는 영역은 적용 버튼 숨김 ✅
- FR-GYAI8. 레이트리밋: 월 2회 제한 (ai_usage_counters 테이블로 관리, scope: 'yearly_goal_feedback') ✅

### G-1.5 AC (검증됨)
- AC-GYAI1. 피드백 생성 후 원본과 개선 제안이 정확하게 표시됨 ✅
- AC-GYAI2. 각 영역별로 개별 적용 기능 정상 작동 ✅
- AC-GYAI3. 승인 사용자만 가능(RLS + Edge 인증) ✅
- AC-GYAI4. SMART 기준에 맞춰 구체적이고 측정 가능한 개선 제안 제공 ✅
- AC-GYAI5. 레이트리밋 정상 작동 (월 2회 제한) ✅
- AC-GYAI6. 빈 항목 처리: 개선 제안이 없는 영역은 적용 버튼 숨김 ✅

### G-2 월실천계획(직접) FR-GM ✅ 구현 완료
#### 구조 (구현됨)
- **위치**: Goals 탭 (연간 목표 아래)
- **제목**: "월간 실천계획" (그라데이션 배경: 청록/녹색)
- **아이콘**: `calendar-check` (제목)
- **모드**: 보기 모드 / 편집 모드 (토글)
- **토글 기능**: 헤더 제목 옆 토글 버튼으로 내용 접기/펼치기 (기본값: 펼침, 상태 localStorage 저장)
- **부제목**: "2025년 12월 실천 계획 & 결과" (동적, 제목 아래 표시, 글씨 크기 1rem)
- **구분선**: 부제목 아래 헤더 border-bottom으로 구분선 표시
- **월 선택**: 이전/다음 월 이동 버튼, 월 레이블 클릭 시 월 선택 모달 (선택된 연도의 1~12월)
- **"이번 달로" 버튼**: 이번 달이 아닌 월 선택 시 표시되는 버튼
- **3컬럼 레이아웃**:
  - 왼쪽: 연간목표 표시 (linked_year에 해당하는 yearly_goals 조회, 읽기 전용)
  - 가운데: 월실천계획 입력 (plan_content JSONB - self_dev/relationship/work_finance)
  - 오른쪽: 월말 결과 입력 (results_content JSONB - self_dev/relationship/work_finance)
  - 구분선: 1.4px dashed #80E2E2

#### FR-GM (구현됨)
- FR-GM1. 월 선택(`month_start=YYYY-MM-01`) ✅
- FR-GM2. 편집/저장/재조회 ✅
- FR-GM3. 연간목표 연결 방식(고정) ✅
  - `linked_year`에 year만 저장(참조)
  - 연도 선택 시 해당 연도의 yearly_goals 자동 조회하여 왼쪽 컬럼에 표시
  - 월계획 본문은 `plan_content`, `results_content` JSONB에 영역별로 저장
- FR-GM4. 월간 데일리 루틴 저장 ✅
  - `monthly_plans.daily_routines` JSONB 컬럼에 저장
  - 형식: `{ "morning": ["루틴1", "루틴2"], "night": ["루틴3"] }`
- FR-GM5. plan_content JSONB 저장 ✅
  - 형식: `{ "self_dev": "", "relationship": "", "work_finance": "" }`
  - 각 영역별 월실천계획 입력값 저장
- FR-GM6. results_content JSONB 저장 ✅
  - 형식: `{ "self_dev": "", "relationship": "", "work_finance": "" }`
  - 각 영역별 월말 결과 입력값 저장
- FR-GM7. **토글 기능**: 헤더 제목 옆 토글 버튼으로 내용 접기/펼치기 (기본값: 펼침, 상태 localStorage 저장) ✅
- FR-GM8. **부제목 표시**: 제목 아래 부제목 "2025년 12월 실천 계획 & 결과" 표시 (동적, 글씨 크기 1rem) ✅
- FR-GM9. **월 선택 모달**: 월 레이블 클릭 시 모달에서 월 선택 가능 (선택된 연도의 1~12월) ✅
- FR-GM10. **"이번 달로" 버튼**: 이번 달이 아닌 월 선택 시 표시, 클릭 시 현재 월로 이동 ✅
- FR-GM11. **연간목표 연결 자동화**: linked_year는 선택된 월의 연도로 자동 연결 (드롭다운 제거) ✅

### G-2 AC (검증됨)
- AC-GM1. 월별 저장/조회가 기기 간 동일 ✅
- AC-GM2. 연간목표 수정/삭제와 무관하게 월계획이 깨지지 않음(참조는 year 값) ✅
- AC-GM3. linked_year 선택 시 해당 연도의 연간목표가 왼쪽 컬럼에 자동 표시됨 ✅
- AC-GM4. plan_content와 results_content가 각각 독립적으로 저장/조회됨 ✅
- AC-GM5. 토글 기능 정상 작동, 상태가 localStorage에 저장되어 새로고침 후에도 유지 ✅
- AC-GM6. 부제목이 선택된 월에 맞춰 동적으로 업데이트됨 ✅
- AC-GM7. 월 선택 모달에서 선택된 연도의 원하는 월을 쉽게 선택 가능 ✅
- AC-GM8. "이번 달로" 버튼이 이번 달이 아닐 때만 표시되고 정상 작동 ✅
- AC-GM9. 연간목표 연결이 자동으로 처리되어 사용자 편의성 향상 ✅

### G-3 AI 월실천계획 제안 FR-GAI ✅ 구현 완료 (필수: Edge Function)
#### 구조 (구현됨)
- **버튼**: "AI로 제안받기" (월간 실천계획 편집 모드에서 표시)
- **입력**: 
  - 연간목표(해당 year의 yearly_goals)
  - 지난달 실천계획 및 결과(previous month의 monthly_plans)
  - 최근 4주 활동 요약(루틴/할일/성찰 통계)
- **출력 포맷**: JSON 형식 (plan_content JSONB)
  - 각 영역(자기계발/관계/업무재정)별 1-2개 핵심 행동 제안
  - 매우 구체적이고 실행 가능한 계획만 제안
  - 마크다운 없이 일반 텍스트로 저장
- **저장**: `monthly_plans.source='ai_suggested'`, `status='draft'`, `plan_content` JSONB에 저장

#### FR-GAI (구현됨)
- FR-GAI1. "AI로 제안받기" 버튼 클릭 시 Edge Function 호출 ✅
- FR-GAI2. 입력 수집: 연간목표(해당 year), 지난달 실천계획 및 결과, 최근 4주 활동 요약 ✅
- FR-GAI3. AI 프롬프트: 연간목표와 지난달 실천계획/결과, 최근 활동을 종합적으로 고려하여 제안 ✅
- FR-GAI4. 출력 포맷: JSON 형식 (plan_content JSONB, 각 영역별 1-2개 핵심 행동) ✅
- FR-GAI5. 저장 정책: `monthly_plans.source='ai_suggested'`, `status='draft'`, plan_content JSONB 저장 ✅
- FR-GAI6. 재생성 정책: 동일 `user_id + month_start + source='ai_suggested'`는 upsert 덮어쓰기 ✅
- FR-GAI7. 사용자 편집: AI 제안 생성 후 편집 모드에서 수정 가능, 저장 시 manual로 전환 가능 ✅
- FR-GAI8. 사용량 추적: ai_usage_counters 테이블로 관리 (레이트리밋 제한 없음) ✅

### G-3 AC (검증됨)
- AC-GAI1. 생성 결과 저장 후 PC/모바일 동일 조회 ✅
- AC-GAI2. 편집/저장 상태가 기기 간 동일 ✅
- AC-GAI3. 승인 사용자만 가능(RLS + Edge 인증) ✅
- AC-GAI4. 연간목표와 지난달 실천계획/결과, 최근 활동이 AI 제안에 반영됨 ✅
- AC-GAI5. AI 제안이 구체적이고 실행 가능한 1-2개 핵심 행동으로 제안됨 ✅
- AC-GAI6. 사용량 추적 정상 작동 (레이트리밋 제한 없음) ✅

---

## H. 관리자(승인/상태변경)
### FR-H
- FR-H1. pending 사용자 목록 조회
- FR-H2. 승인/거절 처리
- FR-H3. approved 사용자 목록 및 상태 변경(approved→blocked 등)
- FR-H4. Admin만 접근(클라이언트 가드 + RLS)
- FR-H5. 사용자별 사용 기한 설정 (특정 날짜 또는 무제한) - 개별 설정 및 일괄 설정 지원
- FR-H6. 만료된 사용자 접근 제어 - `expires_at < CURRENT_DATE`인 경우 서비스 접근 불가
- FR-H7. 챌린지 참가자 관리 - 승인된 사용자 중에서 챌린지 참가자 추가/제외 (개별/일괄), 챌린지 참가자 목록 조회 및 통계 확인
- FR-H8. 사용 현황 통계 표시 - 승인된 사용자 및 챌린지 참가자 목록에 이번 주 루틴 실행률, 할일 완료율, 성찰 작성일 표시
- FR-H9. 관리자 통계 조회 RLS 정책 - 관리자는 `public.is_admin()` 함수를 통해 다른 사용자의 `todos`, `routines`, `routine_logs`, `daily_reflections` 데이터 조회 가능 (통계 계산용)
- FR-H10. 기한 만료 탭 (2025-01-30 추가) - 기한 만료된 사용자 별도 관리, 일괄 기한 연장 기능
  - 네 번째 탭: "기한 만료 (N명)" (빨간색 테마)
  - 필터링: `status === 'approved' && expires_at < currentDate`
  - 개별 기한 연장: 각 행의 "기한 연장" 버튼
  - 일괄 기한 연장: 여러 사용자 선택 후 일괄 처리 (무제한 또는 특정 날짜)
  - 전체 선택/해제 체크박스 지원

### AC-H (보안 최중요)
- AC-H1. 일반 사용자는 어떤 방식으로도 `profiles.status/role` 변경 불가(RLS)
- AC-H2. 일반 사용자가 admin.html 접근해도 목록 조회 불가(RLS)
- AC-H3. 만료된 사용자는 서비스 접근 불가 (RLS + 클라이언트 가드)
- AC-H4. 사용 기한 설정이 PC/모바일에서 동일하게 반영됨
- AC-H5. 일괄 기한 설정 시 선택된 사용자들에만 적용됨
- AC-H6. 챌린지 참가자 추가/제외 시 사용자 자체는 삭제되지 않음 (is_challenge_participant만 변경)
- AC-H7. 사용 현황 통계는 이번 주(월~일) 기준으로 계산되어 표시됨
- AC-H8. 챌린지 참가자 탭에서도 일괄 제외 기능 사용 가능
- AC-H9. 관리자 통계 조회 정상 작동 - 관리자 페이지에서 모든 승인된 사용자의 이번 주 통계가 정확하게 표시됨 (RLS 정책 `{table}_admin_select_all` 적용) ✅
- AC-H10. 챌린지 참가자 탭 통계 표시 정상 작동 - 챌린지 참가자가 승인된 사용자 탭에도 표시되는 경우, 각 탭에서 올바른 섹션의 DOM 요소를 찾아서 통계를 표시함 (섹션별 querySelector 적용) ✅
- AC-H11. 기한 만료 탭 정상 작동 - 기한 만료된 사용자만 정확히 필터링되어 표시됨 ✅
- AC-H12. 기한 만료 탭 일괄 연장 정상 작동 - 선택된 사용자들의 기한을 일괄 연장 가능 ✅

---

## I. 프로젝트 관리 (Projects) ✅ 구현 완료
### I-0 개요
- **목적**: 연간 목표를 달성하기 위한 구체적인 프로젝트를 관리하고 추적
- **범위**: 프로젝트 생성/관리, 프로젝트별 할일(Tasks) 추적, 일일 할일(Todos)과 연결
- **카테고리 연동**: 연간 목표의 3영역(자기계발/관계/업무재정)과 동일하게 분류
- **카테고리 매핑**: 프로젝트 → 오늘 할일 등록 시
  - `self_dev` → `self_dev` (Growth)
  - `relationship` → `personal` (Personal)
  - `work_finance` → `work` (Work)

### I-1 프로젝트 (Projects) FR-IP ✅ 구현 완료
#### 구조 (구현됨)
- **위치**: 별도 탭 (네비게이션 "계획" 그룹 내)
- **제목**: "프로젝트" (그라데이션 배경: 인디고/청록)
- **아이콘**: `folder-kanban` (제목)
- **UI 구조**: 진행중/완료 탭 분류, 카드 그리드 레이아웃, 아코디언 상세보기
- **카테고리 구분**: 자기계발(self_dev) / 관계(relationship) / 업무재정(work_finance)
- **카테고리 아이콘**: Lucide 아이콘 (`book-open`, `heart`, `briefcase`)
- **헤더 토글**: 토글 버튼 제거 (항상 표시)

#### FR-IP (구현됨)
- FR-IP1. 프로젝트 생성/수정/삭제(Soft Delete) ✅
  - 필수: `name`, `category`
  - Soft Delete: `deleted_at` 타임스탬프
  - 심플한 한 줄 모달 UI
- FR-IP2. 진행중/완료 탭 분류 ✅
  - 모든 할일 완료 시 "완료" 탭으로 이동
  - "다시 진행하기" 버튼으로 진행중으로 복귀
- FR-IP3. 프로젝트 목록 조회 (deleted_at IS NULL) ✅
- FR-IP4. 프로젝트별 진행률 표시 (완료 Tasks / 전체 Tasks) ✅
  - 진행바 + 퍼센트 표시

### I-2 프로젝트 할일 (Project Tasks) FR-IPT ✅ 구현 완료
#### 구조 (구현됨)
- **위치**: 프로젝트 카드 클릭 시 아코디언 확장
- **구성**: 프로젝트당 0~N개의 Tasks
- **수동 순서 변경**: `display_order` 컬럼으로 사용자 정의 순서 지원
- **인라인 편집**: 클릭하여 바로 수정, Enter로 저장

#### FR-IPT (구현됨)
- FR-IPT1. Task 생성/수정/삭제(Soft Delete) ✅
  - 필수: `title`, `project_id`
  - 선택: `start_date`, `end_date`, `due_date`, `is_done`, `display_order`
  - Enter 키로 빠른 등록, 자동 포커스 유지
- FR-IPT2. Task 완료/미완료 토글 (`is_done`, `done_at`) ✅
- FR-IPT3. Task 수동 순서 변경 (`display_order`) ✅
  - 위/아래 화살표 버튼
  - 인덱스 기반 재할당 방식 `(인덱스 + 1) * 10`
- FR-IPT4. 날짜 설정 (flatpickr 달력) ✅
  - 캘린더 아이콘 클릭으로 날짜 범위 선택
  - **시작일/종료일 방식 (신)**: `start_date`, `end_date` 설정
  - **마감일 방식 (구)**: 기존 `due_date` 하위 호환성 유지
  - 즉시 적용
- FR-IPT5. 일괄 등록 기능 ✅
  - "오늘 할일 등록하기" 버튼으로 시작일~종료일 범위의 모든 날짜에 할일 생성
  - 중복 체크: 이미 등록된 (날짜, task_id) 조합은 스킵
  - 성능 최적화: bulk query로 모든 날짜 한 번에 체크 (N+1 문제 해결)
  - 동시 실행 방지: `registeringProjectTasks` 플래그
  - UI 피드백: 버튼 비활성화 및 "등록 중..." 표시

### I-3 통합 기능 FR-IPI ✅ 구현 완료
#### FR-IPI (구현됨)
- FR-IPI1. 프로젝트 → Task → Todo 연결 흐름 ✅
  - "오늘 할일 등록하기" 버튼으로 시작일~종료일 (또는 마감일) 기준 Todo 생성
  - Todo에 `project_task_id` 저장하여 출처 추적
  - 중복 등록 방지: 이미 등록된 (날짜, task_id) 조합은 스킵 (bulk query)
  - 하위 호환성: `start_date/end_date` 방식(신)과 `due_date` 방식(구) 모두 지원
- FR-IPI2. 양방향 동기화 ✅
  - **프로젝트 Task 완료 → 연결된 Todo 완료** (2025-02-02 추가)
  - **Todo 완료 → 연결된 Project Task 완료** (모든 연결 Todo 완료 시)
  - **이월된 원본 할일 제외**: `carried_over_at`이 기록된 할일은 동기화 체크에서 제외
  - **포기된 원본 할일 제외**: `skipped_at`이 기록된 할일은 동기화 체크에서 제외
  - 제목 수정 시 양방향 동기화
  - 동기화 플래그로 무한 루프 방지 (`syncingTodo`, `syncingProjectTask`)
- FR-IPI3. Carry-over 연동 ✅
  - 프로젝트 Task 연결된 미완료 Todo도 이월 대상
  - 이월 시 `project_task_id` 유지
  - **이월 시 중복 체크 강화** (2025-02-02 추가):
    - `carried_over_at`, `skipped_at` 조건 추가하여 정확한 중복 판단
    - 시작일~종료일로 미리 등록된 경우, 이월 시 "이미 등록됨" 처리 (중복 생성 방지)
  - **이월 시 end_date 자동 연장** (2025-02-02 추가):
    - Project Task의 `end_date` (또는 `due_date`)를 오늘로 연장
    - 프로젝트 일정이 실제 작업 진행 상황과 자동 일치
- FR-IPI4. 날짜 이동 동기화 ✅
  - 오늘 탭에서 Todo 날짜 이동 시 Project Task `end_date` (또는 `due_date`) 동기화 (2025-02-02 업데이트)
  - 프로젝트 할일의 일정이 최신 날짜로 자동 업데이트
- FR-IPI5. 포기 처리 ✅
  - 오늘 탭에서 Todo 포기 시 `skipped_at` 기록 (2025-02-02 업데이트: `due_date` 수정 제거)
  - Project Task의 `due_date`는 할일의 본질적 마감일이므로 포기 시에도 유지
- FR-IPI6. 프로젝트 진행률 추적 ✅
  - 완료 Tasks / 전체 Tasks 비율 표시
  - 프로젝트 카드에 진행바 표시
- FR-IPI7. 프로젝트 삭제 시 동기화 ✅
  - 프로젝트 삭제 시 연결된 todos도 soft delete (반복업무와 동일하게)
  - 오늘 탭 자동 새로고침으로 삭제된 할일 즉시 반영
  - 에러 처리 및 로깅 강화
- FR-IPI8. 프로젝트 할일 삭제 시 동기화 ✅
  - 프로젝트 할일 삭제 시 연결된 todos도 soft delete (반복업무와 동일하게)
  - `project_task_id`를 NULL로 설정하는 대신 todos를 soft delete하여 오늘할일에서도 삭제됨
  - 오늘 탭 자동 새로고침으로 삭제된 할일 즉시 반영
  - 에러 처리 및 로깅 강화
  - 에러 처리 및 로깅 강화

### AC-I (검증됨)
- AC-IP1. PC/모바일 동일 프로젝트 목록 조회 ✅
- AC-IP2. Soft Delete 정책으로 삭제된 프로젝트 숨김 ✅
- AC-IP3. 프로젝트 삭제 시 관련 Tasks도 CASCADE 삭제 ✅
- AC-IP4. 프로젝트 삭제 시 연결된 todos도 soft delete됨 ✅
- AC-IPT1. Task 순서 변경 시 인덱스 기반 재할당 정상 작동 ✅
- AC-IPT2. Todo에서 연결된 Task 정보 확인 가능 ✅
- AC-IPT3. 시작일/종료일 설정 정상 작동 (flatpickr 모달) ✅
- AC-IPT4. 일괄 등록 시 시작일~종료일 범위의 모든 날짜에 정확히 등록됨 ✅
- AC-IPT5. 중복 등록 방지 정상 작동 (bulk query로 성능 최적화) ✅
- AC-IPT6. 하위 호환성: 기존 `due_date` 방식도 정상 표시 및 등록 ✅
- AC-IPI1. 프로젝트 진행률이 실시간 업데이트됨 ✅
- AC-IPI2. 양방향 동기화 정상 작동 (무한 루프 없음) ✅
- AC-IPI3. 프로젝트 Task 완료 시 연결된 todos도 모두 완료됨 ✅
- AC-IPI4. Todo 완료 시 모든 연결 todos 완료되면 프로젝트 Task도 완료됨 ✅
- AC-IPI5. 이월된 프로젝트 할일 동기화 정상 작동 ✅
  - 이월된 원본 할일(`carried_over_at` 기록됨)은 동기화 체크에서 제외되어, 오늘 탭에서 새로 생성된 할일 완료 시 프로젝트 할일도 정상적으로 완료 처리됨
- AC-IPI6. 이월 시 중복 체크 정상 작동 ✅
  - 시작일~종료일로 미리 등록된 경우, 이월 시 "이미 등록됨" 처리되어 중복 생성되지 않음
- AC-IPI7. 이월 시 end_date 자동 연장 정상 작동 ✅
  - 프로젝트 할일의 `end_date` (또는 `due_date`)가 오늘로 자동 연장됨
- AC-IPI8. 날짜 이동 시 end_date 동기화 정상 작동 ✅
  - Todo 날짜 이동 시 프로젝트 할일의 `end_date` (또는 `due_date`)도 새 날짜로 업데이트됨
- AC-IPI9. 포기 시 due_date 유지 정상 작동 ✅
  - 포기 시 `due_date`는 변경되지 않고 본질적 마감일 유지
- AC-IPI10. 프로젝트 할일 삭제 시 연결된 todos도 오늘할일에서 삭제됨 ✅

---

## J. 반복업무 관리 (Recurring Tasks) ✅ 구현 완료
### J-0 개요
- **목적**: 반복되는 할일을 설정하고 자동으로 오늘 할일로 등록
- **범위**: 반복업무 생성/삭제, 반복 주기 설정, 오늘 할일 일괄 등록
- **카테고리**: Work, Job, Growth, Personal (할일 카테고리와 동일)

### J-1 반복업무 (Recurring Tasks) FR-JR ✅ 구현 완료
#### 구조 (구현됨)
- **위치**: 별도 탭 (네비게이션 "계획" 그룹 내)
- **제목**: "반복업무" (그라데이션 배경: 보라색/핑크)
- **아이콘**: `repeat` (제목)
- **UI 구조**: 카드 그리드 레이아웃 (프로젝트와 동일한 형식)
  - `display: grid`, `grid-template-columns: repeat(auto-fill, minmax(280px, 1fr))`
  - 카드 내부: 아이콘 + 제목 상단, 카테고리 배지, 반복 주기/날짜 범위, 오늘 할일 등록 버튼 하단
  - 카테고리별 아이콘 표시 (briefcase, clipboard-list, book-open, home)
- **카테고리 구분**: Work / Job / Growth / Personal
- **헤더 토글**: 토글 버튼 제거 (항상 표시)

#### FR-JR (구현됨)
- FR-JR1. 반복업무 생성/삭제(Soft Delete) ✅
  - 필수: `title`, `category`, `repeat_type`, `repeat_config`, `start_date`
  - 선택: `end_date` (없으면 3개월 후까지 자동 등록)
  - Soft Delete: `deleted_at` 타임스탬프
- FR-JR2. 반복 주기 설정 ✅
  - `daily`: 매일 (월~일)
  - `weekdays`: 주중 매일 (월~금)
  - `weekends`: 매주 주말 (토, 일)
  - `weekly`: 매주 특정 요일 (예: 매주 월요일)
  - `monthly`: 매월 특정 날짜 (예: 매월 20일)
- FR-JR3. 시작일/종료일 설정 ✅
  - 시작일: 필수
  - 종료일: 선택 (없으면 3개월 후까지 자동 등록)
- FR-JR4. 반복업무 목록 조회 (deleted_at IS NULL) ✅
- FR-JR5. 카드 그리드 UI 레이아웃 ✅
  - 프로젝트와 동일한 카드 그리드 형식으로 표시
  - 카드 내부 구조: 아이콘 + 제목 상단, 카테고리 배지, 반복 주기/날짜 범위 하단
  - 삭제 버튼 상단 우측 배치 (수정 기능 제거)

### J-2 오늘 할일 등록 FR-JT ✅ 구현 완료
#### FR-JT (구현됨)
- FR-JT1. "오늘 할일 등록하기" 버튼 클릭 시 일괄 등록 ✅
  - 시작일부터 종료일까지 모든 해당 날짜에 할일 생성
  - 반복 주기에 맞는 날짜만 등록 (예: 주중 매일이면 월~금만)
  - 종료일 없으면 시작일 기준 3개월 후까지 자동 계산
- FR-JT2. 중복 체크 ✅
  - 이미 등록된 날짜는 스킵
  - 동시 실행 방지 플래그로 중복 등록 방지
- FR-JT3. 반복업무 배지 표시 ✅
  - 오늘 할일에서 `recurring_task_id`가 있는 할일에 "반복업무" 배지 표시
- FR-JT4. 삭제 시 동기화 ✅
  - 반복업무 삭제 시 연결된 할일도 soft delete
- FR-JT5. 이벤트 리스너 중복 방지 ✅
  - 기존 이벤트 리스너 제거 후 재등록
  - 동시 실행 방지 플래그

### J-1 AC (검증됨)
- AC-JR1. PC/모바일 동일 반복업무 목록 조회 ✅
- AC-JR2. Soft Delete 정책으로 삭제된 반복업무 숨김 ✅
- AC-JR3. 반복 주기별 정확한 날짜 계산 ✅
- AC-JR4. 종료일 없을 때 3개월 후까지 자동 등록 ✅
- AC-JR5. 카드 그리드 UI 레이아웃 정상 표시 (프로젝트와 일관된 디자인) ✅
- AC-JT1. 일괄 등록 시 모든 해당 날짜에 정확히 등록됨 ✅
- AC-JT2. 중복 등록 방지 정상 작동 ✅
- AC-JT3. 반복업무 배지 정상 표시 ✅
- AC-JT4. 삭제 시 연결된 할일도 함께 삭제됨 ✅
- AC-JT5. 이벤트 리스너 중복 등록 방지 정상 작동 ✅

---

# 9. 비기능 요구사항(NFR)

## 9.1 동기화/일관성
- NFR-S1. 모든 변경은 DB에 즉시 반영(성공/실패 UI로 명시)
- NFR-S2. 새로고침/재접속 시 최신 데이터를 재조회
- NFR-S3(선택). Supabase Realtime로 today 화면 자동 동기화(기본은 새로고침)

## 9.2 충돌 정책
- NFR-C1. 동시 수정은 last-write-wins(서버 updated_at 최종값)
- NFR-C2. carry-over 복제는 새 ID 생성으로 충돌 방지
- NFR-C3. 루틴 변경 시 Soft Delete 적용: `DELETE` 대신 `UPDATE is_active = false, deleted_at = NOW()` (과거 체크 기록 보존)

## 9.3 AI 보안/비용/사용량 추적
- NFR-AI1. AI 키는 Edge Function 환경변수로만 보관
- NFR-AI2. 저장: model/prompt_version 필수
- NFR-AI3. 사용량 추적 (레이트리밋 제한 없음, 2025-01-30 변경)
  - 모든 AI 기능: 레이트리밋 제한 없음 (언제든지 사용 가능)
  - 사용량 추적: `ai_usage_counters` 테이블로 카운트(upsert)하여 통계 관리
  - 적용 기능: 주간/월간/연간 AI 성찰, AI 연간 목표 피드백, AI 월실천계획 제안
- NFR-AI4. 실패 시 사용자에게 재시도 버튼 제공(서버는 부분 저장 금지)

## 9.4 성능/호환성
- NFR-P1. 모바일 Chrome/Safari에서 핵심 작업 300ms~1s 내 체감 동작(네트워크 제외)
- NFR-P2. 리포트 쿼리는 서버(view/function) 중심

---

# 10. 데이터 모델(Supabase/Postgres) — 확정 스키마

## 10.1 Enum(권장: CHECK 제약으로 구현 가능)
- profiles.status: pending/approved/rejected/blocked
- profiles.role: user/admin
- monthly_plans.source: manual/ai_suggested
- monthly_plans.status: draft/accepted/archived
- todos.category: work/job/self_dev/personal

## 10.2 테이블(필수)
### profiles
- id uuid PK (auth.users.id)
- email text
- name text
- avatar_url text
- status text not null default 'pending'
- role text not null default 'user'
- timezone text not null default 'Asia/Seoul'
- expires_at date                                    -- 사용 기한 만료일 (NULL이면 무제한 사용 가능)
- is_challenge_participant boolean not null default false  -- 챌린지 참가 여부
- created_at timestamptz not null default now()
- updated_at timestamptz not null default now()

### projects
- id uuid PK default gen_random_uuid()
- user_id uuid not null FK → profiles(id) ON DELETE CASCADE
- name text not null
- category text not null CHECK (category IN ('self_dev', 'relationship', 'work_finance'))
- created_at timestamptz not null default now()
- updated_at timestamptz not null default now()
- deleted_at timestamptz
- 인덱스: (user_id) WHERE deleted_at IS NULL

### project_tasks
- id uuid PK default gen_random_uuid()
- project_id uuid not null FK → projects(id) ON DELETE CASCADE
- user_id uuid not null FK → profiles(id) ON DELETE CASCADE
- title text not null
- start_date date                             -- 시작일 (신규, 2025-02-02 추가)
- end_date date                               -- 종료일 (신규, 2025-02-02 추가)
- due_date date                               -- 마감일 (기존, 하위 호환성 유지)
- is_done boolean not null default false
- done_at timestamptz
- display_order integer                       -- 수동 순서 변경 (NULL 허용)
- created_at timestamptz not null default now()
- updated_at timestamptz not null default now()
- deleted_at timestamptz
- 인덱스: (project_id) WHERE deleted_at IS NULL, (user_id) WHERE deleted_at IS NULL, (project_id, display_order NULLS LAST) WHERE deleted_at IS NULL, (start_date, end_date) WHERE deleted_at IS NULL AND start_date IS NOT NULL

### todos
- id uuid PK default gen_random_uuid()
- user_id uuid not null FK → profiles(id)
- date date not null                       -- "오늘 화면 기준 날짜"
- category text not null default 'work'
- title text not null
- memo text
- due_date date
- priority int                              -- 1~3 (선택)
- pinned boolean not null default false
- is_done boolean not null default false
- done_at timestamptz
- carried_over_at timestamptz               -- carry-over 처리 시 원본에 기록
- skipped_at timestamptz                    -- 포기 처리 시 원본에 기록
- deleted_at timestamptz
- display_order integer                     -- 수동 순서 변경 (같은 완료 상태 내에서만 적용, NULL 허용)
- project_task_id uuid FK → project_tasks(id) ON DELETE SET NULL  -- 프로젝트 Task 연결 (선택)
- recurring_task_id uuid FK → recurring_tasks(id) ON DELETE SET NULL  -- 반복업무 연결 (선택)
- created_at timestamptz not null default now()
- updated_at timestamptz not null default now()
- 인덱스: (user_id, date), (user_id, date, category), (user_id, deleted_at), (user_id, skipped_at), (user_id, date, category, display_order NULLS LAST) WHERE deleted_at IS NULL, (project_task_id) WHERE project_task_id IS NOT NULL, (recurring_task_id) WHERE recurring_task_id IS NOT NULL

### routines
- id uuid PK default gen_random_uuid()
- user_id uuid not null FK → profiles(id)
- title text not null
- schedule jsonb not null
  - **monthly**: `{ "type":"monthly", "month":"YYYY-MM-01", "source":"monthly_goal", "category":"morning"|"night", "order":0, "active_from_date":"YYYY-MM-DD" }` (월간 데일리 루틴)
    - `active_from_date`: 루틴 적용 시작일 (YYYY-MM-DD). 새로 생성된 루틴에만 존재. 기존 루틴은 `created_at` 기준으로 판단
  - daily/weekly: 스키마는 정의되어 있으나 현재 미사용
- is_active boolean not null default true
- deleted_at timestamptz
- created_at timestamptz not null default now()
- updated_at timestamptz not null default now()
- 인덱스: (user_id, is_active), (user_id, is_active) WHERE deleted_at IS NULL
- **Soft Delete 정책**: 루틴 변경 시 `DELETE` 대신 `UPDATE is_active = false, deleted_at = NOW()` (과거 체크 기록 보존)
  - **날짜 기준 필터링**: `fetchRoutines`에서는 `is_active` 조건 없이 모든 루틴 조회, `isRoutineDue`에서 날짜 기준으로 필터링하여 선택 날짜에 해당하는 루틴만 표시

### routine_logs
- id uuid PK default gen_random_uuid()
- user_id uuid not null FK → profiles(id)
- routine_id uuid not null FK → routines(id)
- date date not null
- checked boolean not null default true
- created_at timestamptz not null default now()
- updated_at timestamptz not null default now()
- UNIQUE(user_id, routine_id, date)
- 인덱스: (user_id, date)

### daily_reflections
- id uuid PK default gen_random_uuid()
- user_id uuid not null FK → profiles(id)
- date date not null
- grateful text
- well_done text
- regret text
- tomorrow_promise text
- created_at timestamptz not null default now()
- updated_at timestamptz not null default now()
- UNIQUE(user_id, date)

### yearly_goals
- id uuid PK default gen_random_uuid()
- user_id uuid not null FK → profiles(id)
- year int not null
- self_dev text
- relationship text
- work_finance text
- created_at timestamptz not null default now()
- updated_at timestamptz not null default now()
- UNIQUE(user_id, year)

### monthly_plans
- id uuid PK default gen_random_uuid()
- user_id uuid not null FK → profiles(id)
- month_start date not null                 -- YYYY-MM-01
- linked_year int                            -- 연간목표 연결 (year 값만 저장)
- source text not null                      -- manual/ai_suggested
- status text not null default 'draft'      -- draft/accepted/archived
- content_md text not null default ''        -- 기존 마크다운 본문 (하위 호환성 유지)
- plan_content jsonb default '{"self_dev":"","relationship":"","work_finance":""}'  -- 월실천계획 (영역별) (구현됨)
- results_content jsonb default '{"self_dev":"","relationship":"","work_finance":""}'  -- 월말 결과 (영역별) (구현됨)
- daily_routines jsonb default '{"morning":[],"night":[]}'  -- 월간 데일리 루틴 (구현됨)
- model text                                 -- AI 생성 시 모델명 (AI 제안용)
- prompt_version text                        -- AI 생성 시 프롬프트 버전 (AI 제안용)
- created_at timestamptz not null default now()
- updated_at timestamptz not null default now()
- UNIQUE(user_id, month_start, source)
- 인덱스: (user_id, month_start), GIN(daily_routines), GIN(plan_content), GIN(results_content)

### weekly_ai_reflections
- id uuid PK default gen_random_uuid()
- user_id uuid not null FK → profiles(id)
- week_start date not null
- week_end date not null
- content_md text not null
- model text not null
- prompt_version text not null
- created_at timestamptz not null default now()
- updated_at timestamptz not null default now()
- UNIQUE(user_id, week_start)

### monthly_ai_reflections
- id uuid PK default gen_random_uuid()
- user_id uuid not null FK → profiles(id)
- month_start date not null
- content_md text not null
- model text not null
- prompt_version text not null
- created_at timestamptz not null default now()
- updated_at timestamptz not null default now()
- UNIQUE(user_id, month_start)

### yearly_ai_reflections
- id uuid PK default gen_random_uuid()
- user_id uuid not null FK → profiles(id)
- year int not null
- content_md text not null
- model text not null
- prompt_version text not null
- created_at timestamptz not null default now()
- updated_at timestamptz not null default now()
- UNIQUE(user_id, year)

### recurring_tasks (반복업무)
- id uuid PK default gen_random_uuid()
- user_id uuid not null FK → profiles(id) ON DELETE CASCADE
- category text not null CHECK (category IN ('work', 'job', 'self_dev', 'personal'))
- title text not null
- repeat_type text not null CHECK (repeat_type IN ('daily', 'weekdays', 'weekends', 'weekly', 'monthly'))
- repeat_config jsonb not null              -- daily/weekdays/weekends: {}, weekly: { "day_of_week": 1 } (0=일요일, 1=월요일, ..., 6=토요일), monthly: { "day_of_month": 20 } (1~31)
- start_date date not null
- end_date date                             -- NULL 허용 (없으면 3개월 후까지 자동 등록)
- created_at timestamptz not null default now()
- updated_at timestamptz not null default now()
- deleted_at timestamptz
- 인덱스: (user_id) WHERE deleted_at IS NULL

### ai_usage_counters (레이트리밋)
- id uuid PK default gen_random_uuid()
- user_id uuid not null FK → profiles(id)
- scope text not null                       -- weekly_reflection / monthly_reflection / yearly_reflection / monthly_plan / yearly_goal_feedback
- period_key text not null                  -- 예: 2025-W49, 2025-12, 2025
- count int not null default 0
- created_at timestamptz not null default now()
- updated_at timestamptz not null default now()
- UNIQUE(user_id, scope, period_key)

---

# 11. RLS(필수) — 승인/사용자 격리 강제

## 11.1 공통 승인 체크 SQL(개념)
- approved 조건:
  - EXISTS(SELECT 1 FROM profiles p WHERE p.id = auth.uid() AND p.status='approved' AND (p.expires_at IS NULL OR p.expires_at >= CURRENT_DATE))
  - 함수: `public.is_user_approved()` 사용 권장

## 11.2 profiles 정책
- SELECT: 본인 1행만 허용
- UPDATE:
  - 본인: `timezone`, `name` 정도만 허용(선택)
  - `status`, `role` 변경: **admin만 허용**
- INSERT: auth 트리거로만 생성(클라이언트 직접 INSERT 금지)

## 11.3 사용자 데이터 테이블(todos/routines/logs/reflections/goals/plans/projects/project_tasks/ai 결과)
- SELECT/INSERT/UPDATE/DELETE:
  - row.user_id = auth.uid()
  - AND approved 조건
- **관리자 예외 (SELECT만)**:
  - 관리자는 `public.is_admin()` 함수를 통해 모든 사용자의 데이터 조회 가능
  - 적용 테이블: `todos`, `routines`, `routine_logs`, `daily_reflections` (관리자 페이지 통계 조회용)
  - 정책명: `{table}_admin_select_all` (예: `todos_admin_select_all`)

## 11.4 프로젝트 관련 테이블 정책 (추가)
- projects: 본인 프로젝트만 CRUD, approved 조건 필수
- project_tasks: 본인 Tasks만 CRUD, approved 조건 필수
- 삭제: CASCADE (projects 삭제 시 관련 Tasks 자동 삭제)
- todos.project_task_id: SET NULL (Task 삭제 시 연결만 해제, Todo는 유지)

## 11.5 반복업무 관련 테이블 정책 (추가)
- recurring_tasks: 본인 반복업무만 CRUD, approved 조건 필수
- 삭제: Soft Delete (deleted_at 타임스탬프)
- todos.recurring_task_id: SET NULL (반복업무 삭제 시 연결만 해제, Todo는 유지)

## 11.6 ai_usage_counters 정책 ✅ 2025-12-30 수정
- **SELECT**: 본인 데이터만 조회 가능 (`user_id = auth.uid()`)
- **INSERT**: 본인 데이터만 생성 가능 (`user_id = auth.uid()`) ✅ 추가
- **UPDATE**: 본인 데이터만 수정 가능 (`user_id = auth.uid()`) ✅ 추가
- **ALL (service_role)**: 관리자는 모든 권한

**변경 이력**:
- **2025-12-30**: INSERT/UPDATE 정책 추가
  - **문제**: Edge Function에서 AI 사용 카운터 증가 안 됨 (upsert 실패)
  - **원인**: authenticated role에 SELECT만 허용, INSERT/UPDATE 권한 없음
  - **해결**: INSERT/UPDATE 정책 추가하여 Edge Function이 카운터 증가 가능하도록 수정
  - **영향**: 프론트엔드는 SELECT만 사용하므로 기존 기능 영향 없음
  - **테스트**: AI 피드백, 주간/월간/연간 성찰 레이트리밋 정상 작동 확인
  - **적용 방법**: Supabase SQL Editor에서 `fix_complete.sql` 실행 (배포 불필요, DB 레벨 변경으로 즉시 반영)

---

# 12. Edge Function(필수) — AI 생성 API 계약
> AI 호출은 반드시 Edge Function에서 수행(비밀키 보호 + 원자적 저장).

## 12.1 공통 규칙
- 인증: Supabase JWT(Authorization Bearer) 필수
- 승인 체크: profiles.status=approved 아니면 403
- 사용량 추적: ai_usage_counters로 scope/period_key 카운트 증가 (레이트리밋 제한 없음, 통계 관리용)
- 저장 원자성: "모델 호출 성공 → DB upsert 저장"을 단일 흐름으로 보장(부분 저장 금지)

## 12.2 Functions 목록(권장 이름)
1) `POST /functions/v1/ai-weekly-reflection` ✅ 구현 완료
- body: { "week_start":"YYYY-MM-DD" }  (필수)
- server:
  - week_end = week_start + 6일
  - 해당 기간 통계/텍스트 요약 생성(길이 제한: 총 6,000자 권장)
  - 모델 호출 (Gemini API, gemini-2.5-flash, maxOutputTokens: 8000)
  - weekly_ai_reflections upsert(user_id, week_start)
- response: { "content_md":"...", "week_start":"...", "week_end":"...", "model":"...", "prompt_version":"..." }
- 구현 상태: ✅ 배포 완료, Gemini API 연동, 토큰 제한 8000, 마크다운 저장, 사용량 추적 (레이트리밋 제한 없음)

2) `POST /functions/v1/ai-monthly-reflection` ✅ 구현 완료
- body: { "month_start":"YYYY-MM-01" }  (필수)
- server:
  - month_end = 해당 월의 마지막 날 계산 (28~31일)
  - 해당 기간 통계/텍스트 요약 생성(길이 제한: 총 1,500자 권장)
  - 모델 호출 (Gemini API, gemini-2.5-flash, maxOutputTokens: 8000)
  - monthly_ai_reflections upsert(user_id, month_start)
- response: { "content_md":"...", "month_start":"...", "model":"...", "prompt_version":"..." }
- 구현 상태: ✅ 배포 완료, Gemini API 연동, 토큰 제한 8000, 마크다운 저장, 사용량 추적 (레이트리밋 제한 없음)

3) `POST /functions/v1/ai-yearly-reflection` ✅ 구현 완료
- body: { "year": 2025 } (필수)
- server:
  - 해당 연도(1월~12월) 통계 수집 (할일/루틴/성찰)
  - 연간 목표 조회 (yearly_goals)
  - 월별 실천계획 및 결과 요약 생성 (monthly_plans, 최대 3000자)
  - 모델 호출 (Gemini API, gemini-2.5-flash, maxOutputTokens: 8000)
  - yearly_ai_reflections upsert(user_id, year)
- response: { "content_md":"...", "year": 2025, "model":"...", "prompt_version":"..." }
- 구현 상태: ✅ 배포 완료, Gemini API 연동, 토큰 제한 8000, 마크다운 저장, 사용량 추적 (레이트리밋 제한 없음), CORS 헤더 수정 완료

4) `POST /functions/v1/ai-monthly-plan` ✅ 구현 완료
- body: { "month_start":"YYYY-MM-01", "linked_year": 2025 } (필수)
- server:
  - 연간목표(해당 year), 지난달 실천계획 및 결과, 최근 4주 활동 요약 수집
  - 모델 호출 (Gemini API, gemini-2.5-flash, maxOutputTokens: 8000)
  - JSON 형식 응답 파싱 및 plan_content JSONB 저장
  - monthly_plans upsert(user_id, month_start, source='ai_suggested') status='draft'
- response: { "plan_content": {...}, "month_start":"...", "model":"...", "prompt_version":"..." }
- 구현 상태: ✅ 배포 완료, Gemini API 연동, 토큰 제한 8000, JSON 저장, 사용량 추적 (레이트리밋 제한 없음)

5) `POST /functions/v1/ai-yearly-goal-feedback` ✅ 구현 완료
- body: { "year": 2025, "self_dev": "...", "relationship": "...", "work_finance": "..." } (필수)
- server:
  - 입력 검증: 최소 1개 영역에 내용이 있어야 함
  - 모델 호출 (Gemini API, gemini-2.5-flash, maxOutputTokens: 4000, responseMimeType: 'application/json')
  - SMART 기준에 맞춰 개선 제안 생성
  - JSON 형식 응답 파싱 (각 영역별 개선 제안)
  - 레이트리밋 카운터 증가 (scope: 'yearly_goal_feedback')
  - DB 저장 없이 피드백만 반환 (사용자가 직접 저장)
- response: { "success": true, "year": 2025, "feedback": { "self_dev": "...", "relationship": "...", "work_finance": "..." }, "model": "...", "prompt_version": "..." }
- 구현 상태: ✅ 배포 완료, Gemini API 연동, 토큰 제한 4000, JSON 응답, 사용량 추적 (레이트리밋 제한 없음)

## 12.3 Prompt Versioning(필수)
- prompt_version 예: `weekly_reflection_v1`, `monthly_plan_v1`
- 문구 변경 시 버전 상승(데이터 재현성 확보)

---

# 13. 구현 가이드(개발 시 혼선 방지 규칙)
## 13.1 날짜 계산
- 클라이언트는 `profiles.timezone`을 읽은 후 화면 상 “today/week/month 키”를 계산
- 권장 라이브러리(가벼움): Luxon(타임존 지원)
- DB에는 date(YYYY-MM-DD)로 저장

## 13.2 조회 패턴(권장)
- todos(today): user_id=auth.uid AND date=today AND deleted_at IS NULL ORDER BY (정렬 규칙 고정)
- carry-over 대상: date < today AND is_done=false AND deleted_at IS NULL AND carried_over_at IS NULL AND skipped_at IS NULL
- routines(active): user_id=auth.uid AND is_active=true AND deleted_at IS NULL
- routine_logs(today): user_id=auth.uid AND date=today
- monthly_plans(current): user_id=auth.uid AND month_start=YYYY-MM-01

## 13.3 Realtime(선택)
- v1 기본: 새로고침 기반
- v1.1+: today 화면에 한해 todos/routine_logs/daily_reflections 구독

---

# 14. 테스트 체크리스트(릴리즈 게이트)
- [ ] 동일 계정 PC/모바일 로그인 후 동일 데이터 조회
- [ ] pending 사용자는 어떤 테이블도 CRUD 불가(콘솔 호출 포함)
- [ ] Admin 승인 후 사용자 즉시 이용 가능
- [ ] user A가 user B 데이터 조회/수정 불가(RLS)
- [ ] todos 정렬이 기기별 동일(동일 기준일/카테고리)
- [ ] carry-over 모달: 대상 있을 때만, 동일 기기 당일 1회, 이어가기 후 재노출 없음
- [ ] AI 생성 실패 시 DB 부분 저장 없음 + UI 실패 안내
- [ ] 타임존 경계(23:59~00:01)에서 today/week/month 기준 흔들림 없음

---

# 부록 A. Supabase SQL (스키마 + 트리거 + RLS) — 그대로 적용 가능한 기준안
> 실제 적용 시 Supabase 프로젝트의 SQL Editor에서 순서대로 실행합니다.

---

# 부록 B. UI 디자인 가이드 (Design System)
> 2025-12-07 구현 완료, 2025-12-08 업데이트, 2025-12-09 최종 업데이트

## B1) 디자인 원칙
- **일관성**: 모든 아이콘은 Lucide 아이콘 사용
- **접근성**: 색상 + 아이콘 + 텍스트로 3중 구분
- **반응형**: PC/모바일 동일한 경험
- **부드러움**: 파스텔 톤 + 그라데이션
- **레이아웃**: 중앙 정렬, 균등 분배

## B2) 색상 시스템 ✅ 2025-01-21 업데이트

### 프리미엄 색상 팔레트 (CSS 변수)
```css
/* Primary 색상 - 더 깊고 차분한 톤 */
--primary-blue: #5B5FC7;      /* 기존 #6366f1 → 더 깊은 인디고 */
--primary-purple: #9284BE;    /* 기존 #a78bfa → 더 차분한 라벤더 */
--primary-gradient: linear-gradient(135deg, #5B5FC7 0%, #8B7AB8 100%);

/* 카테고리 색상 - 약간 더 성숙한 톤 */
--work-primary: #F59E42;      /* 기존 #fb923c → 차분한 오렌지 */
--work-secondary: #E8922E;
--job-primary: #22C7DD;       /* 기존 #22d3ee → 차분한 시안 */
--job-secondary: #1AACBE;
--growth-primary: #9B8CD9;    /* 기존 #a78bfa → 더 차분한 보라 */
--growth-secondary: #8678C7;
--personal-primary: #E66BA4;  /* 기존 #f472b6 → 차분한 핑크 */
--personal-secondary: #D65590;
```

### 카테고리 색상 (업데이트됨)
| 카테고리 | 메인 색상 | 그라데이션 (120deg) | 배경 | 보더 | Lucide 아이콘 |
|---------|----------|-------------------|------|------|---------------|
| Work | #F59E42 | #F59E42 → #E8922E | #fff7e6 | #f5d38f | `briefcase` |
| Job | #22C7DD | #22C7DD → #1AACBE | #e7f8ff | #b5e6ff | `clipboard-list` |
| Growth | #9B8CD9 | #9B8CD9 → #8678C7 | #f4e9ff | #d8c7ff | `book-open` |
| Personal | #E66BA4 | #E66BA4 → #D65590 | #ffe9f0 | #f8c7d6 | `home` |

**그라데이션 각도**: 카테고리 탭은 120deg (기본 135deg보다 더 부드러운 각도)

### 섹션별 색상 (업데이트됨)
| 섹션 | 배경 그라데이션 | 보더 | 아이콘 배경 | 아이콘 |
|---|---|---|---|---|
| 앱 헤더 | 160deg: #f4f4f5 → #fafafa | #e5e7eb | - | `sparkles` |
| 오늘 루틴 | #e0f7f4 → #f0fdf4 | #14b8a6 | #14b8a6 → #10b981 | `target` |
| 오늘 할일 | #eef2ff → #f5f3ff | #5B5FC7 | #5B5FC7 → #8B7AB8 | `list-checks` |
| 월간 데일리 루틴 | #f0e7ff → #fce7f3 | #9B8CD9 | #9B8CD9 → #8678C7 | `repeat` |
| 하루 성찰 | #f3e8ff → #fce7f3 | #9B8CD9 | #9B8CD9 → #8678C7 | `pen-square` |

**그라데이션 각도 다양화**: 헤더 160deg (더 부드러운 각도), 카드는 135deg 유지

### 상태 색상
| 상태 | 색상 | 용도 |
|------|------|------|
| 이어감 | #10b981 (녹색) | "→ 오늘로 이동됨" 배지 |
| 포기 | #ef4444 (빨강) | "× 포기함" 배지 |
| 완료 | #6b7280 (회색) | 체크된 할일 |
| 모닝 | #f59e0b (주황) | 모닝루틴 아이콘 |
| 나이트 | #5B5FC7 (인디고) | 나이트루틴 아이콘 |

## B3) 타이포그래피 ✅ 2025-01-21 업데이트
- **브랜드 이름**: 1.75rem, font-weight: 700, color: #5B5FC7, letter-spacing: -0.02em
- **제목**: 1.65rem (기존 1.5rem), font-weight: 700, letter-spacing: -0.02em, line-height: 1.2
- **버튼**: 1rem, font-weight: 600, letter-spacing: -0.005em
- **카테고리**: 0.95rem, font-weight: 600
- **본문**: 1rem, font-weight: 500
- **보조**: 0.85rem, color: #6b7280

**타이트한 자간 (letter-spacing)**: 모던하고 세련된 느낌을 위해 음수 자간 적용

## B3-1) 여백 시스템 ✅ 2025-01-21 추가
```css
/* 8px 기반 여백 시스템 (CSS 변수) */
--spacing-xs:  0.5rem   /* 8px */
--spacing-sm:  0.75rem  /* 12px */
--spacing-md:  1rem     /* 16px */
--spacing-lg:  1.5rem   /* 24px */
--spacing-xl:  2rem     /* 32px */
--spacing-2xl: 2.5rem   /* 40px */
--spacing-3xl: 3rem     /* 48px */
```

**사용 예시:**
- 카드 패딩: `var(--spacing-xl)` 또는 1.75rem
- 카드 간격: `var(--spacing-xl)` (2rem)
- 버튼 패딩: `var(--spacing-xs) var(--spacing-md)`
- 헤더 간격: `var(--spacing-lg)`

## B3-2) 레이어드 섀도우 시스템 ✅ 2025-01-21 추가
```css
/* Level 1: 카드 기본 */
box-shadow: 
  0 2px 4px rgba(0, 0, 0, 0.04),
  0 8px 16px rgba(0, 0, 0, 0.06);

/* Level 2: 버튼/탭 활성 */
box-shadow: 
  0 2px 4px rgba(색상, 0.15),
  0 6px 12px rgba(색상, 0.25);

/* Level 3: 모달 */
box-shadow: 
  0 8px 16px rgba(0, 0, 0, 0.1),
  0 20px 48px rgba(0, 0, 0, 0.15);

/* 호버 효과: 그림자 더 깊게 */
box-shadow: 
  0 4px 8px rgba(0, 0, 0, 0.06),
  0 12px 24px rgba(0, 0, 0, 0.09);
```

**레이어드 섀도우 원칙:**
1. 가까운 그림자 (작은 blur, 진한 투명도)
2. 먼 그림자 (큰 blur, 연한 투명도)
3. 두 레이어로 입체감 극대화

## B4) 컴포넌트

### 네비게이션 탭 (Plan-Do-See 그룹 구조) ✅ 구현 완료
```css
위치: 앱 헤더 내부 (최상단 고정)
구조: Plan-Do-See 그룹 기반
  - 계획 (Plan): 목표, 프로젝트 (연보라 배경 #f3e8ff)
  - 실행 (Do): 오늘 (연파랑 배경 #e0f2fe)
  - 리뷰 (See): 주간, 월간, 연간 (연녹색 배경 #d1fae5)
  - 관리: 관리자 (연노랑 배경 #fef3c7, Admin만 표시)
레이아웃: flex, 그룹별 균등 분배 (flex: 1)
그룹 라벨: 상단에 "계획", "실행", "리뷰", "관리" 표시
아이콘+텍스트: 한 줄 배치 (flex-direction: row)
아이콘 크기: 20px × 20px
활성 탭: 그룹별 그라데이션 색상
  - 계획: 보라색 그라데이션
  - 실행: 파란색 그라데이션  
  - 리뷰: 녹색 그라데이션
  - 관리: 노란색 그라데이션
반응형: 화면 축소 시 줄바꿈 (flex-wrap: wrap)
관리자 탭: shield-check 아이콘, 새 탭에서 /admin.html 열기 (target="_blank")
```

### 탭 (Tabs)
```css
기본 (비활성): 
  - 배경: #e5e7eb (회색)
  - 보더: 1px solid #d1d5db
  - 텍스트: #1f2937
  - border-radius: 8px
  
선택 (활성): 
  - 배경: 카테고리별 그라데이션 (120deg 각도)
    * Work: linear-gradient(120deg, #F59E42 0%, #E8922E 100%)
    * Job: linear-gradient(120deg, #22C7DD 0%, #1AACBE 100%)
    * Growth: linear-gradient(120deg, #9B8CD9 0%, #8678C7 100%)
    * Personal: linear-gradient(120deg, #E66BA4 0%, #D65590 100%)
  - 보더: transparent
  - 텍스트: white
  - box-shadow (레이어드): 
    * 0 2px 4px rgba(색상, 0.2)
    * 0 4px 12px rgba(색상, 0.25)
  
호버 (비활성): 
  - 배경: #d1d5db
  - 보더: #9ca3af
  - transform: translateY(-1px) scale(1.01)  /* 미세 스케일 추가 */
  - box-shadow: 0 2px 4px rgba(0,0,0,0.05), 0 4px 8px rgba(0,0,0,0.08)
```

### 카드 (Cards) ✅ 2025-01-21 업데이트
```css
배경: 카테고리별 파스텔 배경색 + 그라데이션
보더: 카테고리별 보더 색상 (2px solid)
그림자 (레이어드): 
  - 0 2px 4px rgba(0, 0, 0, 0.04)  /* 가까운 그림자 */
  - 0 8px 16px rgba(0, 0, 0, 0.06)  /* 먼 그림자 */
둥근 모서리: 12px
패딩: 1.75rem (기존 1.5rem → 더 넉넉)
간격: 2rem (기존 1.5rem → 더 넉넉)
아이콘 배경: 그라데이션 박스 (40px × 40px, border-radius: 12px)
전환: cubic-bezier(0.4, 0, 0.2, 1) 0.3s

호버 효과:
  - transform: translateY(-2px) scale(1.002)  /* 미세 스케일 */
  - box-shadow: 0 4px 8px rgba(0,0,0,0.06), 0 12px 24px rgba(0,0,0,0.09)
```

### 할일 카테고리 섹션 (구현됨)
```css
배경: 카테고리별 파스텔 배경색
  - Work: #fff7e6
  - Job: #e7f8ff
  - Growth: #f4e9ff
  - Personal: #ffe9f0
보더: 카테고리별 보더 색상 (2px solid)
  - Work: #f5d38f
  - Job: #b5e6ff
  - Growth: #d8c7ff
  - Personal: #f8c7d6
그림자: 0 8px 24px rgba(색상, 0.15)
  - Work: rgba(251, 146, 60, 0.15)
  - Job: rgba(34, 211, 238, 0.15)
  - Growth: rgba(167, 139, 250, 0.15)
  - Personal: rgba(244, 114, 182, 0.15)
둥근 모서리: 12px
padding: 12px
```

### 루틴 아이템 (구현됨)
```css
개별 아이템: 
  - 배경: white
  - border-radius: 8px
  - box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05)
  - padding: 0.5rem
  - margin-bottom: 0.5rem
리스트 컨테이너: 
  - 배경: transparent (메인 카드 그라데이션 노출)
  - padding: 0
```

### 배지 (Badges)
```css
이어감: 녹색 배경 + 흰색 텍스트 + arrow-right 아이콘
포기: 빨강 배경 + 흰색 텍스트 + x 아이콘
진행률: 흰색 배경 + 그림자 + 텍스트
크기: 0.75rem, padding: 0.15rem 0.5rem
둥근 모서리: 999px (완전 둥글게)
```

### 버튼 (Buttons) ✅ 2025-01-21 업데이트
```css
기본 버튼 (.btn):
  - padding: 0.75rem 1.5rem
  - font-size: 1rem
  - font-weight: 600
  - letter-spacing: -0.005em
  - border-radius: 8px
  - transition: cubic-bezier(0.4, 0, 0.2, 1) 0.25s
  - 호버: transform: translateY(-2px), box-shadow 증가
  - 물결 효과: ::before 가상 요소로 빛나는 효과

Primary 버튼 (.btn-primary):
  - 배경: var(--primary-gradient) (135deg)
  - 색상: white
  - box-shadow (레이어드): 
    * 0 2px 4px rgba(91, 95, 199, 0.15)
    * 0 6px 12px rgba(91, 95, 199, 0.25)
  - 호버: translateY(-2px), 더 깊은 그림자

Secondary 버튼 (.btn-secondary):
  - 배경: #e5e7eb
  - 호버: 
    * transform: translateY(-1px)
    * box-shadow: 0 2px 4px rgba(0,0,0,0.08), 0 4px 8px rgba(0,0,0,0.12)

하루 성찰 작성 버튼:
  - 배경: linear-gradient(135deg, #9B8CD9 0%, #8678C7 100%)
  - 색상: white
  - border-radius: 12px
  - box-shadow: 레이어드
  - 호버: transform: translateY(-2px), 더 깊은 그림자
  - 아이콘: pen-square (20px × 20px)
```

### 하루 성찰 폼 (Daily Reflection Form)
```css
폼 카드:
  - 배경: linear-gradient(135deg, #f3e8ff 0%, #fce7f3 100%)
  - 보더: 2px solid #a78bfa
  - box-shadow: 0 8px 24px rgba(167, 139, 250, 0.15)
  - border-radius: 12px

제목:
  - 색상: #7c3aed
  - font-size: 1.5rem
  - font-weight: 700
  - 아이콘: heart (24px × 24px, 색상: #a78bfa)

입력 필드:
  - 보더: 2px solid #c084fc
  - 배경: white
  - border-radius: 8px
  - min-height: 100px

라벨 및 아이콘:
  - 라벨 색상: #7c3aed
  - 아이콘 색상: #a78bfa
  - 아이콘 크기: 18px × 18px

저장 버튼:
  - 배경: linear-gradient(135deg, #a78bfa 0%, #c084fc 100%)
  - 색상: white
  - box-shadow: 0 4px 12px rgba(167, 139, 250, 0.3)
```

### 로그인 화면 (Login Screen) ✅ 구현 완료
```css
로고 이미지:
  - 파일명: /logo.png
  - 크기: 데스크톱/모바일 모두 max-width: 100%, width: 85-90% (최적화됨)
  - 위치: 화면 중앙
  - 레이아웃: flex 중앙 정렬, margin: 0 auto

구글 로그인 버튼:
  - 위치: 로고 이미지 아래 분리 배치 (flex-direction: column, gap: 1.5rem)
  - 크기: min-width: 180px, max-width: 240px (모바일: 160px~220px)
  - 배경: #374151 (짙은 회색)
  - 텍스트: white
  - 보더: 1px solid #4b5563
  - border-radius: 20px (모바일: 18px)
  - padding: 0.5rem 1rem (모바일: 0.45rem 0.9rem)
  - font-size: 0.95rem (모바일: 0.9rem)
  - box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2)
  - Google 아이콘: 20px × 20px SVG
  - white-space: nowrap (한 줄 표시 보장)
  - 호버: 배경 #4b5563, transform: translateY(-2px)
  - 활성: 배경 #1f2937
  - 중앙 정렬: flex 컨테이너로 중앙 정렬
```

### 파비콘 (Favicon) ✅ 2025-12-19 구현 완료
```css
브랜드 Sparkles 아이콘 (심플 버전):
  - 아이콘: Lucide `sparkles`
  - 색상: #5B5FC7 (브랜드 프라이머리 블루)
  - 형식: SVG Data URI
  - stroke-width: 2.5
  - viewBox: 0 0 24 24
  - 브랜드 일관성: 헤더 아이콘과 동일한 디자인

옵션별 스타일:
  - 옵션 1 (채택): 심플 선 아이콘 (배경 없음) ✅
  - 옵션 2: 브랜드 색상 원형 배경 + 흰색 아이콘
  - 옵션 3: 그라데이션 배경 (#5B5FC7 → #8B7AB8) + 흰색 아이콘

위치:
  - index.html <head> 섹션 내 <link rel="icon"> 태그
  - 브라우저 탭에 표시
```

### Open Graph 메타 태그 (카카오톡 링크 미리보기) ✅ 2025-01-21 구현 완료
```html
<!-- Open Graph 메타 태그 (카카오톡 링크 미리보기) -->
<meta property="og:title" content="인생관리 - 할일, 루틴, 성찰을 한 곳에서">
<meta property="og:description" content="매일 할일과 루틴을 기록하고, 주간/월간/연간 리포트와 AI 성찰로 개선하는 인생 관리 시스템">
<meta property="og:image" content="https://led-with-ai.vercel.app/logo.png">
<meta property="og:url" content="https://led-with-ai.vercel.app">
<meta property="og:type" content="website">
<meta property="og:site_name" content="인생관리">

<!-- Twitter Card 메타 태그 -->
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:title" content="인생관리 - 할일, 루틴, 성찰을 한 곳에서">
<meta name="twitter:description" content="매일 할일과 루틴을 기록하고, 주간/월간/연간 리포트와 AI 성찰로 개선하는 인생 관리 시스템">
<meta name="twitter:image" content="https://led-with-ai.vercel.app/logo.png">
```

구현 내용:
  - 카카오톡 링크 공유 시 이미지 미리보기 지원
  - Open Graph 프로토콜 표준 메타 태그 (og:title, og:description, og:image, og:url, og:type, og:site_name)
  - Twitter Card 메타 태그 포함 (소셜 미디어 호환성)
  - 이미지 URL: 절대 경로 사용 (https://led-with-ai.vercel.app/logo.png)
  - 배포 후 카카오톡 링크 미리보기 캐시 초기화 필요 (https://developers.kakao.com/tool/clear/og)

위치:
  - index.html <head> 섹션 내 메타 태그
  - 카카오톡/페이스북/트위터 등 소셜 미디어 링크 공유 시 미리보기 표시
```

## B4-1) 인터랙션 가이드라인 ✅ 2025-01-21 추가

### 애니메이션 이징
```css
/* 모든 전환에 사용 */
transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);

/* 카드는 더 느리게 */
transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
```

### 호버 효과 패턴
```css
/* 카드 */
transform: translateY(-2px) scale(1.002);
box-shadow: 더 깊은 레이어드 그림자;

/* 버튼 */
transform: translateY(-2px);
box-shadow: 더 깊은 레이어드 그림자;
::before 물결 효과 (width/height 0 → 300px);

/* 네비게이션 탭 */
transform: translateY(-1px) scale(1.01);
box-shadow: 0 2px 4px, 0 4px 8px;

/* 날짜 버튼 */
transform: translateY(-1px) scale(1.02-1.05);
box-shadow: 레이어드;

/* 입력 필드 포커스 */
border-color: var(--primary-blue);
box-shadow: 0 0 0 3px rgba(91, 95, 199, 0.08); /* 글로우 */
transform: scale(1.005); /* 미세 확대 */
```

### 모바일 최적화
```css
/* 터치 디바이스에서 호버 효과 비활성화 */
@media (max-width: 768px) {
  .card:hover {
    transform: none;
    box-shadow: 원래 그림자 유지;
  }
}
```

## B5) 아이콘 사용 규칙
- **라이브러리**: Lucide Icons만 사용
- **크기**: 
  - 기본: 18x18px
  - 네비게이션: 20px × 20px
  - 카드 헤더: 24px × 24px
  - 브랜드 아이콘: 28px × 28px
- **선 굵기**: stroke-width: 2.5
- **색상**: 상속 (별도 지정 없으면 텍스트 색상)

## B6) 레이아웃 (구현됨)
- **앱 헤더**:
  - 배경: 따뜻한 회색 그라데이션 (linear-gradient(135deg, #f4f4f5 0%, #fafafa 100%))
  - 보더: 1px solid #e5e7eb
  - border-radius: 12px
  - box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08)
  - max-width: 1200px
  - margin: 0 auto (가운데 정렬)
  - padding: 1.5rem
- **브랜드**:
  - 아이콘 크기: 28px × 28px
  - 텍스트 크기: 1.75rem
  - 색상: #6366f1 (primary color)
  - gap: 0.5rem
- **네비게이션 탭** (헤더 내부):
  - 탭 개수: 4개 (오늘, 주간, 월간, 목표) + 관리자 탭 (관리자만 표시)
  - 아이콘: sun (오늘), calendar-days (주간), calendar (월간), target (목표), shield-check (관리자)
  - 관리자 탭: 새 탭에서 /admin.html 열기
  - 레이아웃: 중앙 정렬 (justify-content: center)
  - 박스 형태: 배경 + 보더 + 둥근 모서리 (border-radius: 8px)
  - 비활성: 회색 배경 (#e5e7eb) + 회색 보더 (#d1d5db) + 검은색 텍스트 (#1f2937)
  - 활성: primary 그라데이션 (linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%)) + 흰색 텍스트 + box-shadow
  - 호버: 어두운 회색 (#d1d5db) + translateY(-1px)
  - 반응형: 모바일에서 2열 배치 (flex: 1 1 calc(50% - 0.5rem))
- **사용자 정보 박스** (헤더 오른쪽):
  - 사용자 이름 + 이메일 표시
  - 로그아웃 버튼
  - **모바일 최적화**: 모바일에서 사용자 이름 숨김 (`display: none`), 아바타만 표시, 로그아웃 버튼 크기 축소 (padding: 0.4rem 0.6rem, font-size: 0.8rem)
- **날짜 선택 버튼 (Chip)**:
  - border-radius: 999px (완전 둥근 형태)
  - 기본: 흰색 배경 + 회색 보더
  - 활성 (.primary): 단색 보라색 배경 (#6366f1) + 흰색 텍스트
  - 호버: 약간 어두운 배경 + translateY(-1px)
- **날짜 바 (Date Bar)**:
  - 레이아웃: 세로 배치 (flex-direction: column)
  - 날짜 선택 버튼 그룹: 가로 배치 (date-bar__main)
- **오늘로 이동 버튼** (구현됨):
  - 위치: 날짜 선택 버튼 아래 (날짜 바 내부)
  - 표시 조건: 오늘 날짜가 아닐 때만 표시
  - 크기: padding 0.375rem 0.875rem, font-size 0.875rem (날짜 선택 버튼보다 작게)
  - 색상: 배경 #e0e7ff (연한 인디고), 텍스트 검은색 (#1f2937)
  - 보더: 1px solid rgba(99, 102, 241, 0.2)
  - 호버: 배경 #c7d2fe, translateY(-1px)
  - 아이콘: sun (16px × 16px)
- **오늘 루틴**: 모닝/나이트 좌우 분리 (grid-template-columns: 1fr auto 1fr)
- **구분선**: 그라데이션 수직선 (width: 2px)
- **반응형**: 모바일에서 1열 배치, 구분선 숨김
- **섹션 헤더 레이아웃**:
  - 오늘 루틴: 왼쪽(아이콘 + 제목 + 토글 버튼) | 오른쪽(진행률 배지)
  - 오늘 할일: 왼쪽(아이콘 + 제목 + 토글 버튼) | 오른쪽(카테고리 탭)
- **토글 버튼**: 제목 바로 옆에 배치 (직관적 접근)
- **카테고리 탭**: 헤더 오른쪽에 배치 (진행률 배지와 유사한 위치)

---

# 부록 A. Supabase SQL (스키마 + 트리거 + RLS) — 그대로 적용 가능한 기준안
> 실제 적용 시 Supabase 프로젝트의 SQL Editor에서 순서대로 실행합니다.

## A1) 공통: updated_at 트리거
```sql
create or replace function public.set_updated_at()
returns trigger language plpgsql as $$
begin
  new.updated_at = now();
  return new;
end; $$;
