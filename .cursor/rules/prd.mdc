---
alwaysApply: true
---
## 1. 한 줄 요약
사용자는 매일 **할일/루틴/성찰(4항목)**을 기록하고, **주간/월간 리포트**와 **AI 주간/월간 성찰**, **AI 월실천계획 제안**으로 개선합니다. 모든 데이터는 **Supabase(Postgres) 단일 진실원(SSoT)**로 저장되어 PC/모바일에서 동일하게 보입니다.

## 구현 상태 (Implementation Status)
- ✅ **완료**: 
  - 로그인 화면 - 로고 이미지(logo.png) 표시, 구글 로그인 버튼 이미지 하단 오버레이, 짙은 회색 배경/흰색 텍스트 스타일, 반응형 디자인
  - 날짜 선택 바 (Date Bar) - 이전/다음 날짜 이동, 달력 오버레이, 오늘로 이동 버튼 (오늘 날짜가 아닐 때만 표시)
  - 오늘 할일 (Todos) + Carry-over (미완료 이월) + Enter 키로 수정 저장
  - 오늘 루틴 (Routine) - 모닝/나이트 구분, 목표 탭 연동, 진행률 표시, Soft Delete 적용, 토글 기능, 날짜 기준 필터링 (어제 루틴 보존)
  - 오늘 할일 (Todos) - 카테고리 탭, Enter 키로 수정 저장, 토글 기능, 수동 순서 변경
  - 하루 성찰 (4항목) - 기본 접힘 상태, "성찰 작성하기" 버튼으로 펼치기, 저장 후 자동 접힘, 4항목 입력/저장 (감사한 일/잘한 일/아쉬운 일/내일의 다짐)
  - 월간 데일리 루틴 (Goals 탭) - 모닝/나이트 각 0~10개 입력, Enter 키 지원, 수정/저장, 토글 기능, 부제목 표시
  - 연간 목표 (Goals 탭) - 연도별 3영역(자기계발/관계/업무재정) 입력/저장/조회/수정, 토글 기능, 부제목 표시, 연도 선택 모달, "올해로" 버튼
  - 월간 실천계획 (Goals 탭) - 3컬럼 레이아웃(연간목표 표시/월실천계획 입력/월말 결과 입력), plan_content/results_content JSONB 저장, 토글 기능, 부제목 표시, 월 선택 모달, "이번 달로" 버튼
  - AI 월실천계획 제안 (Goals 탭) - Edge Function 연동, 연간목표 및 최근 활동 분석, 구체적이고 실행 가능한 계획 제안, plan_content JSONB 저장
  - 네비게이션 레이아웃 (중앙 정렬, 아이콘+텍스트 한 줄) - 주간/월간 아이콘 구분 (calendar-days/calendar)
  - 디자인 시스템 (카테고리 색상, 그라데이션, Lucide 아이콘, 토글 기능, 헤더 레이아웃)
  - 토글 버튼 안정성 개선 (cloneNode 패턴으로 중복 등록 방지, Lucide 렌더링 타이밍 보장)
  - 주간 리포트 (통계 지표 + 주간 분석 + AI 주간 성찰) - 주차 선택, 실천율/완료율/성찰 작성률, 전주 대비 변화, 주간 패턴 분석, AI 성찰 생성/조회 (Gemini API, maxOutputTokens: 8000, 마크다운 변환, 스크롤바 지원)
  - 월간 리포트 (통계 지표 + 월간 분석 + AI 월간 성찰) - 월 선택, 실천율/완료율/성찰 작성률, 전월 대비 변화, 월간 패턴 분석, AI 성찰 생성/조회 (Gemini API, maxOutputTokens: 8000, 마크다운 변환, 스크롤바 지원, 레이트리밋 월 2회)
  - 관리자 기능 - 사용자 승인/거절/차단, 사용 기한 설정 (개별/일괄), 만료된 사용자 접근 제어, 챌린지 참가자 관리 (추가/제외/통계 확인)
- 🚧 **부분**: 
  - (현재 없음)

---

## 2. 목표 / 비목표
### 2.1 목표(Goals)
- G1. 오늘 관리(할일/루틴/성찰)를 빠르게 기록/완료
- G2. 주간/월간 리포트로 실행 지표를 제공
- G3. AI로 “주간/월간 성찰” 및 “월실천계획 초안”을 생성하고 **DB에 저장**하여 기기 간 동일 조회
- G4. 승인 기반(RLS 강제)으로 서비스 이용을 통제하고 사용자 데이터 완전 격리

### 2.2 비목표(Out of Scope) — v1 제외
- Electron 패키징
- Push 알림(Web Push)
- 협업/공유
- 완전 오프라인(캐시/큐잉은 v1.1+)

---

## 3. 제품 원칙(Product Principles)
1) **SSoT**: 영속 데이터는 Supabase만. localStorage는 “UI 상태/일회성 노출 플래그”만.  
2) **승인 전 보안(RLS 강제)**: pending/rejected/blocked는 CRUD/리포트/AI 접근 불가.  
3) **Online-first**: v1은 온라인 우선(오프라인 불가/제한).  
4) **타임존 일관성**: 기준 타임존은 `profiles.timezone` (기본 Asia/Seoul).  
5) **AI 비밀키 클라이언트 금지**: AI 호출은 Edge Function만.

---

## 4. 고정 정의(날짜/기간/타임존)
- 타임존: `profiles.timezone` (기본 `Asia/Seoul`)
- 오늘(today): 사용자 타임존 기준 `YYYY-MM-DD`
- 이번 주(week): **월요일 00:00 ~ 일요일 23:59** (고정)
  - `week_start`: 해당 주 월요일 날짜(date)
  - `week_end`: `week_start + 6일`
- 이번 달(month): 해당 월 1일 ~ 말일
  - `month_start`: `YYYY-MM-01`(date)

> 구현 규칙(필수):  
> - “화면 기준 날짜 키”는 **date 컬럼**으로 저장(로컬 타임존 변환 혼선 방지)  
> - 생성/수정 시각은 `timestamptz`(created_at/updated_at)로 저장

---

## 5. 사용자/권한
### 5.1 역할(Role)
- User: 기록/조회/리포트/AI 결과 확인
- Admin: 사용자 승인/거절/차단, 관리자 페이지만 접근

### 5.2 사용자 상태(State)
- `pending` / `approved` / `rejected` / `blocked`

### 5.3 접근 제어(필수)
- pending/rejected/blocked:  
  - 로그인 가능  
  - 단, **todos/routines/logs/reflections/goals/plans/reports/ai 결과** 접근 불가(RLS)  
  - profiles는 “본인 1행 SELECT”만 허용(상태 확인)

---

## 6. 정보구조(IA) / 라우팅
### 6.1 화면(공통: PC/모바일 반응형)
- `/index.html#/today` 오늘(할일/루틴/성찰)
- `/index.html#/weekly` 주간 리포트(통계 + AI 성찰)
- `/index.html#/monthly` 월간 리포트(통계 + AI 성찰) ✅ 구현 완료
- `/index.html#/goals` 목표(연간목표/월계획 + AI 월계획)
- `/admin.html` 관리자(승인/상태변경) — Admin만
- **참고**: `/reports`는 `/weekly`로 자동 리다이렉트 (하위 호환성)

### 6.2 승인 상태별 UX
- `pending`: "승인 대기" 고정 화면 + 로그아웃 버튼
- `rejected/blocked`: "이용 불가" 화면 + 문의 안내 + 로그아웃
- `approved` + 만료됨: "사용 기한 만료" 화면 + 만료일 표시 + 로그아웃 버튼

---

## 7. 핵심 유저 플로우
### 7.1 가입/승인
1) Google 로그인(Supabase Auth) - 로고 이미지와 구글 로그인 버튼이 오버레이된 디자인 ✅ 구현 완료
2) DB 트리거로 `profiles` 자동 생성(`status=pending`)  
3) pending 화면 고정  
4) Admin이 승인(`approved`)  
5) 사용자는 재접속/새로고침 시 즉시 정상 이용

### 7.2 오늘 관리
- **날짜 선택 바** (구현됨): 오늘 탭에서만 표시, 이전/다음 날짜 이동, 날짜 표시 버튼 클릭 시 달력 오버레이, **오늘로 이동 버튼** (오늘 날짜가 아닐 때만 표시)
- **오늘 루틴** (최상단): 모닝/나이트 구분, 체크(일자 로그), 진행률 표시, 접기/펼치기 토글
- **오늘 할일** (하단): 추가/완료 토글/삭제 + 카테고리 탭(헤더 오른쪽), Enter 키로 수정 저장, 접기/펼치기 토글
- 성찰: 4항목 작성/저장(토글 UI) - 미구현

### 7.3 리포트/AI
- **주간 리포트** (구현됨): 주간 지표(루틴 실천율, 할일 완료율, 성찰 작성률), 주간 분석(실천율 요약, 전주 대비 변화, 주간 패턴 분석), AI 주간 성찰 생성/조회
- **AI 주간 성찰** (구현됨): Gemini API 연동, Edge Function 배포, 마크다운 변환, 스크롤바 지원, 재생성 기능
- **월간 리포트** (구현됨): 월간 지표(루틴 실천율, 할일 완료율, 성찰 작성률), 월간 분석(실천율 요약, 전월 대비 변화, 월간 패턴 분석), AI 월간 성찰 생성/조회
- **AI 월간 성찰** (구현됨): Gemini API 연동, Edge Function 배포, 마크다운 변환, 스크롤바 지원, 재생성 기능, 레이트리밋 월 2회

### 7.4 목표/월계획/AI 제안
- **월간 데일리 루틴** (구현됨): 모닝/나이트 각 0~10개 입력, 저장 시 오늘 루틴에 자동 반영
- **연간목표 저장** (구현됨): 연도별 1건, 3영역(자기계발/관계/업무재정) 입력/저장/조회/수정
- **월실천계획 저장** (구현됨): 월별 3컬럼 레이아웃(연간목표 표시/월실천계획 입력/월말 결과 입력), plan_content/results_content JSONB 저장
- AI 월실천계획 제안 생성 → 편집 → 채택(accepted) - 미구현

---

# 8. 기능 요구사항(FR) + 수용 기준(AC)

## A. 인증/세션/승인
### FR-A
- FR-A1. Google OAuth는 Supabase Auth만 사용
- FR-A2. 세션 유지(새로고침/재접속 자동 복구)
- FR-A3. 로그아웃
- FR-A4. 승인 상태 기반 라우팅 가드(클라이언트) + RLS(서버) 동시 적용

### AC-A
- AC-A1. PC 로그인 후 모바일 로그인 시 **동일 데이터** 조회
- AC-A2. pending/rejected/blocked는 개발자도구/API 호출로도 CRUD/리포트/AI 접근 불가(RLS)
- AC-A3. Admin 승인 후 새로고침 시 즉시 사용 가능

---

## B-0. 날짜 선택 바 (Date Bar) ✅ 구현 완료
### 구조 (구현됨)
- **위치**: 오늘 탭에서만 표시 (네비게이션 바 아래)
- **레이아웃**: 이전 날짜 버튼 | 날짜 표시 버튼 | 다음 날짜 버튼
- **날짜 표시**: "YYYY년 M월 D일 (요일)" 형식
- **오늘로 이동 버튼**: 날짜 바 아래에 별도 버튼으로 표시

### FR-B0 (구현됨)
- FR-B0-1. 이전/다음 날짜 이동 버튼 (chevron-left/chevron-right 아이콘)
- FR-B0-2. 날짜 표시 버튼 클릭 시 달력 오버레이 표시 (flatpickr 사용)
- FR-B0-3. **오늘로 이동 버튼**: 오늘 날짜가 아닐 때만 표시 (`display: none` → `display: inline-flex`)
  - 위치: 날짜 바 아래 (date-bar-footer)
  - 아이콘: `sun` (Lucide)
  - 텍스트: "오늘로 이동"
  - 클릭 시: `resetSelectedDate(timezone)` 호출하여 오늘 날짜로 선택 날짜 리셋
- FR-B0-4. 선택 날짜는 localStorage에 저장 (`app_selected_date` 키)
- FR-B0-5. 날짜 변경 시 페이지 자동 리렌더링 (루틴/할일/성찰 재조회)

### AC-B0 (검증됨)
- AC-B0-1. 오늘 날짜일 때 "오늘로 이동" 버튼 숨김 ✅
- AC-B0-2. 다른 날짜 선택 시 "오늘로 이동" 버튼 표시 ✅
- AC-B0-3. "오늘로 이동" 버튼 클릭 시 오늘 날짜로 즉시 이동 ✅
- AC-B0-4. 날짜 변경 시 해당 날짜의 루틴/할일/성찰 정상 조회 ✅
- AC-B0-5. 선택 날짜가 localStorage에 저장되어 새로고침 후에도 유지 ✅

---

## B. 오늘 — 할일(Todo) ✅ 구현 완료
### B-0 카테고리(고정)
- UI 라벨: `Work / Job / Growth / Personal`
- DB 값(enum-like text): `work | job | self_dev | personal`
- **변경**: "자기계발" → "Growth" (2025-12-07)
- **위치**: 헤더 오른쪽에 배치 (진행률 배지와 유사한 위치)
- **크기**: `padding: 0.5rem 1rem`, `font-size: 0.95rem` (진행률 배지와 동일)

### FR-B
- FR-B1. 할일 생성 필드
  - 필수: `title`, `date(기본 오늘)`, `category(기본 work)`
  - 선택: `memo`, `due_date`, `priority(1~3)`, `pinned(boolean, 기본 false)`
- FR-B2. 완료/미완료 토글(`is_done`, `done_at`)
- FR-B3. 삭제는 soft delete(`deleted_at`)
- FR-B4. 필터: 오늘/미래/지난(기준: `date`)
- FR-B5. 정렬 규칙(필수, 조회 ORDER까지 고정)
  - 1차: `category` (UI 탭/섹션 기준)
  - 2차: `is_done ASC` (미완료 먼저)
  - 3차: `display_order ASC NULLS LAST` (수동 순서, 같은 완료 상태 내에서만 적용)
  - 4차: `pinned DESC` (핀 우선)
  - 5차: `due_date ASC NULLS LAST`
  - 6차: `priority DESC NULLS LAST`
  - 7차: `created_at ASC` (결정적 안정성)
- FR-B6. 카테고리 탭은 “단일 선택”
- FR-B7. 탭 선택 시 placeholder 즉시 변경
  - work: “복잡하고 어려운 일을 입력하세요...”
  - job: “간단한 할일을 입력하세요...”
  - self_dev: “성장과 관련된 내용을 입력하세요...”
  - personal: “개인적인 삶을 입력하세요...”
- FR-B8. “+추가”/Enter로 저장
  - 입력 trim 후 공백만이면 저장 금지 + 안내(토스트/문구)
  - 성공 시 입력 초기화(포커스 유지 권장)
- FR-B9. 동일 화면에서 추가/완료/삭제 즉시 반영(optimistic UI 가능하나 실패 시 롤백)
- FR-B10. **수정 시 Enter 키로 저장**: 수정 모드에서 Enter 키 누르면 즉시 저장, Escape 키로 취소
- FR-B11. **카테고리 탭 위치**: 헤더 오른쪽에 배치 (진행률 배지처럼)
- FR-B12. **토글 기능**: 헤더 제목 옆 토글 버튼으로 내용 접기/펼치기 (기본값: 펼침, 상태 localStorage 저장)
- FR-B13. **수동 순서 변경**: 미완료 항목에만 위/아래 화살표 버튼 표시, 같은 카테고리 내 미완료 항목끼리만 순서 변경 가능
  - 완료된 항목은 순서 변경 불가 (항상 아래에 표시)
  - `display_order` 컬럼으로 순서 저장 (NULL 허용)
  - RLS 정책 준수를 위해 개별 `update` 사용 (upsert 사용 안 함)
  - **카테고리 필터링**: `todo.category`를 사용하여 해당 할일의 실제 카테고리 내에서만 순서 변경 (activeTab에 의존하지 않음)
  - **날짜 필터링**: 같은 날짜(`date`)의 할일만 대상으로 순서 변경
  - **인덱스 기반 재할당**: 값 교환 대신 인덱스 기반으로 `display_order` 재할당 `(인덱스 + 1) * 10` 방식으로 안정적 유지
    - 여러 번 이동해도 값이 계속 증가하지 않아 정렬이 안정적
    - 10 단위 간격으로 중간 삽입 가능
- FR-B14. **지난 날짜 할일 수정/삭제 제한**: 지난 날짜(오늘 이전) 화면에서 기존 할일만 수정/삭제 불가
  - 지난 날짜에서도 새로운 할일 추가는 가능 (테스트 및 이월 기능을 위해)
  - 기존 할일: `todo.date < actualToday`인 할일 (실제로 그 날짜에 생성된 할일)
  - 기존 할일은 수정/삭제/순서 변경 버튼 숨김, 체크박스 비활성화
  - 새로 추가한 할일(`todo.date === today`)은 수정/삭제/순서 변경 가능
  - "지난 날짜" 배지 표시로 기존 할일 구분

### AC-B
- AC-B1. PC에서 완료 토글 → 모바일 새로고침 시 동일 상태
- AC-B2. 동일 날짜 목록이 PC/모바일에서 **동일 정렬**로 표시
- AC-B3. deleted_at 있는 항목은 기본 목록 미노출
- AC-B4. 공백 입력 저장 시도 시 DB row 생성되지 않음 + 안내 노출
- AC-B5. 수정 모드에서 Enter 키로 저장, Escape 키로 취소 작동 ✅
- AC-B6. 카테고리 탭이 헤더 오른쪽에 표시됨 ✅
- AC-B7. 토글 상태가 localStorage에 저장되어 새로고침 후에도 유지 ✅
- AC-B8. 미완료 항목만 순서 변경 가능, 완료된 항목은 항상 아래에 표시 ✅
- AC-B9. 순서 변경 시 RLS 정책 위반 없이 정상 작동 ✅
- AC-B13. **순서 변경 안정성**: 여러 번 순서 변경해도 정상 작동 (인덱스 기반 재할당 방식) ✅
- AC-B14. **카테고리 독립성**: 어떤 카테고리 탭이 선택되어 있어도 각 할일의 실제 카테고리 내에서만 순서 변경 ✅
- AC-B15. **날짜 일관성**: 같은 날짜의 할일만 대상으로 순서 변경하여 다른 날짜 할일과 섞이지 않음 ✅
- AC-B10. 지난 날짜에서도 새 할일 추가 가능 ✅
- AC-B11. 지난 날짜의 기존 할일만 수정/삭제/순서 변경 불가, 새로 추가한 할일은 수정/삭제 가능 ✅
- AC-B12. 기존 할일은 체크박스 비활성화, 새 할일은 체크 가능 ✅

---

## C. 오늘 — 루틴(Routine) ✅ 구현 완료
### C-0 구조 (구현됨)
- **위치**: 오늘 페이지 최상단 (할일 위)
- **제목**: "오늘 루틴" (그라데이션 배경: 녹색/틸)
- **헤더 레이아웃**: 왼쪽(아이콘 + 제목 + 토글 버튼) | 오른쪽(진행률 배지)
- **구분**: 모닝루틴 / 나이트루틴 (좌우 분리, 구분선)
- **아이콘**: `target` (제목), `sunrise` (모닝), `moon` (나이트)
- **진행률**: 헤더 오른쪽 배지 (전체/모닝/나이트 각각 표시)
- **토글 기능**: 제목 옆 토글 버튼으로 접기/펼치기 (기본값: 펼침, localStorage 저장)

### FR-C (구현됨)
- FR-C1. 루틴 정의: `title`, `schedule`, `is_active`
- FR-C2. schedule JSON 스키마(고정)
  - **monthly**: `{ "type":"monthly", "month":"YYYY-MM-01", "active_from_date":"YYYY-MM-DD" }` (월간 데일리 루틴)
    - `active_from_date`: 루틴 적용 시작일 (YYYY-MM-DD). Goals 탭에서 새로 생성된 루틴에만 존재. 기존 루틴은 `created_at` 기준으로 판단
  - daily/weekly: 스키마는 정의되어 있으나 현재 미사용 (월간 루틴만 사용)
- FR-C3. 루틴 체크는 `routine_logs`에 upsert(유니크키로 중복 방지)
- FR-C4. 오늘 진행률: (오늘 체크 true 개수) / (오늘 대상 루틴 개수)
  - 전체 진행률: "✓ 0 / 13" + 진행바 + "0%"
  - 모닝/나이트 개별 진행률: "☀ 0 / 8", "🌙 0 / 5"
- FR-C5. **날짜 기준 필터링**: 선택한 날짜에 해당 루틴이 활성 상태였는지 날짜 기준으로 판단
  - `fetchRoutines`에서는 `is_active` 조건 없이 모든 루틴 조회 (비활성화된 루틴 포함)
  - `isRoutineDue`에서 날짜 기준 필터링:
    - 적용 시작일 <= 선택 날짜 < 비활성화일
    - 적용 시작일: `schedule.active_from_date` 또는 `created_at` (날짜 부분)
    - 비활성화일: `deleted_at` (날짜 부분, 없으면 현재 활성 상태)
- FR-C6. **Soft Delete 정책**: 루틴 변경 시 완전 삭제 대신 `is_active = false`, `deleted_at = NOW()` (과거 체크 기록 보존)
  - 비활성화된 루틴도 조회되며, 날짜 기준으로 필터링되어 선택 날짜에 해당하는 루틴만 표시
  - 어제 날짜 선택 시: 어제 활성 상태였던 루틴 표시 (오늘 비활성화되었어도 어제는 표시됨)
  - 오늘 날짜 선택 시: 오늘 활성 상태인 루틴만 표시
- FR-C7. **월간 루틴 연동**: Goals 탭에서 저장한 월간 데일리 루틴이 자동으로 `routines` 테이블에 동기화
- FR-C8. **모닝/나이트 구분**: 각각 독립적으로 표시 및 체크 가능
- FR-C9. **루틴 없음 처리**: 루틴이 없을 때 "오늘 수행할 루틴이 없습니다" 메시지 + Goals 링크
- FR-C10. **토글 기능**: 헤더 제목 옆 토글 버튼으로 내용 접기/펼치기 (기본값: 펼침, 상태 localStorage 저장)

### AC-C (검증됨)
- AC-C1. PC에서 체크한 루틴이 모바일에서도 동일 체크/진행률 ✅
- AC-C2. 동일 routine/date 중복 기록 불가(UNIQUE + upsert) ✅
- AC-C3. 루틴 변경 시 과거 체크 기록 보존 (Soft Delete) ✅
- AC-C4. Goals 탭 저장 → 오늘 탭 즉시 반영 (동기화) ✅
- AC-C5. 모닝/나이트 각각 0개일 때 해당 섹션 숨김 처리 ✅
- AC-C6. 토글 상태가 localStorage에 저장되어 새로고침 후에도 유지 ✅
- AC-C7. **날짜 기준 필터링**: 어제 날짜 선택 시 어제 활성 상태였던 루틴 표시 ✅
- AC-C8. **날짜 기준 필터링**: 오늘 날짜 선택 시 오늘 활성 상태인 루틴만 표시 ✅
- AC-C9. **월중 수정 반영**: 같은 날 루틴 수정 시 오늘 날짜에는 새 루틴만, 어제 날짜에는 기존 루틴만 표시 ✅
- AC-C10. **PC/모바일 동기화**: 날짜 기준 필터링 로직이 동일하여 양쪽 기기에서 동일한 루틴 표시 ✅
- AC-C11. **토글 버튼 안정성**: cloneNode 패턴으로 이벤트 리스너 중복 등록 방지, Lucide 렌더링 완료 후 등록으로 첫 로드 시에도 정상 작동 ✅
- AC-C12. **주간 통계 정확성**: 주 중 루틴 변경 시 주간 실천율이 정확하게 계산됨 (날짜별 필터링 적용) ✅

---

## D. 오늘 — 하루 성찰(4항목) ✅ 구현 완료
### D-0 구조 (구현됨)
- **위치**: 오늘 페이지 하단 (할일 아래)
- **제목**: "하루 성찰" (그라데이션 배경: 보라색/핑크)
- **헤더 레이아웃**: 왼쪽(아이콘 + 제목 + 토글 버튼) | 오른쪽("성찰 작성하기" 버튼)
- **아이콘**: `pen-square` (제목 및 버튼)
- **토글 기능**: 제목 옆 토글 버튼으로 접기/펼치기 (기본값: 접힘, "성찰 작성하기" 버튼으로 펼치기)

### FR-D (구현됨)
- FR-D1. **기본 접힘 상태**: 섹션이 기본적으로 접혀있음 (`display: none`)
- FR-D2. **"성찰 작성하기" 버튼**: 헤더 오른쪽에 배치, 클릭 시 섹션 펼치기 및 폼 표시
- FR-D3. **4항목 고정**
  1) grateful(감사한 일)
  2) well_done(잘한 일)
  3) regret(아쉬운 일)
  4) tomorrow_promise(내일의 다짐)
- FR-D4. **1일 1건(UNIQUE(user_id,date))**: upsert로 저장
- FR-D5. **저장 정책(고정)**
  - 각 필드는 비어도 됨
  - 단, 4개 모두 공란이면 저장 불가 + 안내
- FR-D6. **저장 후 자동 접힘**: 저장 성공 시 섹션 자동 접힘 및 폼 숨김

### AC-D (검증됨)
- AC-D1. PC 저장 → 모바일 동일 날짜 동일 내용 ✅
- AC-D2. 전체 공란 저장 불가가 일관되게 적용 ✅
- AC-D3. 기본 접힘 상태 유지, "성찰 작성하기" 버튼으로만 펼치기 ✅
- AC-D4. 저장 후 자동 접힘 작동 ✅

---

## E. "미완료 할일 이월" 모달(Carry-over) ✅ 구현 완료
### 정책(구현됨)
- 대상: `date < 오늘` AND `is_done = false` AND `deleted_at IS NULL` AND `carried_over_at IS NULL` AND `skipped_at IS NULL`
  - **변경**: "어제"만 → "오늘 이전 모든 날짜" (어제, 그제, 100일 전 등)
- 노출: **기기(브라우저) 기준 1일 1회**(localStorage 키로 제어)
  - key: `carryover_shown_{today}`
- 이어가기 방식: **복제(새 ID)** + 원본은 유지 + 원본에 `carried_over_at = now()` 기록(재노출 방지)
- **포기 방식**: 원본에 `skipped_at = now()` 기록 (NEW!)

### FR-E (구현됨)
- FR-E1. 앱 진입 시 대상 있으면 모달 노출
- FR-E2. 액션
  - **이어가기**: 오늘로 복제 + 원본 `carried_over_at` 기록
  - **포기**: 원본 `skipped_at` 기록 (삭제 대신 "포기" 상태)
  - **나중에**: 모달 닫기, 내일 다시 표시
  - ~~모두 삭제~~: 제거됨 (개별 포기만 허용)
- FR-E3. 개별 항목 이어가기/포기 지원
- FR-E4. **시각적 구분** (과거 날짜 화면):
  - 이어간 할일: 회색 배경 + "→ 오늘로 이동됨" (녹색 배지)
  - 포기한 할일: 회색 배경 + "× 포기함" (빨간 배지)
  - 처리된 할일은 편집/삭제 버튼 숨김

### AC-E (검증됨)
- AC-E1. 대상 있을 때만 뜨며, 동일 기기에서 당일 재노출 없음 ✅
- AC-E2. "이어가기" 후 오늘(date=today) 목록에 생성되고 동기화됨 ✅
- AC-E3. 처리된 원본은 `carried_over_at` 또는 `skipped_at`로 인해 다음 실행 시 재노출되지 않음 ✅
- AC-E4. PC/모바일 간 동기화 정상 작동 ✅
- AC-E5. 히스토리 추적 가능: "이번 달에 몇 개를 이어갔는지/포기했는지" 통계 가능 ✅

---

## F. 리포트(주간/월간) + AI 주간/월간 성찰
### F-1 통계 리포트 FR-FS ✅ 구현 완료
- FR-FS1. 주간 지표
  - todo 완료율 = 완료 todo / 전체 todo (해당 주 date 기준)
  - **루틴 실천율 = 체크 true / (각 날짜별 활성 루틴 수 합계)** ✅ 날짜별 필터링 적용
    - **날짜별 계산**: 주의 각 날짜마다 `isRoutineDue` 함수로 활성 루틴 수 계산
    - **루틴 변경 반영**: 주 중에 루틴이 추가/삭제되어도 정확한 실천율 계산
    - **예시**: 월~수 10개, 목~일 12개 → 가능한 체크 수 = (10×3) + (12×4) = 78개
    - **모닝/나이트**: 각각 날짜별로 계산하여 정확한 실천율 제공
    - **루틴별 실천율**: 각 루틴의 활성 일수 기준으로 계산 (7일 고정 아님)
  - 성찰 작성일 수 = daily_reflections 존재한 date 수
- FR-FS2. 월간 지표(합/평균) ✅ 구현 완료
  - todo 완료율 = 완료 todo / 전체 todo (해당 월 date 기준)
  - **루틴 실천율 = 체크 true / (각 날짜별 활성 루틴 수 합계)** ✅ 날짜별 필터링 적용
    - **날짜별 계산**: 월의 각 날짜마다 `isRoutineDue` 함수로 활성 루틴 수 계산
    - **루틴 변경 반영**: 월 중에 루틴이 추가/삭제되어도 정확한 실천율 계산
    - **월의 일수**: 28~31일 동적 계산 (하드코딩된 "7일" 제거)
    - **모닝/나이트**: 각각 날짜별로 계산하여 정확한 실천율 제공
    - **루틴별 실천율**: 각 루틴의 활성 일수 기준으로 계산
  - 성찰 작성일 수 = daily_reflections 존재한 date 수
  - **월간 통계 계산 로직** ✅ 구현 완료
    - **루틴 통계**: `src/utils/monthlyStats.js`의 `getRoutinesStats` 함수
      - 모든 루틴 조회 (`is_active` 조건 제거, PRD FR-C5 준수)
      - 각 날짜별로 `isRoutineDue` 함수로 활성 루틴 필터링
      - 가능한 체크 수 = 각 날짜의 활성 루틴 수 합계
      - 모닝/나이트도 날짜별로 계산
      - 루틴별 실천율은 활성 일수 기준으로 계산
    - **Edge Function**: `supabase/functions/ai-monthly-reflection/index.ts`의 `collectMonthlyStats` 함수
      - 동일한 날짜별 필터링 로직 적용
      - AI 성찰 생성 시 정확한 통계 사용
- FR-FS3. 규칙 기반 인사이트 문장(v1) ✅ 구현 완료
  - 예: "이번 주 할일 완료율이 70%로 양호합니다. 다음 주는 루틴 실천율을 5%p 올려보세요."
  - 주간 분석: 실천율 요약, 전주 대비 변화, 주간 패턴 분석
- FR-FS4. **주간 통계 계산 로직** ✅ 구현 완료
  - **루틴 통계**: `src/utils/weeklyStats.js`의 `getRoutinesStats` 함수
    - 모든 루틴 조회 (`is_active` 조건 제거, PRD FR-C5 준수)
    - 각 날짜별로 `isRoutineDue` 함수로 활성 루틴 필터링
    - 가능한 체크 수 = 각 날짜의 활성 루틴 수 합계
    - 모닝/나이트도 날짜별로 계산
    - 루틴별 실천율은 활성 일수 기준으로 계산
  - **Edge Function**: `supabase/functions/ai-weekly-reflection/index.ts`의 `collectWeeklyStats` 함수
    - 동일한 날짜별 필터링 로직 적용
    - AI 성찰 생성 시 정확한 통계 사용
- FR-FS5. 집계는 DB View 또는 SQL 함수 기반 제공 권장(클라이언트 부하 최소화) ✅ 구현 완료

### F-1 AC (검증됨)
- AC-FS1. “이번 주”는 월~일 고정(기기/브라우저 무관) ✅
- AC-FS2. 날짜 경계(23:59~00:01)에서도 기준이 흔들리지 않음(타임존 준수) ✅
- AC-FS3. **루틴 변경 반영**: 주 중에 루틴이 추가/삭제되어도 주간 실천율이 정확하게 계산됨 ✅
- AC-FS4. **월간 통계**: 월의 일수(28~31일) 동적 계산, 하드코딩된 "7일" 값 제거 ✅
- AC-FS5. **루틴 변경 반영**: 월 중에 루틴이 추가/삭제되어도 월간 실천율이 정확하게 계산됨 ✅
- AC-FS6. **전월 비교**: 연도 경계를 넘어가는 전월 계산 정확 (Luxon 사용) ✅

### F-2 AI 성찰 FR-FAI (필수: Edge Function) ✅ 주간/월간 성찰 구현 완료
- FR-FAI1. 주간 AI 성찰 생성 버튼 ✅ 구현 완료
- FR-FAI2. 월간 AI 성찰 생성 버튼 ✅ 구현 완료
- FR-FAI3. 입력은 해당 기간 요약(통계 + 핵심 텍스트 일부(길이 제한)) 포함 ✅ 구현 완료
- FR-FAI4. 결과는 `content_md`로 저장(마크다운) ✅ 구현 완료
- FR-FAI5. 동일 기간 재생성은 upsert(덮어쓰기)로 고정 ✅ 구현 완료
- FR-FAI6. 저장 메타: `model`, `prompt_version`, `generated_at`(=created_at) ✅ 구현 완료
- **추가 구현 사항**:
  - Edge Function: Gemini API 사용 (gemini-2.5-flash), maxOutputTokens: 8000
  - 마크다운 변환: 안정적인 HTML 변환 로직 (헤더, 리스트, 볼드, 이탤릭, 구분선 지원)
  - 스크롤바: max-height: 600px, overflow-y: scroll
  - 디버깅 로그: DB 원본 데이터 및 변환 과정 추적
  - 예외 처리: 각 줄 처리 시 예외 발생해도 모든 내용 표시 보장

### F-2 AC (검증됨)
- AC-FAI1. 생성 후 DB 저장 → PC/모바일 동일 결과 조회 ✅
- AC-FAI2. pending/rejected/blocked는 생성/조회 불가(RLS + Edge 인증) ✅
- AC-FAI3. AI 호출 실패 시 DB에 부분 저장 없음(서버에서 원자적 처리) ✅
- AC-FAI4. 월간 AI 성찰 생성/조회 정상 작동 ✅
- AC-FAI5. 월간 레이트리밋 (월 2회) 정상 작동 ✅

---

## G. 목표(연간) + 월실천계획(직접/AI)
### G-0 월간 데일리 루틴 ✅ 구현 완료
#### 구조 (구현됨)
- **위치**: Goals 탭 최상단
- **제목**: "월간 데일리 루틴" (그라데이션 배경: 보라색/핑크)
- **아이콘**: `repeat` (제목), `sunrise` (모닝), `moon` (나이트)
- **모드**: 보기 모드 / 편집 모드 (토글)
- **토글 기능**: 헤더 제목 옆 토글 버튼으로 내용 접기/펼치기 (기본값: 펼침, 상태 localStorage 저장)
- **부제목**: "12월 매일 실천할 루틴" (동적, 제목 아래 표시, 글씨 크기 1rem)
- **구분선**: 부제목 아래 헤더 border-bottom으로 구분선 표시

#### FR-G0 (구현됨)
- FR-G0-1. 모닝/나이트 루틴 각각 0~10개 입력 가능
- FR-G0-2. 각 루틴 입력 필드에 번호 표시 (1, 2, 3...)
- FR-G0-3. Enter 키로 다음 입력 필드 자동 추가 (최대 10개까지)
- FR-G0-4. 개별 삭제 버튼 (X 아이콘)
- FR-G0-5. "모닝루틴 추가" / "나이트루틴 추가" 버튼
- FR-G0-6. 카운터 표시: "0/10" (현재 개수/최대 개수)
- FR-G0-7. 저장 시 `monthly_plans.daily_routines` JSONB에 저장
  - 형식: `{ "morning": ["루틴1", "루틴2"], "night": ["루틴3"] }`
- FR-G0-8. 저장 시 `routines` 테이블에 동기화
  - 기존 월간 루틴: `is_active = false`, `deleted_at = NOW()` (Soft Delete)
  - 새 루틴: `schedule = { "type": "monthly", "month": "YYYY-MM-01", "active_from_date": "YYYY-MM-DD" }` 생성
    - `active_from_date`: 오늘 날짜 (YYYY-MM-DD) 저장하여 오늘부터 적용되도록 함
- FR-G0-9. 보기 모드: 저장된 루틴 목록 표시 + "수정하기" 버튼
- FR-G0-10. 편집 모드: 입력 필드 + "저장하기" / "취소" 버튼
- FR-G0-11. 루틴 없을 때: "등록된 모닝루틴이 없습니다" / "등록된 나이트루틴이 없습니다" 메시지
- FR-G0-12. **토글 기능**: 헤더 제목 옆 토글 버튼으로 내용 접기/펼치기 (기본값: 펼침, 상태 localStorage 저장) ✅
- FR-G0-13. **부제목 표시**: 제목 아래 부제목 "12월 매일 실천할 루틴" 표시 (동적, 글씨 크기 1rem) ✅

#### AC-G0 (검증됨)
- AC-G0-1. Goals 탭 저장 → 오늘 탭 즉시 반영 ✅
- AC-G0-2. 루틴 변경 시 과거 체크 기록 보존 (Soft Delete) ✅
- AC-G0-3. Enter 키로 자동 추가 작동 ✅
- AC-G0-4. PC/모바일 동기화 정상 ✅
- AC-G0-5. 중복 생성 방지 (기존 루틴 비활성화 후 새로 생성) ✅
- AC-G0-6. 토글 기능 정상 작동, 상태가 localStorage에 저장되어 새로고침 후에도 유지 ✅
- AC-G0-7. 부제목이 동적으로 업데이트되며 올바른 위치에 표시됨 ✅

### G-1 연간목표 FR-GY ✅ 구현 완료
#### 구조 (구현됨)
- **위치**: Goals 탭 (월간 데일리 루틴 아래)
- **제목**: "연간 목표" (그라데이션 배경: 인디고/보라)
- **아이콘**: `target` (제목), `book-open` (자기계발), `heart` (관계), `briefcase` (업무/재정)
- **모드**: 보기 모드 / 편집 모드 (토글)
- **토글 기능**: 헤더 제목 옆 토글 버튼으로 내용 접기/펼치기 (기본값: 펼침, 상태 localStorage 저장)
- **부제목**: "2025년 연간 목표" (동적, 제목 아래 표시, 글씨 크기 1rem)
- **구분선**: 부제목 아래 헤더 border-bottom으로 구분선 표시
- **연도 선택**: 이전/다음 연도 이동 버튼, 연도 레이블 클릭 시 연도 선택 모달
- **"올해로" 버튼**: 올해가 아닌 연도 선택 시 표시되는 버튼

#### FR-GY (구현됨)
- FR-GY1. 연도 선택(현재/이전/다음) ✅
- FR-GY2. 연도별 1건 저장(3영역) ✅
  - self_dev (자기계발)
  - relationship (관계)
  - work_finance (업무/재정)
- FR-GY3. 조회/수정 ✅
- FR-GY4. **토글 기능**: 헤더 제목 옆 토글 버튼으로 내용 접기/펼치기 (기본값: 펼침, 상태 localStorage 저장) ✅
- FR-GY5. **부제목 표시**: 제목 아래 부제목 "2025년 연간 목표" 표시 (동적, 글씨 크기 1rem) ✅
- FR-GY6. **연도 선택 모달**: 연도 레이블 클릭 시 모달에서 연도 선택 가능 ✅
- FR-GY7. **"올해로" 버튼**: 올해가 아닌 연도 선택 시 표시, 클릭 시 현재 연도로 이동 ✅

### G-1 AC (검증됨)
- AC-GY1. 연도별 데이터 분리, PC/모바일 동일 ✅
- AC-GY2. 토글 기능 정상 작동, 상태가 localStorage에 저장되어 새로고침 후에도 유지 ✅
- AC-GY3. 부제목이 선택된 연도에 맞춰 동적으로 업데이트됨 ✅
- AC-GY4. 연도 선택 모달에서 원하는 연도를 쉽게 선택 가능 ✅
- AC-GY5. "올해로" 버튼이 올해가 아닐 때만 표시되고 정상 작동 ✅

### G-2 월실천계획(직접) FR-GM ✅ 구현 완료
#### 구조 (구현됨)
- **위치**: Goals 탭 (연간 목표 아래)
- **제목**: "월간 실천계획" (그라데이션 배경: 청록/녹색)
- **아이콘**: `calendar-check` (제목)
- **모드**: 보기 모드 / 편집 모드 (토글)
- **토글 기능**: 헤더 제목 옆 토글 버튼으로 내용 접기/펼치기 (기본값: 펼침, 상태 localStorage 저장)
- **부제목**: "2025년 12월 실천 계획 & 결과" (동적, 제목 아래 표시, 글씨 크기 1rem)
- **구분선**: 부제목 아래 헤더 border-bottom으로 구분선 표시
- **월 선택**: 이전/다음 월 이동 버튼, 월 레이블 클릭 시 월 선택 모달 (선택된 연도의 1~12월)
- **"이번 달로" 버튼**: 이번 달이 아닌 월 선택 시 표시되는 버튼
- **3컬럼 레이아웃**:
  - 왼쪽: 연간목표 표시 (linked_year에 해당하는 yearly_goals 조회, 읽기 전용)
  - 가운데: 월실천계획 입력 (plan_content JSONB - self_dev/relationship/work_finance)
  - 오른쪽: 월말 결과 입력 (results_content JSONB - self_dev/relationship/work_finance)
  - 구분선: 1.4px dashed #80E2E2

#### FR-GM (구현됨)
- FR-GM1. 월 선택(`month_start=YYYY-MM-01`) ✅
- FR-GM2. 편집/저장/재조회 ✅
- FR-GM3. 연간목표 연결 방식(고정) ✅
  - `linked_year`에 year만 저장(참조)
  - 연도 선택 시 해당 연도의 yearly_goals 자동 조회하여 왼쪽 컬럼에 표시
  - 월계획 본문은 `plan_content`, `results_content` JSONB에 영역별로 저장
- FR-GM4. 월간 데일리 루틴 저장 ✅
  - `monthly_plans.daily_routines` JSONB 컬럼에 저장
  - 형식: `{ "morning": ["루틴1", "루틴2"], "night": ["루틴3"] }`
- FR-GM5. plan_content JSONB 저장 ✅
  - 형식: `{ "self_dev": "", "relationship": "", "work_finance": "" }`
  - 각 영역별 월실천계획 입력값 저장
- FR-GM6. results_content JSONB 저장 ✅
  - 형식: `{ "self_dev": "", "relationship": "", "work_finance": "" }`
  - 각 영역별 월말 결과 입력값 저장
- FR-GM7. **토글 기능**: 헤더 제목 옆 토글 버튼으로 내용 접기/펼치기 (기본값: 펼침, 상태 localStorage 저장) ✅
- FR-GM8. **부제목 표시**: 제목 아래 부제목 "2025년 12월 실천 계획 & 결과" 표시 (동적, 글씨 크기 1rem) ✅
- FR-GM9. **월 선택 모달**: 월 레이블 클릭 시 모달에서 월 선택 가능 (선택된 연도의 1~12월) ✅
- FR-GM10. **"이번 달로" 버튼**: 이번 달이 아닌 월 선택 시 표시, 클릭 시 현재 월로 이동 ✅
- FR-GM11. **연간목표 연결 자동화**: linked_year는 선택된 월의 연도로 자동 연결 (드롭다운 제거) ✅

### G-2 AC (검증됨)
- AC-GM1. 월별 저장/조회가 기기 간 동일 ✅
- AC-GM2. 연간목표 수정/삭제와 무관하게 월계획이 깨지지 않음(참조는 year 값) ✅
- AC-GM3. linked_year 선택 시 해당 연도의 연간목표가 왼쪽 컬럼에 자동 표시됨 ✅
- AC-GM4. plan_content와 results_content가 각각 독립적으로 저장/조회됨 ✅
- AC-GM5. 토글 기능 정상 작동, 상태가 localStorage에 저장되어 새로고침 후에도 유지 ✅
- AC-GM6. 부제목이 선택된 월에 맞춰 동적으로 업데이트됨 ✅
- AC-GM7. 월 선택 모달에서 선택된 연도의 원하는 월을 쉽게 선택 가능 ✅
- AC-GM8. "이번 달로" 버튼이 이번 달이 아닐 때만 표시되고 정상 작동 ✅
- AC-GM9. 연간목표 연결이 자동으로 처리되어 사용자 편의성 향상 ✅

### G-3 AI 월실천계획 제안 FR-GAI ✅ 구현 완료 (필수: Edge Function)
#### 구조 (구현됨)
- **버튼**: "AI로 제안받기" (월간 실천계획 편집 모드에서 표시)
- **입력**: 
  - 연간목표(해당 year의 yearly_goals)
  - 지난달 실천계획 및 결과(previous month의 monthly_plans)
  - 최근 4주 활동 요약(루틴/할일/성찰 통계)
- **출력 포맷**: JSON 형식 (plan_content JSONB)
  - 각 영역(자기계발/관계/업무재정)별 1-2개 핵심 행동 제안
  - 매우 구체적이고 실행 가능한 계획만 제안
  - 마크다운 없이 일반 텍스트로 저장
- **저장**: `monthly_plans.source='ai_suggested'`, `status='draft'`, `plan_content` JSONB에 저장

#### FR-GAI (구현됨)
- FR-GAI1. "AI로 제안받기" 버튼 클릭 시 Edge Function 호출 ✅
- FR-GAI2. 입력 수집: 연간목표(해당 year), 지난달 실천계획 및 결과, 최근 4주 활동 요약 ✅
- FR-GAI3. AI 프롬프트: 연간목표와 지난달 실천계획/결과, 최근 활동을 종합적으로 고려하여 제안 ✅
- FR-GAI4. 출력 포맷: JSON 형식 (plan_content JSONB, 각 영역별 1-2개 핵심 행동) ✅
- FR-GAI5. 저장 정책: `monthly_plans.source='ai_suggested'`, `status='draft'`, plan_content JSONB 저장 ✅
- FR-GAI6. 재생성 정책: 동일 `user_id + month_start + source='ai_suggested'`는 upsert 덮어쓰기 ✅
- FR-GAI7. 사용자 편집: AI 제안 생성 후 편집 모드에서 수정 가능, 저장 시 manual로 전환 가능 ✅
- FR-GAI8. 레이트리밋: 월 5회 제한 (ai_usage_counters 테이블로 관리) ✅

### G-3 AC (검증됨)
- AC-GAI1. 생성 결과 저장 후 PC/모바일 동일 조회 ✅
- AC-GAI2. 편집/저장 상태가 기기 간 동일 ✅
- AC-GAI3. 승인 사용자만 가능(RLS + Edge 인증) ✅
- AC-GAI4. 연간목표와 지난달 실천계획/결과, 최근 활동이 AI 제안에 반영됨 ✅
- AC-GAI5. AI 제안이 구체적이고 실행 가능한 1-2개 핵심 행동으로 제안됨 ✅
- AC-GAI6. 레이트리밋 정상 작동 (월 5회 제한) ✅

---

## H. 관리자(승인/상태변경)
### FR-H
- FR-H1. pending 사용자 목록 조회
- FR-H2. 승인/거절 처리
- FR-H3. approved 사용자 목록 및 상태 변경(approved→blocked 등)
- FR-H4. Admin만 접근(클라이언트 가드 + RLS)
- FR-H5. 사용자별 사용 기한 설정 (특정 날짜 또는 무제한) - 개별 설정 및 일괄 설정 지원
- FR-H6. 만료된 사용자 접근 제어 - `expires_at < CURRENT_DATE`인 경우 서비스 접근 불가
- FR-H7. 챌린지 참가자 관리 - 승인된 사용자 중에서 챌린지 참가자 추가/제외 (개별/일괄), 챌린지 참가자 목록 조회 및 통계 확인
- FR-H8. 사용 현황 통계 표시 - 승인된 사용자 및 챌린지 참가자 목록에 이번 주 루틴 실행률, 할일 완료율, 성찰 작성일 표시

### AC-H (보안 최중요)
- AC-H1. 일반 사용자는 어떤 방식으로도 `profiles.status/role` 변경 불가(RLS)
- AC-H2. 일반 사용자가 admin.html 접근해도 목록 조회 불가(RLS)
- AC-H3. 만료된 사용자는 서비스 접근 불가 (RLS + 클라이언트 가드)
- AC-H4. 사용 기한 설정이 PC/모바일에서 동일하게 반영됨
- AC-H5. 일괄 기한 설정 시 선택된 사용자들에만 적용됨
- AC-H6. 챌린지 참가자 추가/제외 시 사용자 자체는 삭제되지 않음 (is_challenge_participant만 변경)
- AC-H7. 사용 현황 통계는 이번 주(월~일) 기준으로 계산되어 표시됨
- AC-H8. 챌린지 참가자 탭에서도 일괄 제외 기능 사용 가능

---

# 9. 비기능 요구사항(NFR)

## 9.1 동기화/일관성
- NFR-S1. 모든 변경은 DB에 즉시 반영(성공/실패 UI로 명시)
- NFR-S2. 새로고침/재접속 시 최신 데이터를 재조회
- NFR-S3(선택). Supabase Realtime로 today 화면 자동 동기화(기본은 새로고침)

## 9.2 충돌 정책
- NFR-C1. 동시 수정은 last-write-wins(서버 updated_at 최종값)
- NFR-C2. carry-over 복제는 새 ID 생성으로 충돌 방지
- NFR-C3. 루틴 변경 시 Soft Delete 적용: `DELETE` 대신 `UPDATE is_active = false, deleted_at = NOW()` (과거 체크 기록 보존)

## 9.3 AI 보안/비용/레이트리밋
- NFR-AI1. AI 키는 Edge Function 환경변수로만 보관
- NFR-AI2. 저장: model/prompt_version 필수
- NFR-AI3. 레이트리밋(고정, v1 권장)
  - 주간 AI 성찰: 주 3회
  - 월간 AI 성찰: 월 2회
  - AI 월계획: 월 5회
  - 구현: `ai_usage_counters` 테이블로 카운트(upsert)
- NFR-AI4. 실패 시 사용자에게 재시도 버튼 제공(서버는 부분 저장 금지)

## 9.4 성능/호환성
- NFR-P1. 모바일 Chrome/Safari에서 핵심 작업 300ms~1s 내 체감 동작(네트워크 제외)
- NFR-P2. 리포트 쿼리는 서버(view/function) 중심

---

# 10. 데이터 모델(Supabase/Postgres) — 확정 스키마

## 10.1 Enum(권장: CHECK 제약으로 구현 가능)
- profiles.status: pending/approved/rejected/blocked
- profiles.role: user/admin
- monthly_plans.source: manual/ai_suggested
- monthly_plans.status: draft/accepted/archived
- todos.category: work/job/self_dev/personal

## 10.2 테이블(필수)
### profiles
- id uuid PK (auth.users.id)
- email text
- name text
- avatar_url text
- status text not null default 'pending'
- role text not null default 'user'
- timezone text not null default 'Asia/Seoul'
- expires_at date                                    -- 사용 기한 만료일 (NULL이면 무제한 사용 가능)
- is_challenge_participant boolean not null default false  -- 챌린지 참가 여부
- created_at timestamptz not null default now()
- updated_at timestamptz not null default now()

### todos
- id uuid PK default gen_random_uuid()
- user_id uuid not null FK → profiles(id)
- date date not null                       -- "오늘 화면 기준 날짜"
- category text not null default 'work'
- title text not null
- memo text
- due_date date
- priority int                              -- 1~3 (선택)
- pinned boolean not null default false
- is_done boolean not null default false
- done_at timestamptz
- carried_over_at timestamptz               -- carry-over 처리 시 원본에 기록
- skipped_at timestamptz                    -- 포기 처리 시 원본에 기록 (NEW!)
- deleted_at timestamptz
- display_order integer                     -- 수동 순서 변경 (같은 완료 상태 내에서만 적용, NULL 허용)
- created_at timestamptz not null default now()
- updated_at timestamptz not null default now()
- 인덱스: (user_id, date), (user_id, date, category), (user_id, deleted_at), (user_id, skipped_at), (user_id, date, category, display_order NULLS LAST) WHERE deleted_at IS NULL

### routines
- id uuid PK default gen_random_uuid()
- user_id uuid not null FK → profiles(id)
- title text not null
- schedule jsonb not null
  - **monthly**: `{ "type":"monthly", "month":"YYYY-MM-01", "source":"monthly_goal", "category":"morning"|"night", "order":0, "active_from_date":"YYYY-MM-DD" }` (월간 데일리 루틴)
    - `active_from_date`: 루틴 적용 시작일 (YYYY-MM-DD). 새로 생성된 루틴에만 존재. 기존 루틴은 `created_at` 기준으로 판단
  - daily/weekly: 스키마는 정의되어 있으나 현재 미사용
- is_active boolean not null default true
- deleted_at timestamptz
- created_at timestamptz not null default now()
- updated_at timestamptz not null default now()
- 인덱스: (user_id, is_active), (user_id, is_active) WHERE deleted_at IS NULL
- **Soft Delete 정책**: 루틴 변경 시 `DELETE` 대신 `UPDATE is_active = false, deleted_at = NOW()` (과거 체크 기록 보존)
  - **날짜 기준 필터링**: `fetchRoutines`에서는 `is_active` 조건 없이 모든 루틴 조회, `isRoutineDue`에서 날짜 기준으로 필터링하여 선택 날짜에 해당하는 루틴만 표시

### routine_logs
- id uuid PK default gen_random_uuid()
- user_id uuid not null FK → profiles(id)
- routine_id uuid not null FK → routines(id)
- date date not null
- checked boolean not null default true
- created_at timestamptz not null default now()
- updated_at timestamptz not null default now()
- UNIQUE(user_id, routine_id, date)
- 인덱스: (user_id, date)

### daily_reflections
- id uuid PK default gen_random_uuid()
- user_id uuid not null FK → profiles(id)
- date date not null
- grateful text
- well_done text
- regret text
- tomorrow_promise text
- created_at timestamptz not null default now()
- updated_at timestamptz not null default now()
- UNIQUE(user_id, date)

### yearly_goals
- id uuid PK default gen_random_uuid()
- user_id uuid not null FK → profiles(id)
- year int not null
- self_dev text
- relationship text
- work_finance text
- created_at timestamptz not null default now()
- updated_at timestamptz not null default now()
- UNIQUE(user_id, year)

### monthly_plans
- id uuid PK default gen_random_uuid()
- user_id uuid not null FK → profiles(id)
- month_start date not null                 -- YYYY-MM-01
- linked_year int                            -- 연간목표 연결 (year 값만 저장)
- source text not null                      -- manual/ai_suggested
- status text not null default 'draft'      -- draft/accepted/archived
- content_md text not null default ''        -- 기존 마크다운 본문 (하위 호환성 유지)
- plan_content jsonb default '{"self_dev":"","relationship":"","work_finance":""}'  -- 월실천계획 (영역별) (구현됨)
- results_content jsonb default '{"self_dev":"","relationship":"","work_finance":""}'  -- 월말 결과 (영역별) (구현됨)
- daily_routines jsonb default '{"morning":[],"night":[]}'  -- 월간 데일리 루틴 (구현됨)
- model text                                 -- AI 생성 시 모델명 (AI 제안용)
- prompt_version text                        -- AI 생성 시 프롬프트 버전 (AI 제안용)
- created_at timestamptz not null default now()
- updated_at timestamptz not null default now()
- UNIQUE(user_id, month_start, source)
- 인덱스: (user_id, month_start), GIN(daily_routines), GIN(plan_content), GIN(results_content)

### weekly_ai_reflections
- id uuid PK default gen_random_uuid()
- user_id uuid not null FK → profiles(id)
- week_start date not null
- week_end date not null
- content_md text not null
- model text not null
- prompt_version text not null
- created_at timestamptz not null default now()
- updated_at timestamptz not null default now()
- UNIQUE(user_id, week_start)

### monthly_ai_reflections
- id uuid PK default gen_random_uuid()
- user_id uuid not null FK → profiles(id)
- month_start date not null
- content_md text not null
- model text not null
- prompt_version text not null
- created_at timestamptz not null default now()
- updated_at timestamptz not null default now()
- UNIQUE(user_id, month_start)

### ai_usage_counters (레이트리밋)
- id uuid PK default gen_random_uuid()
- user_id uuid not null FK → profiles(id)
- scope text not null                       -- weekly_reflection / monthly_reflection / monthly_plan
- period_key text not null                  -- 예: 2025-W49, 2025-12
- count int not null default 0
- created_at timestamptz not null default now()
- updated_at timestamptz not null default now()
- UNIQUE(user_id, scope, period_key)

---

# 11. RLS(필수) — 승인/사용자 격리 강제

## 11.1 공통 승인 체크 SQL(개념)
- approved 조건:
  - EXISTS(SELECT 1 FROM profiles p WHERE p.id = auth.uid() AND p.status='approved' AND (p.expires_at IS NULL OR p.expires_at >= CURRENT_DATE))
  - 함수: `public.is_user_approved()` 사용 권장

## 11.2 profiles 정책
- SELECT: 본인 1행만 허용
- UPDATE:
  - 본인: `timezone`, `name` 정도만 허용(선택)
  - `status`, `role` 변경: **admin만 허용**
- INSERT: auth 트리거로만 생성(클라이언트 직접 INSERT 금지)

## 11.3 사용자 데이터 테이블(todos/routines/logs/reflections/goals/plans/ai 결과)
- SELECT/INSERT/UPDATE/DELETE:
  - row.user_id = auth.uid()
  - AND approved 조건

---

# 12. Edge Function(필수) — AI 생성 API 계약
> AI 호출은 반드시 Edge Function에서 수행(비밀키 보호 + 원자적 저장).

## 12.1 공통 규칙
- 인증: Supabase JWT(Authorization Bearer) 필수
- 승인 체크: profiles.status=approved 아니면 403
- 레이트리밋: ai_usage_counters로 scope/period_key 카운트 증가(초과 시 429)
- 저장 원자성: “모델 호출 성공 → DB upsert 저장”을 단일 흐름으로 보장(부분 저장 금지)

## 12.2 Functions 목록(권장 이름)
1) `POST /functions/v1/ai-weekly-reflection` ✅ 구현 완료
- body: { "week_start":"YYYY-MM-DD" }  (필수)
- server:
  - week_end = week_start + 6일
  - 해당 기간 통계/텍스트 요약 생성(길이 제한: 총 6,000자 권장)
  - 모델 호출 (Gemini API, gemini-2.5-flash, maxOutputTokens: 8000)
  - weekly_ai_reflections upsert(user_id, week_start)
- response: { "content_md":"...", "week_start":"...", "week_end":"...", "model":"...", "prompt_version":"..." }
- 구현 상태: ✅ 배포 완료, Gemini API 연동, 토큰 제한 8000, 마크다운 저장, 레이트리밋 적용

2) `POST /functions/v1/ai-monthly-reflection` ✅ 구현 완료
- body: { "month_start":"YYYY-MM-01" }  (필수)
- server:
  - month_end = 해당 월의 마지막 날 계산 (28~31일)
  - 해당 기간 통계/텍스트 요약 생성(길이 제한: 총 1,500자 권장)
  - 모델 호출 (Gemini API, gemini-2.5-flash, maxOutputTokens: 8000)
  - monthly_ai_reflections upsert(user_id, month_start)
- response: { "content_md":"...", "month_start":"...", "model":"...", "prompt_version":"..." }
- 구현 상태: ✅ 배포 준비 완료, Gemini API 연동, 토큰 제한 8000, 마크다운 저장, 레이트리밋 적용 (월 2회)

3) `POST /functions/v1/ai-monthly-plan` ✅ 구현 완료
- body: { "month_start":"YYYY-MM-01", "linked_year": 2025 } (필수)
- server:
  - 연간목표(해당 year), 지난달 실천계획 및 결과, 최근 4주 활동 요약 수집
  - 모델 호출 (Gemini API, gemini-2.5-flash, maxOutputTokens: 8000)
  - JSON 형식 응답 파싱 및 plan_content JSONB 저장
  - monthly_plans upsert(user_id, month_start, source='ai_suggested') status='draft'
- response: { "plan_content": {...}, "month_start":"...", "model":"...", "prompt_version":"..." }
- 구현 상태: ✅ 배포 완료, Gemini API 연동, 토큰 제한 8000, JSON 저장, 레이트리밋 적용 (월 5회)

## 12.3 Prompt Versioning(필수)
- prompt_version 예: `weekly_reflection_v1`, `monthly_plan_v1`
- 문구 변경 시 버전 상승(데이터 재현성 확보)

---

# 13. 구현 가이드(개발 시 혼선 방지 규칙)
## 13.1 날짜 계산
- 클라이언트는 `profiles.timezone`을 읽은 후 화면 상 “today/week/month 키”를 계산
- 권장 라이브러리(가벼움): Luxon(타임존 지원)
- DB에는 date(YYYY-MM-DD)로 저장

## 13.2 조회 패턴(권장)
- todos(today): user_id=auth.uid AND date=today AND deleted_at IS NULL ORDER BY (정렬 규칙 고정)
- carry-over 대상: date < today AND is_done=false AND deleted_at IS NULL AND carried_over_at IS NULL AND skipped_at IS NULL
- routines(active): user_id=auth.uid AND is_active=true AND deleted_at IS NULL
- routine_logs(today): user_id=auth.uid AND date=today
- monthly_plans(current): user_id=auth.uid AND month_start=YYYY-MM-01

## 13.3 Realtime(선택)
- v1 기본: 새로고침 기반
- v1.1+: today 화면에 한해 todos/routine_logs/daily_reflections 구독

---

# 14. 테스트 체크리스트(릴리즈 게이트)
- [ ] 동일 계정 PC/모바일 로그인 후 동일 데이터 조회
- [ ] pending 사용자는 어떤 테이블도 CRUD 불가(콘솔 호출 포함)
- [ ] Admin 승인 후 사용자 즉시 이용 가능
- [ ] user A가 user B 데이터 조회/수정 불가(RLS)
- [ ] todos 정렬이 기기별 동일(동일 기준일/카테고리)
- [ ] carry-over 모달: 대상 있을 때만, 동일 기기 당일 1회, 이어가기 후 재노출 없음
- [ ] AI 생성 실패 시 DB 부분 저장 없음 + UI 실패 안내
- [ ] 타임존 경계(23:59~00:01)에서 today/week/month 기준 흔들림 없음

---

# 부록 A. Supabase SQL (스키마 + 트리거 + RLS) — 그대로 적용 가능한 기준안
> 실제 적용 시 Supabase 프로젝트의 SQL Editor에서 순서대로 실행합니다.

---

# 부록 B. UI 디자인 가이드 (Design System)
> 2025-12-07 구현 완료, 2025-12-08 업데이트, 2025-12-09 최종 업데이트

## B1) 디자인 원칙
- **일관성**: 모든 아이콘은 Lucide 아이콘 사용
- **접근성**: 색상 + 아이콘 + 텍스트로 3중 구분
- **반응형**: PC/모바일 동일한 경험
- **부드러움**: 파스텔 톤 + 그라데이션
- **레이아웃**: 중앙 정렬, 균등 분배

## B2) 색상 시스템

### 카테고리 색상
| 카테고리 | 메인 색상 | 그라데이션 | 배경 | 보더 | Lucide 아이콘 |
|---------|----------|-----------|------|------|---------------|
| Work | #fb923c | #fb923c → #f59e0b | #fff7e6 | #f5d38f | `briefcase` |
| Job | #22d3ee | #22d3ee → #06b6d4 | #e7f8ff | #b5e6ff | `clipboard-list` |
| Growth | #a78bfa | #a78bfa → #8b5cf6 | #f4e9ff | #d8c7ff | `book-open` |
| Personal | #f472b6 | #f472b6 → #ec4899 | #ffe9f0 | #f8c7d6 | `home` |

### 섹션별 색상 (구현됨)
| 섹션 | 배경 그라데이션 | 보더 | 아이콘 배경 | 아이콘 |
|---|---|---|---|---|
| 앱 헤더 | #f4f4f5 → #fafafa | #e5e7eb | - | `sparkles` |
| 오늘 루틴 | #e0f7f4 → #f0fdf4 | #14b8a6 | #14b8a6 → #10b981 | `target` |
| 오늘 할일 | #eef2ff → #f5f3ff | #6366f1 | #6366f1 → #8b5cf6 | `list-checks` |
| 월간 데일리 루틴 | #f0e7ff → #fce7f3 | #a78bfa | #a78bfa → #c084fc | `repeat` |
| 하루 성찰 | #f3e8ff → #fce7f3 | #a78bfa | #a78bfa → #c084fc | `pen-square` |

### 상태 색상
| 상태 | 색상 | 용도 |
|------|------|------|
| 이어감 | #10b981 (녹색) | "→ 오늘로 이동됨" 배지 |
| 포기 | #ef4444 (빨강) | "× 포기함" 배지 |
| 완료 | #6b7280 (회색) | 체크된 할일 |
| 모닝 | #f59e0b (주황) | 모닝루틴 아이콘 |
| 나이트 | #6366f1 (인디고) | 나이트루틴 아이콘 |

## B3) 타이포그래피
- **브랜드 이름**: 1.75rem, font-weight: 700, color: #6366f1
- **제목**: 1.5rem, font-weight: 700
- **카테고리**: 0.95rem, font-weight: 600
- **본문**: 1rem, font-weight: 500
- **보조**: 0.85rem, color: #6b7280

## B4) 컴포넌트

### 네비게이션 탭 (구현됨)
```css
위치: 앱 헤더 내부 (최상단 고정)
탭 개수: 4개 (오늘, 주간, 월간, 목표) + 관리자 탭 (관리자만 표시)
레이아웃: 중앙 정렬, 균등 분배 (flex: 1, max-width: 150px)
아이콘+텍스트: 한 줄 배치 (flex-direction: row)
아이콘 크기: 20px × 20px
간격: gap: 0.5rem
반응형: 모바일에서 2열 배치 (flex: 1 1 calc(50% - 0.5rem))
관리자 탭: shield-check 아이콘, 새 탭에서 /admin.html 열기 (target="_blank")
```

### 탭 (Tabs)
```css
기본 (비활성): 
  - 배경: #e5e7eb (회색)
  - 보더: 1px solid #d1d5db
  - 텍스트: #1f2937
  - border-radius: 8px
  
선택 (활성): 
  - 배경: 카테고리별 그라데이션
    * Work: linear-gradient(135deg, #fb923c 0%, #f59e0b 100%)
    * Job: linear-gradient(135deg, #22d3ee 0%, #06b6d4 100%)
    * Growth: linear-gradient(135deg, #a78bfa 0%, #8b5cf6 100%)
    * Personal: linear-gradient(135deg, #f472b6 0%, #ec4899 100%)
  - 보더: transparent
  - 텍스트: white
  - box-shadow: 0 2px 8px rgba(색상, 0.3)
  
호버 (비활성): 
  - 배경: #d1d5db
  - 보더: #9ca3af
  - transform: translateY(-1px)
```

### 카드 (Cards)
```css
배경: 카테고리별 파스텔 배경색 + 그라데이션
보더: 카테고리별 보더 색상 (2px solid)
그림자: 0 8px 24px rgba(색상, 0.15)
둥근 모서리: 12px
아이콘 배경: 그라데이션 박스 (40px × 40px, border-radius: 12px)
```

### 할일 카테고리 섹션 (구현됨)
```css
배경: 카테고리별 파스텔 배경색
  - Work: #fff7e6
  - Job: #e7f8ff
  - Growth: #f4e9ff
  - Personal: #ffe9f0
보더: 카테고리별 보더 색상 (2px solid)
  - Work: #f5d38f
  - Job: #b5e6ff
  - Growth: #d8c7ff
  - Personal: #f8c7d6
그림자: 0 8px 24px rgba(색상, 0.15)
  - Work: rgba(251, 146, 60, 0.15)
  - Job: rgba(34, 211, 238, 0.15)
  - Growth: rgba(167, 139, 250, 0.15)
  - Personal: rgba(244, 114, 182, 0.15)
둥근 모서리: 12px
padding: 12px
```

### 루틴 아이템 (구현됨)
```css
개별 아이템: 
  - 배경: white
  - border-radius: 8px
  - box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05)
  - padding: 0.5rem
  - margin-bottom: 0.5rem
리스트 컨테이너: 
  - 배경: transparent (메인 카드 그라데이션 노출)
  - padding: 0
```

### 배지 (Badges)
```css
이어감: 녹색 배경 + 흰색 텍스트 + arrow-right 아이콘
포기: 빨강 배경 + 흰색 텍스트 + x 아이콘
진행률: 흰색 배경 + 그림자 + 텍스트
크기: 0.75rem, padding: 0.15rem 0.5rem
둥근 모서리: 999px (완전 둥글게)
```

### 버튼 (Buttons)
```css
기본 버튼 (.btn):
  - padding: 0.625rem 1.25rem
  - font-size: 1rem
  - font-weight: 600
  - border-radius: 8px
  - transition: all 0.2s
  - 호버: transform: translateY(-1px), box-shadow 증가

Primary 버튼 (.btn-primary):
  - 배경: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%)
  - 색상: white

하루 성찰 작성 버튼:
  - 배경: linear-gradient(135deg, #a78bfa 0%, #c084fc 100%)
  - 색상: white
  - border-radius: 12px
  - box-shadow: 0 4px 12px rgba(167, 139, 250, 0.3)
  - 호버: transform: translateY(-2px), box-shadow: 0 6px 16px rgba(167, 139, 250, 0.4)
  - 아이콘: pen-square (20px × 20px)
```

### 하루 성찰 폼 (Daily Reflection Form)
```css
폼 카드:
  - 배경: linear-gradient(135deg, #f3e8ff 0%, #fce7f3 100%)
  - 보더: 2px solid #a78bfa
  - box-shadow: 0 8px 24px rgba(167, 139, 250, 0.15)
  - border-radius: 12px

제목:
  - 색상: #7c3aed
  - font-size: 1.5rem
  - font-weight: 700
  - 아이콘: heart (24px × 24px, 색상: #a78bfa)

입력 필드:
  - 보더: 2px solid #c084fc
  - 배경: white
  - border-radius: 8px
  - min-height: 100px

라벨 및 아이콘:
  - 라벨 색상: #7c3aed
  - 아이콘 색상: #a78bfa
  - 아이콘 크기: 18px × 18px

저장 버튼:
  - 배경: linear-gradient(135deg, #a78bfa 0%, #c084fc 100%)
  - 색상: white
  - box-shadow: 0 4px 12px rgba(167, 139, 250, 0.3)
```

### 로그인 화면 (Login Screen) ✅ 구현 완료
```css
로고 이미지:
  - 파일명: /logo.png
  - 크기: 데스크톱 max-width: 260%, 모바일 max-width: 240%
  - 위치: 화면 중앙
  - 레이아웃: flex 중앙 정렬

구글 로그인 버튼:
  - 위치: 로고 이미지 하단에 오버레이 (position: absolute, bottom: 2rem)
  - 크기: min-width: 216px, max-width: 288px (모바일: 180px~252px)
  - 배경: #374151 (짙은 회색)
  - 텍스트: white
  - 보더: 1px solid #4b5563
  - border-radius: 24px (모바일: 20px)
  - padding: 0.6rem 1.3rem (모바일: 0.525rem 1.125rem)
  - font-size: 1.2rem (모바일: 1.125rem)
  - box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2)
  - Google 아이콘: 20px × 20px SVG
  - 호버: 배경 #4b5563, transform: translateY(-2px)
  - 활성: 배경 #1f2937
  - 중앙 정렬: left: 50%, transform: translateX(-50%)
```

## B5) 아이콘 사용 규칙
- **라이브러리**: Lucide Icons만 사용
- **크기**: 
  - 기본: 18x18px
  - 네비게이션: 20px × 20px
  - 카드 헤더: 24px × 24px
  - 브랜드 아이콘: 28px × 28px
- **선 굵기**: stroke-width: 2.5
- **색상**: 상속 (별도 지정 없으면 텍스트 색상)

## B6) 레이아웃 (구현됨)
- **앱 헤더**:
  - 배경: 따뜻한 회색 그라데이션 (linear-gradient(135deg, #f4f4f5 0%, #fafafa 100%))
  - 보더: 1px solid #e5e7eb
  - border-radius: 12px
  - box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08)
  - max-width: 1200px
  - margin: 0 auto (가운데 정렬)
  - padding: 1.5rem
- **브랜드**:
  - 아이콘 크기: 28px × 28px
  - 텍스트 크기: 1.75rem
  - 색상: #6366f1 (primary color)
  - gap: 0.5rem
- **네비게이션 탭** (헤더 내부):
  - 탭 개수: 4개 (오늘, 주간, 월간, 목표) + 관리자 탭 (관리자만 표시)
  - 아이콘: sun (오늘), calendar-days (주간), calendar (월간), target (목표), shield-check (관리자)
  - 관리자 탭: 새 탭에서 /admin.html 열기
  - 레이아웃: 중앙 정렬 (justify-content: center)
  - 박스 형태: 배경 + 보더 + 둥근 모서리 (border-radius: 8px)
  - 비활성: 회색 배경 (#e5e7eb) + 회색 보더 (#d1d5db) + 검은색 텍스트 (#1f2937)
  - 활성: primary 그라데이션 (linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%)) + 흰색 텍스트 + box-shadow
  - 호버: 어두운 회색 (#d1d5db) + translateY(-1px)
  - 반응형: 모바일에서 2열 배치 (flex: 1 1 calc(50% - 0.5rem))
- **사용자 정보 박스** (헤더 오른쪽):
  - 사용자 이름 + 이메일 표시
  - 로그아웃 버튼
- **날짜 선택 버튼 (Chip)**:
  - border-radius: 999px (완전 둥근 형태)
  - 기본: 흰색 배경 + 회색 보더
  - 활성 (.primary): 단색 보라색 배경 (#6366f1) + 흰색 텍스트
  - 호버: 약간 어두운 배경 + translateY(-1px)
- **날짜 바 (Date Bar)**:
  - 레이아웃: 세로 배치 (flex-direction: column)
  - 날짜 선택 버튼 그룹: 가로 배치 (date-bar__main)
- **오늘로 이동 버튼** (구현됨):
  - 위치: 날짜 선택 버튼 아래 (날짜 바 내부)
  - 표시 조건: 오늘 날짜가 아닐 때만 표시
  - 크기: padding 0.375rem 0.875rem, font-size 0.875rem (날짜 선택 버튼보다 작게)
  - 색상: 배경 #e0e7ff (연한 인디고), 텍스트 검은색 (#1f2937)
  - 보더: 1px solid rgba(99, 102, 241, 0.2)
  - 호버: 배경 #c7d2fe, translateY(-1px)
  - 아이콘: sun (16px × 16px)
- **오늘 루틴**: 모닝/나이트 좌우 분리 (grid-template-columns: 1fr auto 1fr)
- **구분선**: 그라데이션 수직선 (width: 2px)
- **반응형**: 모바일에서 1열 배치, 구분선 숨김
- **섹션 헤더 레이아웃**:
  - 오늘 루틴: 왼쪽(아이콘 + 제목 + 토글 버튼) | 오른쪽(진행률 배지)
  - 오늘 할일: 왼쪽(아이콘 + 제목 + 토글 버튼) | 오른쪽(카테고리 탭)
- **토글 버튼**: 제목 바로 옆에 배치 (직관적 접근)
- **카테고리 탭**: 헤더 오른쪽에 배치 (진행률 배지와 유사한 위치)

---

# 부록 A. Supabase SQL (스키마 + 트리거 + RLS) — 그대로 적용 가능한 기준안
> 실제 적용 시 Supabase 프로젝트의 SQL Editor에서 순서대로 실행합니다.

## A1) 공통: updated_at 트리거
```sql
create or replace function public.set_updated_at()
returns trigger language plpgsql as $$
begin
  new.updated_at = now();
  return new;
end; $$;
