<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ë£¨í‹´ ë””ë²„ê·¸</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="config.js"></script>
  <style>
    body {
      font-family: system-ui, -apple-system, sans-serif;
      max-width: 1200px;
      margin: 2rem auto;
      padding: 0 1rem;
      background: #f8fafc;
    }
    h1 {
      color: #1e293b;
      margin-bottom: 1rem;
    }
    .controls {
      margin-bottom: 2rem;
      padding: 1rem;
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    button {
      padding: 0.75rem 1.5rem;
      background: #6366f1;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 1rem;
      margin-right: 0.5rem;
    }
    button:hover {
      background: #4f46e5;
    }
    #output {
      background: white;
      padding: 1.5rem;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      white-space: pre-wrap;
      font-family: 'Courier New', monospace;
      font-size: 0.875rem;
      line-height: 1.6;
      max-height: 600px;
      overflow-y: auto;
    }
    .routine-card {
      background: #f1f5f9;
      padding: 1rem;
      margin: 0.5rem 0;
      border-radius: 6px;
      border-left: 4px solid #6366f1;
    }
    .active {
      border-left-color: #10b981;
      background: #f0fdf4;
    }
    .inactive {
      border-left-color: #ef4444;
      background: #fef2f2;
    }
    .info {
      color: #64748b;
      font-size: 0.85rem;
    }
  </style>
</head>
<body>
  <h1>ğŸ” ë£¨í‹´ ë°ì´í„°ë² ì´ìŠ¤ ë””ë²„ê·¸</h1>
  
  <div class="controls">
    <button onclick="checkAllRoutines()">ëª¨ë“  ë£¨í‹´ ì¡°íšŒ</button>
    <button onclick="checkDecemberRoutines()">12ì›” ë£¨í‹´ë§Œ ì¡°íšŒ</button>
    <button onclick="checkRoutinesByDate('2025-12-26')">ì–´ì œ(12/26) ë£¨í‹´ í™•ì¸</button>
    <button onclick="checkRoutinesByDate('2025-12-27')">ì˜¤ëŠ˜(12/27) ë£¨í‹´ í™•ì¸</button>
  </div>
  
  <div id="output">ì—¬ê¸°ì— ê²°ê³¼ê°€ í‘œì‹œë©ë‹ˆë‹¤...</div>

  <script>
    let supabase;
    let currentUser;

    // Supabase ì´ˆê¸°í™”
    async function initSupabase() {
      const config = window.SUPABASE_CONFIG || {
        url: import.meta?.env?.VITE_SUPABASE_URL,
        anonKey: import.meta?.env?.VITE_SUPABASE_ANON_KEY
      };

      if (!config.url || !config.anonKey) {
        throw new Error('Supabase ì„¤ì •ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
      }

      supabase = window.supabase.createClient(config.url, config.anonKey);
      
      // í˜„ì¬ ì‚¬ìš©ì í™•ì¸
      const { data: { session } } = await supabase.auth.getSession();
      if (!session) {
        document.getElementById('output').innerHTML = 'âŒ ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤. index.htmlì—ì„œ ë¨¼ì € ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.';
        return false;
      }
      
      currentUser = session.user;
      document.getElementById('output').innerHTML = `âœ… ë¡œê·¸ì¸ë¨: ${currentUser.email}`;
      return true;
    }

    // ë‚ ì§œ ê¸°ì¤€ ë£¨í‹´ í•„í„°ë§ í•¨ìˆ˜
    function isRoutineDue(routine, selectedDate) {
      const schedule = typeof routine.schedule === 'string' 
        ? JSON.parse(routine.schedule)
        : routine.schedule;
      
      if (!schedule) return false;

      // ì ìš© ì‹œì‘ì¼ í™•ì¸
      let activeFromDate;
      if (schedule.active_from_date) {
        activeFromDate = schedule.active_from_date;
      } else if (routine.created_at) {
        activeFromDate = routine.created_at.substring(0, 10);
      } else {
        return false;
      }

      // ë¹„í™œì„±í™”ì¼ í™•ì¸
      let deletedAtDate = null;
      if (routine.deleted_at) {
        deletedAtDate = routine.deleted_at.substring(0, 10);
      }

      // ë‚ ì§œ ë²”ìœ„ ì²´í¬
      if (selectedDate < activeFromDate) {
        return false;
      }
      if (deletedAtDate && selectedDate >= deletedAtDate) {
        return false;
      }

      // íƒ€ì…ë³„ í•„í„°ë§
      if (schedule.type === 'monthly') {
        const monthStart = schedule.month;
        const currentMonth = selectedDate.substring(0, 7) + '-01';
        return monthStart === currentMonth;
      }
      
      return false;
    }

    // ëª¨ë“  ë£¨í‹´ ì¡°íšŒ
    async function checkAllRoutines() {
      if (!supabase && !await initSupabase()) return;

      const { data, error } = await supabase
        .from('routines')
        .select('*')
        .eq('user_id', currentUser.id)
        .eq('schedule->>type', 'monthly')
        .order('created_at', { ascending: false });

      if (error) {
        document.getElementById('output').innerHTML = `âŒ ì˜¤ë¥˜: ${error.message}`;
        return;
      }

      let html = `<h3>ğŸ“Š ì „ì²´ ë£¨í‹´: ${data.length}ê°œ</h3>\n`;
      
      if (data.length === 0) {
        html += '<p style="color: #ef4444;">âš ï¸ ë£¨í‹´ì´ í•˜ë‚˜ë„ ì—†ìŠµë‹ˆë‹¤!</p>';
      } else {
        data.forEach((routine, i) => {
          const schedule = typeof routine.schedule === 'string' 
            ? JSON.parse(routine.schedule) 
            : routine.schedule;
          
          const statusClass = routine.is_active ? 'active' : 'inactive';
          const statusEmoji = routine.is_active ? 'âœ…' : 'âŒ';
          
          html += `<div class="routine-card ${statusClass}">`;
          html += `<strong>#${i+1} ${statusEmoji} ${routine.title}</strong><br>`;
          html += `<div class="info">`;
          html += `ID: ${routine.id}<br>`;
          html += `ìƒíƒœ: ${routine.is_active ? 'í™œì„±' : 'ë¹„í™œì„±'}<br>`;
          html += `ì¹´í…Œê³ ë¦¬: ${schedule.category || 'N/A'}<br>`;
          html += `ì›”: ${schedule.month || 'N/A'}<br>`;
          html += `ì ìš© ì‹œì‘ì¼: ${schedule.active_from_date || 'N/A'}<br>`;
          html += `ìƒì„±ì¼: ${routine.created_at ? routine.created_at.substring(0, 19).replace('T', ' ') : 'N/A'}<br>`;
          html += `ë¹„í™œì„±í™”ì¼: ${routine.deleted_at ? routine.deleted_at.substring(0, 19).replace('T', ' ') : 'N/A'}<br>`;
          html += `</div></div>`;
        });
      }

      document.getElementById('output').innerHTML = html;
    }

    // 12ì›” ë£¨í‹´ë§Œ ì¡°íšŒ
    async function checkDecemberRoutines() {
      if (!supabase && !await initSupabase()) return;

      const { data, error } = await supabase
        .from('routines')
        .select('*')
        .eq('user_id', currentUser.id)
        .eq('schedule->>type', 'monthly')
        .eq('schedule->>month', '2025-12-01')
        .order('created_at', { ascending: false });

      if (error) {
        document.getElementById('output').innerHTML = `âŒ ì˜¤ë¥˜: ${error.message}`;
        return;
      }

      let html = `<h3>ğŸ“… 12ì›” ë£¨í‹´: ${data.length}ê°œ</h3>\n`;
      
      if (data.length === 0) {
        html += '<p style="color: #ef4444;">âš ï¸ 12ì›” ë£¨í‹´ì´ ì—†ìŠµë‹ˆë‹¤!</p>';
      } else {
        const activeRoutines = data.filter(r => r.is_active);
        const inactiveRoutines = data.filter(r => !r.is_active);
        
        html += `<p><strong>í™œì„±:</strong> ${activeRoutines.length}ê°œ | <strong>ë¹„í™œì„±:</strong> ${inactiveRoutines.length}ê°œ</p>\n`;
        
        data.forEach((routine, i) => {
          const schedule = typeof routine.schedule === 'string' 
            ? JSON.parse(routine.schedule) 
            : routine.schedule;
          
          const statusClass = routine.is_active ? 'active' : 'inactive';
          const statusEmoji = routine.is_active ? 'âœ…' : 'âŒ';
          
          html += `<div class="routine-card ${statusClass}">`;
          html += `<strong>#${i+1} ${statusEmoji} ${routine.title}</strong><br>`;
          html += `<div class="info">`;
          html += `ID: ${routine.id}<br>`;
          html += `ìƒíƒœ: ${routine.is_active ? 'í™œì„±' : 'ë¹„í™œì„±'}<br>`;
          html += `ì¹´í…Œê³ ë¦¬: ${schedule.category || 'N/A'}<br>`;
          html += `ì ìš© ì‹œì‘ì¼: ${schedule.active_from_date || 'N/A'}<br>`;
          html += `ìƒì„±ì¼: ${routine.created_at ? routine.created_at.substring(0, 19).replace('T', ' ') : 'N/A'}<br>`;
          html += `ë¹„í™œì„±í™”ì¼: ${routine.deleted_at ? routine.deleted_at.substring(0, 19).replace('T', ' ') : 'N/A'}<br>`;
          html += `</div></div>`;
        });
      }

      document.getElementById('output').innerHTML = html;
    }

    // íŠ¹ì • ë‚ ì§œ ê¸°ì¤€ ë£¨í‹´ í™•ì¸
    async function checkRoutinesByDate(selectedDate) {
      if (!supabase && !await initSupabase()) return;

      const { data, error } = await supabase
        .from('routines')
        .select('*')
        .eq('user_id', currentUser.id)
        .eq('schedule->>type', 'monthly')
        .eq('schedule->>month', '2025-12-01')
        .order('created_at', { ascending: false });

      if (error) {
        document.getElementById('output').innerHTML = `âŒ ì˜¤ë¥˜: ${error.message}`;
        return;
      }

      const filteredRoutines = data.filter(r => isRoutineDue(r, selectedDate));

      let html = `<h3>ğŸ“… ${selectedDate} ê¸°ì¤€ ë£¨í‹´</h3>\n`;
      html += `<p><strong>ì „ì²´ 12ì›” ë£¨í‹´:</strong> ${data.length}ê°œ | <strong>${selectedDate}ì— í‘œì‹œë˜ì–´ì•¼ í•  ë£¨í‹´:</strong> ${filteredRoutines.length}ê°œ</p>\n`;
      
      if (filteredRoutines.length === 0) {
        html += '<p style="color: #ef4444;">âš ï¸ ì´ ë‚ ì§œì— í‘œì‹œë  ë£¨í‹´ì´ ì—†ìŠµë‹ˆë‹¤!</p>';
        
        html += '<h4>ğŸ” ëª¨ë“  12ì›” ë£¨í‹´ ë¶„ì„:</h4>';
        data.forEach((routine, i) => {
          const schedule = typeof routine.schedule === 'string' 
            ? JSON.parse(routine.schedule) 
            : routine.schedule;
          
          const activeFromDate = schedule.active_from_date || (routine.created_at ? routine.created_at.substring(0, 10) : 'N/A');
          const deletedAtDate = routine.deleted_at ? routine.deleted_at.substring(0, 10) : null;
          
          let reason = '';
          if (selectedDate < activeFromDate) {
            reason = `âŒ ì ìš© ì‹œì‘ ì „ (${selectedDate} < ${activeFromDate})`;
          } else if (deletedAtDate && selectedDate >= deletedAtDate) {
            reason = `âŒ ì´ë¯¸ ë¹„í™œì„±í™”ë¨ (${selectedDate} >= ${deletedAtDate})`;
          } else {
            reason = 'âœ… ì¡°ê±´ ë§Œì¡± (í‘œì‹œë˜ì–´ì•¼ í•¨)';
          }
          
          html += `<div class="routine-card">`;
          html += `<strong>#${i+1} ${routine.title}</strong><br>`;
          html += `<div class="info">`;
          html += `${reason}<br>`;
          html += `ì ìš© ì‹œì‘ì¼: ${activeFromDate}<br>`;
          html += `ë¹„í™œì„±í™”ì¼: ${deletedAtDate || 'N/A'}<br>`;
          html += `</div></div>`;
        });
      } else {
        filteredRoutines.forEach((routine, i) => {
          const schedule = typeof routine.schedule === 'string' 
            ? JSON.parse(routine.schedule) 
            : routine.schedule;
          
          html += `<div class="routine-card active">`;
          html += `<strong>#${i+1} âœ… ${routine.title}</strong><br>`;
          html += `<div class="info">`;
          html += `ì¹´í…Œê³ ë¦¬: ${schedule.category || 'N/A'}<br>`;
          html += `ì ìš© ì‹œì‘ì¼: ${schedule.active_from_date || 'N/A'}<br>`;
          html += `ë¹„í™œì„±í™”ì¼: ${routine.deleted_at ? routine.deleted_at.substring(0, 10) : 'N/A'}<br>`;
          html += `</div></div>`;
        });
      }

      document.getElementById('output').innerHTML = html;
    }

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ìë™ ì´ˆê¸°í™”
    window.addEventListener('DOMContentLoaded', initSupabase);
  </script>
</body>
</html>

